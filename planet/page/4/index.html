<!DOCTYPE html>
<html lang="en" dir="ltr" style="--color--primary-hue:202;--color--primary-saturation:79%;--color--primary-lightness:50">
  <head>
    <meta charset="utf-8" />
<meta name="Generator" content="Drupal 10 (https://www.drupal.org)" />
<meta name="MobileOptimized" content="width" />
<meta name="HandheldFriendly" content="true" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="icon" href="/themes/custom/joachim_blog_theme/favicon.ico" type="image/vnd.microsoft.icon" />
<link rel="alternate" type="application/rss+xml" title="Joachim&amp;#039;s blog" href="https://joachim-n.github.io//planet/feed" />

    <title>Drupal Planet Posts | Joachim&#039;s blog</title>
    <link rel="stylesheet" media="all" href="/sites/default/files/css/css_ihN9gV-WXsqs_8HEEt45YyjirGu6jPu5ot_R6_FnoJc.css?delta=0&amp;language=en&amp;theme=joachim_blog_theme&amp;include=eJxtiksOgCAQxS4EciTD54no4Bhn1HB7jQtXbJqmaeSEqZDicPFXs7CPc6ljIM6jzqhwE5B6PRMHT1a0Udly79j5xoFkQ7NvjWvvUZ_FSBNFdcELzFVwi_s4VE4n4QEvZUJF" />
<link rel="stylesheet" media="all" href="/sites/default/files/css/css_1jXAH4oZpERf974X1bp6_kLxFzUh9NogUun0JLEBbNE.css?delta=1&amp;language=en&amp;theme=joachim_blog_theme&amp;include=eJxtiksOgCAQxS4EciTD54no4Bhn1HB7jQtXbJqmaeSEqZDicPFXs7CPc6ljIM6jzqhwE5B6PRMHT1a0Udly79j5xoFkQ7NvjWvvUZ_FSBNFdcELzFVwi_s4VE4n4QEvZUJF" />

    
    
<link rel="preload" href="/themes/custom/joachim_blog_theme/fonts/metropolis/Metropolis-Regular.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/themes/custom/joachim_blog_theme/fonts/metropolis/Metropolis-SemiBold.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/themes/custom/joachim_blog_theme/fonts/metropolis/Metropolis-Bold.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/themes/custom/joachim_blog_theme/fonts/lora/lora-v14-latin-regular.woff2" as="font" type="font/woff2" crossorigin>
    <noscript><link rel="stylesheet" href="/themes/custom/joachim_blog_theme/css/components/navigation/nav-primary-no-js.css?sxcib3" />
</noscript>
  </head>
  <body class="path-planet">
        <a href="#main-content" class="visually-hidden focusable skip-link">
      Skip to main content
    </a>
    
      <div class="dialog-off-canvas-main-canvas" data-off-canvas-main-canvas>
    
<div id="page-wrapper" class="page-wrapper">
  <div id="page">

          <header id="header" class="site-header" data-drupal-selector="site-header" role="banner">

                <div class="site-header__fixable" data-drupal-selector="site-header-fixable">
          <div class="site-header__initial">
            <button class="sticky-header-toggle" data-drupal-selector="sticky-header-toggle" role="switch" aria-controls="site-header__inner" aria-label="Sticky header" aria-checked="false">
              <span class="sticky-header-toggle__icon">
                <span></span>
                <span></span>
                <span></span>
              </span>
            </button>
          </div>

                    <div id="site-header__inner" class="site-header__inner" data-drupal-selector="site-header-inner">
            <div class="container site-header__inner__container">

              


<div id="block-joachim-blog-theme-site-branding" class="site-branding block block-system block-system-branding-block">
  
    
    <div class="site-branding__inner">
              <div class="site-branding__text">
        <div class="site-branding__name">
          <a href="https://joachim-n.github.io//" title="Home" rel="home">Joachim&#039;s blog</a>
        </div>
      </div>
      </div>
</div>
<nav  id="block-joachim-blog-theme-main-menu" class="primary-nav block block-menu navigation menu--main" aria-labelledby="block-joachim-blog-theme-main-menu-menu" role="navigation">
            
  <h2 class="visually-hidden block__title" id="block-joachim-blog-theme-main-menu-menu">Main navigation</h2>
  
        
          <ul  class="menu menu--level-1">
            
                          
        
        
        <li class="menu__item menu__item--link menu__item--level-1">
                    
          <a href="https://joachim-n.github.io//" class="menu__link menu__link--link menu__link--level-1" data-drupal-link-system-path="&lt;front&gt;">Home</a>

          
        </li>
      
                          
        
        
        <li class="menu__item menu__item--link menu__item--level-1">
                    
          <a href="https://joachim-n.github.io//about" class="menu__link menu__link--link menu__link--level-1" data-drupal-link-system-path="node/1">About</a>

          
        </li>
          </ul>
  


  </nav>

<div class="header-nav-overlay" data-drupal-selector="header-nav-overlay"></div>


                          </div>
          </div>
        </div>
      </header>
    
    <div id="main-wrapper" class="layout-main-wrapper layout-container">
      <div id="main" class="layout-main">
        <div class="main-content">
          <a id="main-content" tabindex="-1"></a>
          
          <div class="main-content__container container">
            

  <div class="region region--highlighted grid-full layout--pass--content-medium">
    <div data-drupal-messages-fallback class="hidden messages-list"></div>

  </div>

            

  <div class="region region--breadcrumb grid-full layout--pass--content-medium">
    

<div id="block-joachim-blog-theme-breadcrumbs" class="block block-system block-system-breadcrumb-block">
  
    
      <div class="block__content">
        <nav class="breadcrumb" role="navigation" aria-labelledby="system-breadcrumb">
    <h2 id="system-breadcrumb" class="visually-hidden">Breadcrumb</h2>
    <div class="breadcrumb__content">
      <ol class="breadcrumb__list">
                  <li class="breadcrumb__item">
                          <a href="https://joachim-n.github.io//" class="breadcrumb__link">Home</a>
                      </li>
              </ol>
    </div>
  </nav>

    </div>
  </div>

  </div>


                          <main role="main">
                

  <div class="region region--content-above grid-full layout--pass--content-medium">
    

<div id="block-joachim-blog-theme-page-title" class="block block-core block-page-title-block">
  
  

  <h1 class="title page-title">Drupal Planet Posts</h1>


  
</div>

  </div>

                

  <div class="region region--content grid-full layout--pass--content-medium" id="content">
    

<div id="block-joachim-blog-theme-content" class="block block-system block-system-main-block">
  
    
      <div class="block__content">
      <div class="views-element-container"><div class="view view-planet view-id-planet view-display-id-page_1 js-view-dom-id-a98290cd9a7ea329de3344c9e7b4a8b5cff444ea228cc83ab7f8904049ac65fc">
  
    
      
      <div class="view-content">
          <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="https://joachim-n.github.io//blog/using-human-queue-worker-process-comments" rel="bookmark">
<span>Using Human Queue Worker to process comments</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Sat, 08/09/2014 - 09:44
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>Some time ago, I released <a href="https://www.drupal.org/project/human_queue_worker">Human Queue Worker</a>, a module that takes the concept of the Drupal Queue system, but where the processing of the items is done by human users rather than an automated process. I say 'takes the concept'; it in fact uses the Drupal Queue to create and claim queue items, but instead of declaring your queue with <a href="http://api.drupal.org/api/function/hook_cron_queue_info/7">hook_cron_queue_info()</a>, you declare it to Human Queue Worker as a queue that humans will be working on.</p>
<p>This was written for my current project and for a fairly specific need, and I didn't imagine many sites would be using it. However, it has an obvious and popular application: approving comments. I always figured it would be nice if someone wrote a little module to define a comment processing human queue.</p>
<p>Well, that someone is me, and the time is now. You see, I'm an idiot: when I set up this new blog site of mine, I totally forgot to set up a CAPTCHA, and then when I added Mollon, I didn't set it up properly. So this site has a few hundred spammy comments that I need to delete.</p>
<p>The problem is that comment management takes time. Unless there are some magical area of the core UI I've completely missed, I can either visit each node and delete them one by one, or use the comment admin form. There, I can mass-delete the ones with obvious spammy titles, but all the others will still need individual inspection.</p>
<p>The Human Queue UI simplifies this hugely. There's just one page for the queue. When you go to that page, you're presented with an item to process. In the case of comment approval, that's the comment itself, plus the parent node and parent comment to give you some context. To process the comment, click one of two buttons: 'Publish' or 'Delete'. The comment is dealt with, and the form reloads, with a brand new comment for you to process. Which means that the only clicking you do is the action buttons: Publish; Delete; Publish; Delete. (Though with the amount of spam on my site, it's probably Delete; Delete; Delete, like the Cybermen.)</p>
<p>I've not timed it, but I reckon I can probably go at quite a rate. And that's with just one of me: the core Queue system guarantees that only one worker can claim an item at any one time, and that applies to human workers too. So if another user were to work the queue too, by going to the same page, they would be getting shown different comments to work on, and we'd work through the comments at twice the rate.</p>
<p>Now I just need to find a compliant friend and make them into my worker drone. If you're interested, please don't post a comment!</p>
</div>
      
  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="https://joachim-n.github.io//blog/ripple-effect" rel="bookmark">
<span>The ripple effect</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Fri, 07/11/2014 - 19:21
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>Hello! I'm back. I've not made any blog posts in over a year and a half due to the site where my blog was before, drupaler.co.uk, closing down. And while it took me some time to get round to writing a Migrate script to import my posts from the old site's database, it was actually getting round to setting up this new domain that took the longest.</p>
<p>So what have I been doing all this time? Especially as I still don't have a single Drupal 7 site out there to my name? Well, these days I work on a humongous web application which has kept me busy for the last 18 months; it's a large Drupal site (we hit a million of one of its several custom entity types recently), but to the general public it's just a login page. I may talk more about the development challenges in future posts. </p>
<p>Prior to that, I was building what would have been one of the earliest big Drupal Commerce sites to launch... except that very shortly before launch in October 2012, the whole project got canned.</p>
<p>That was obviously rather demoralizing, as it had been a year in the building. However, it's interesting to look back and see just how much a large-scale project can contribute back to the Drupal community. The following is a list of the contrib modules that were created as part of the development of the project. Many of them are pretty simple; many of them don't get that much use. But they get some, and so it's interesting to see how much code a project can share if development is steered towards reusability, and also how a single project, even one that never sees the light of day, can have effects that ripple out and benefit many others. </p>
<h2><a href="https://www.drupal.org/project/reference_option_limit">Reference field option limit</a></h2>
<p>This was built to improve the UI for selecting terms from large taxonomies, where one vocabulary groups another. For example, you could have a huge vocabulary of cities, and a smaller one of cities. Each city term has a term reference to the country it belongs to (the glee of the early days of Drupal 7: all the fields on all the things!), and the entity that you want to tag (in my case a product) has term reference fields to both the country and the city. The way this module works is that the city terms shown in one widget are filtered each time you change the selected country term in the other field's widget. So you select 'France' and the city field widget updates with AJAX to show only cities in France.</p>
<p>It sounds simple to explain (I hope!), but involves a fair amount of work under the hood in the form alteration to pull it off. It's one of my most popular modules, and has received a fair number of patches from other users.</p>
<h2><a href="https://www.drupal.org/project/devel_contrib">Devel Contrib</a> and <a href="https://www.drupal.org/project/field_tools">Field Tools</a></h2>
<p>These two are developer modules. Devel Contrib arose from my constantly needing to dsm() the data from info hooks such as hook_views_data() and hook_entity_property_info(). When the thing you're developing keeps going wrong, one of first things to do is poke around to check you've properly declared everything to the APIs you're using. I started out just having this as a couple of menu items declared in a custom module, but pretty soon I added more, and I wanted it on other development sites, so the obvious thing to do was clean it up and release it. </p>
<p>Field Tools was something I wrote because the Commerce site in question had dozens of different product types and corresponding node types, with lots of common fields, and I really didn't want to spend hours clicking through the field admin UI to set them up. This may seem like a case of <a href="http://xkcd.com/974/">condiment-passing</a>, but I'm sure it's saved me hours of tedium: create the fields once, and then quickly clone them to any other entity types and bundles.</p>
<h2><a href="https://www.drupal.org/project/field_instance_cardinality">Field Instance Cardinality</a></h2>
<p>A very small tweak module, this lets you override a particular instance of a multi-valued field and set it to be single-valued only. It's a hook_form_alter() hack made reusable by adding some field admin settings, and a good example of how site customization can often be done as modules rather than alter hacks.</p>
<h2><a href="https://www.drupal.org/project/field_formatter_value_link">Field Value Link Formatter</a></h2>
<p>Very simple module: your taxonomy term fields (or other entity references) should link to a view with an entity ID argument. I guess the more traditional way of doing this is with a lot of path aliases for your taxonomy terms. I think we may also have used this to create Profile-style lists of related entities.</p>
<h2><a href="https://www.drupal.org/project/commerce_shipping_weight_tariff">Commerce Shipping Weight Tariff</a></h2>
<p>This was created to deal with the complex business rules we had for shipping costs. Written very near to our planned launch date, it's an example of what I call the 'skimp on the admin UI' contrib module: hardcode the settings, but do so in a way that's cleanly separated from the rest of the module, so that later on an admin UI can be added, perhaps contributed as a patch. Though I think that's yet to materialize for this one.</p>
<h2><a href="https://www.drupal.org/project/views_grouped_table">Views Grouped Table</a></h2>
<p>This was created to help keep track of how the product entities and product display nodes all related to one another.</p>
<h2><a href="https://www.drupal.org/project/views_dependent_filters">Views Dependent Filters</a></h2>
<p>Allows the presence of exposed filters on a view to be controlled by values in another exposed filter. This was intended to handle filtering Views of products, though we later switched to using Views with Solr.</p>
<h2><a href="http://drupal.org/project/taxonomy_add_previous">Taxonomy add previous</a></h2>
<p>A little bit of UX sugar for when you're adding lots of taxonomy terms that are very similar. In our case, this was terms representing sizes. On creating a new term, this takes you straight back to the form for adding another term, and prefills the field values from the one you just added.</p>
<h2><a href="https://www.drupal.org/project/flag_expire">Flag Expire</a></h2>
<p>Allows flags to have either an expiry date, or an expiry period. This was going to be used to feature products, or mark them as new, or discounted. (For new product, you could just automatically mark all products that were created in the last x days, say. But as I recall, the client didn't want ALL new products marked, just selected ones. The way clients do.)</p>
<p>As well as new contrib modules, the project resulted in work on existing contrib modules, in particular Flag, Data, Views Hacks, and Commerce Delivery.</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/52" hreflang="en">contributing code</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/41" hreflang="en">drupal commerce</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/3" hreflang="en">development</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/53" hreflang="en">maintaining projects</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="https://joachim-n.github.io//blog/corralling-permissions-grid" rel="bookmark">
<span>Corralling permissions into a grid</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Sun, 10/28/2012 - 09:55
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>I've just released <a href="http://drupal.org/project/permission_grid">Permissions Grid</a>. It does what the name suggests: it presents related permissions in a grid, rather than the usual long list.</p>
<p>How are permissions structured into a grid? Well, only the ones that form natural groups are included: every set of permissions of the form 'create foo, edit foo, delete foo, create bar, edit bar, delete bar' is turned into a matrix of checkboxes with the <i>verbs</i> 'create, edit, delete' along the top, and the <i>objects</i> 'foo, bar' along the top. When modules such as node, taxonomy, and commerce define related permissions for nodes, vocabularies, and products respectively, that gives you something like this:</p>
<p><img src="sites/default/files/article/image/joachim-permission-grid-module.png"></p>
<p>This gives an easy to grasp overview of what a role can do with different objects on the site: which node types can this role create? which can they edit, or delete? which product types can they edit? which vocabularies can they create terms in? </p>
<p>If this sounds and looks vaguely familiar, that's probably because this module has an ancestor: my Drupal 6 module <a href="http://drupal.org/project/node_permissions_grid">node permissions grid module</a>, which I wrote back when a site's content types started to become too numerous to easily make sense of. That operated only on node types, and like a great many contrib modules porting to Drupal 7, it's had to 'drop the node' and generalize. But in fact nothing restricts Permissions Grid to entities: all it cares about is permissions.</p>
<p>Structured permissions are declared to the module in <a href="http://drupalcode.org/project/permission_grid.git/blob/refs/heads/7.x-1.x:/permission_grid.api.php">an info hook</a>, and each module may declare multiple sets of permissions. This allows for the fact that some modules add further vocabulary-related permissions which do not have the same pattern, and that commerce has entity permissions in both singular and plural form.</p>
<p>Are there any groups of permissions I've missed, whether in core or contrib? Post a feature request, or better still, take a look at the <a href="http://drupalcode.org/project/permission_grid.git/blob/refs/heads/7.x-1.x:/permission_grid.permissions.inc">hook implementations already there</a> and file a patch.</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/6" hreflang="en">drupal planet</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/51" hreflang="en">permissions</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/1" hreflang="en">drupal</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/41" hreflang="en">drupal commerce</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="https://joachim-n.github.io//blog/rules-versus-hooks-or-abstraction-shock" rel="bookmark">
<span>On rules versus hooks, or, abstraction shock</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Fri, 09/21/2012 - 19:47
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>I need to add a bit of business logic to my Commerce site: a boolean field on product nodes marks that the corresponding products can't be delivered outside the UK.</p>
<p>And I know the way to do this in Commerce is to create a rule: react to the cart completing checkout, iterate over line items, check the corresponding products, and block the completion if the field in question is set.</p>
<p>Rules is great: with Rules, site builders can change site functionality and cause it to react to events. When non-techy people ask if my job involves designing websites, to put them right I say, 'I make websites go "bing!"'; and now, site builders can make them go 'bing!' too.</p>
<p>But I have a confession: I'm reluctant about using Rules. It's partly that I find the UI confusing, and it feels time-consuming to test them, but deeper than that I think it's just that I feel too far removed from the actual thing I'm trying to make.</p>
<p>And that makes me wonder: am I becoming a Drupal dinosaur?</p>
<p>Because I can imagine when Views first came along, developers who were used to writing their own query and formatting the result themselves, looking at the Views UI and thinking 'I don't feel in control of my lists of stuff any more'.</p>
<p>Or before CCK, developers wrote exactly the form elements they needed in the node form and saved it themselves in the database. I still sometimes speak to non-Drupal developers who want to be able to dump data into the node table directly (or pull it out) and when I tell them they can't, because the data that actually makes a node is spread out over the node table, the node_revision table, and then a multitude of field tables. And their feeling of disconnection at not being able to get their hands on 'the node' as a solid lump of database stuff must surely be akin to what I feel with Rules. And I'm going to call this feeling 'abstraction shock'.</p>
<p>I want to write a hook. I want to write the code for it, for it to feel like a solid thing. I know that my rule can (indeed, should) be exported to code, but I want code that I can read and see exactly what it says, rather than code that Rules will consume and understand. And most of all, I want to be able to put in debug statements to understand what I'm getting as I write it, and after I've written it when it's going wrong or when the site functionality has to change. </p>
<p>If that makes me a dinosaur, save me a seat next to the brontosaurus.</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/50" hreflang="en">rules</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/6" hreflang="en">drupal planet</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/41" hreflang="en">drupal commerce</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="https://joachim-n.github.io//blog/git-tricks-repatching-issue-branch" rel="bookmark">
<span>Git tricks: repatching for an issue branch</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Tue, 07/10/2012 - 19:20
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>My workflow for making patches is to use a feature branch for a single issue. Whether you're a contributor or a maintainer it lets you advance the fixing of the problem in small increments, and safely experiment knowing you can roll back.</p>
<p>But where it goes wrong is when your patch is superseded by a newer one in the issue queue, and you want to work on it some more. How do you update your branch for the ongoing work? As ever, with git there's a way.</p>
<p>Let's start with the basics first: you're making a feature branch to work on an issue. I tend to follow the naming pattern '123456-fix-all-the-bugs', but for this example I'll call it 'issue'.</p>
<div class="codeblock"><code>// Make a new branch and switch to it.<br>$ git co -b issue<br>// Make lots of commits.<br>// Ready to make a patch:<br>$ git diff &gt; 123456.project.issue.patch</code></div>
<p>(Note that if you can make your patch to show all your commits one by one, which can sometimes aid in making it clear what you're changing, but that's for another day.)</p>
<p>You've now got a patch which you're uploading to the issue queue, and your tree looks something like this:</p>
<div class="codeblock"><code> * [issue] Last commit, ready to roll a patch!<br> * Fixed the foobar.<br> * Added a bizbax.<br>/<br>* [master]</code></div>
<p>Now someone else comes along to the issue queue, reviews your patch, and posts a new patch of their own. You in turn look at patch 2, and while it's an improvement, you think it needs still more work.</p>
<p>The problem is how to apply the patch to your repository. It won't apply to the tip of the issue branch, and if you checkout master, you can't get back to your issue branch. You can of course just discard your original issue branch, and create a branch issue2 for patch 2.</p>
<p>Or you can do this:</p>
<div class="codeblock"><code>// Start on the issue branch.<br>// Stash any work in progress!<br>$ git stash<br>// Checkout just the *files* of master, while keeping the HEAD pointer on the<br>// issue branch.<br>$ git checkout master -- .<br>// This puts the files from master into the working tree, but keeps the index<br>// on the issue branch. In simpler terms, the reverse of patch 1 will appear<br>// staged (as git believes that your files *ought* to look like patch 1, but<br>// actually look like master). <br>// We want the index clean, so unstage everything:<br>$ git reset HEAD .<br>// Now apply the new patch.<br>$ patch -p1 &lt; patch-2.patch<br>// Now commit this as patch 2.<br>// Remember to stash pop when you're done!</code></div>
<p>Because the working tree files (that is, the actual files on your system) look like the master branch, the patch applies cleanly. But because git still believes its on the tip of the issue branch, the commit you make goes on the tip of that branch, and the diff it records is effectively the interdiff between your patch-1 and the other contributor's patch-2. Your tree looks like this:</p>
<div class="codeblock"><code> * [issue] Applied patch 2 from Ada Lovelace.<br> * Last commit, ready to roll a patch!<br> * Fixed the foobar.<br> * Added a bizbax.<br>/<br>* [master]</code></div>
<p>Result: you can now do more work on this branch, and make more commits, and when you're ready, diff against master to make patch-3, ready to upload to the issue queue.</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/6" hreflang="en">drupal planet</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/46" hreflang="en">git</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/48" hreflang="en">issue queue</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/49" hreflang="en">patching</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/1" hreflang="en">drupal</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="https://joachim-n.github.io//blog/git-tricks-being-wrong-branch" rel="bookmark">
<span>Git tricks: being on the wrong branch</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Fri, 07/06/2012 - 08:30
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>I often find that I'm in the middle of one thing when I have to do another. Whether it's hotfixes for a client, or just finding a minor bug that blocks my current work, or needing to add components to a feature before I can add custom functionality.</p>
<p>The best way is to stash your current work, checkout the master branch, commit, then go back. If you're working on a feature branch (and you should be), then rebase that afterwards so you have access to the new work there. So that's:</p>
<div class="codeblock"><code>$ git stash<br>$ git checkout master<br>// do commits<br>$ git checkout feature<br>$ git rebase master<br>$ git stash pop</code></div>
<p>But that's not always feasible. Sometimes I'm sloppy, and I've already made code changes before stashing. And lately, I've got one instance of <a href="http://drupal.org/project/party">Party module</a> that's got a feature branch that's made database changes, but I don't want to hold that up ongoing commits (and I'm too lazy to set up a new local site!).</p>
<p>If your fix is just one commit, you can make it on the feature branch, then cherrypick it to the master branch like this:</p>
<div class="codeblock"><code>// make your commit and note its SHA<br>$ git stash<br>$ git checkout master<br>$ git cherry-pick COMMIT<br>$ git checkout feature<br>$ git rebase master</code></div>
<p>The rebase should be smart enough to figure out the same commit exists on both branches, and will silently drop it from the feature branch.</p>
<p>Alternatively, if you want to do a chunk of main branch work, make a temporary branch on the tip of feature, which you can then move to the master branch when you're done:</p>
<div class="codeblock"><code>$ git checkout -b moveme<br>// make as many commits as you like<br>// Now we take everything that's between the tips of feature and moveme, and move it to the tip of master<br>$ git rebase --onto master feature moveme<br>// Now merge moveme into master: this'll just fast-foward master.<br>$ git checkout master<br>$ git merge moveme<br>// moveme can be deleted now<br>$ git branch -d moveme<br>// Now rebase the feature branch<br>$ git checkout feature<br>$ git rebase master</code></div>
<p>As I've become more familiar with git, I've found that temporary, throw-away branches can be useful in a variety of situations. Another one is making a backup branch prior to potentially messy rebases: just create a branch 'backup' where you are to be sure that no matter what happens with the rebase, your current chain of commits will be preserved. If there are conflicts, you can diff against it to check no code was lost. And when you're happy with the result of the rebase, just delete it. Branches being cheap, and local, opens up a whole new set of uses for them.</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/6" hreflang="en">drupal planet</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/46" hreflang="en">git</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="https://joachim-n.github.io//blog/get-out-git" rel="bookmark">
<span>Get out, git!</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Thu, 05/03/2012 - 07:41
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>There are lots of good reasons to have your server's codebase be an actual git checkout. But there's one potential flaw: your entire repository's history ends up in your webroot inside a .git folder.</p>
<p>You can block access to it in your .htaccess, but that's hacking core (until <a href="http://drupal.org/node/581706">this patch</a> lands at least).</p>
<p>There is however an alternative method that lets you keep the entirety of git's working folder outside the webroot completely.</p>
<p>Here's how to convert an existing repository to this format:</p>
<ol>
<li> Move the .git folder to another location, renaming it in the process so it's no longer hidden. The convention is to leave it with a .git ending though, so for example, 'mysite.git'. I put these inside a folder called 'git' in the user's home folder, for instance.<br>
<div class="codeblock"><code>$ mv .git ~/git/mysite.git</code></div>
</li>
<li>In its original place in your webroot, create a new file called '.git'. Into this file place a single line thus:<br>
<div class="codeblock"><code>gitdir: /absolute/path/to/your/mysite.git</code></div>
<p>This needs to be an absolute path; relative ones confuse git when you go into subfolders. Using '~' to start at the user's home folder doesn't seem to work either.</p>
</li>
<li> Finally, we need to tell the config file where the work folder is. This step isn't completely necessary, but it allows you to invoke the git command while standing in subfolders of your webroot, which is too handy a thing to lose.
<p>Standing either in the webroot or in the git folder, do:</p>
<div class="codeblock"><code>$ git config core.worktree "/absolute/path/to/your/webroot"</code></div>
<p>You can also edit the git config file by hand to set this, which allows you to also add a comment explaining the manoeuvre for future reference.
</p></li>
</ol>
<p>That's all there is to it. You now have a working git repository whose working folder is completely inaccessible from the outside world.</p>
<p>For creating a new repo, you can use the following finger-twister:</p>
<div class="codeblock"><code>$ git --git-dir=/path/to/repo.git --work-tree=. init &amp;&amp; echo "gitdir: /path/to/repo.git" &gt; .git</code></div>
<p>There are more tips in <a href="http://stackoverflow.com/questions/505467/can-i-store-the-git-folder-outside-the-files-i-want-tracked">this question on StackOverflow</a>. And for a hands-on tutorial, come to my session on git at <a href="http://camp.drupalscotland.org/">DrupalCamp Scotland</a>, taking place later this month in Edinburgh.</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/46" hreflang="en">git</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/6" hreflang="en">drupal planet</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/47" hreflang="en">security</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="https://joachim-n.github.io//blog/moving-git-local-branch-one-local-another" rel="bookmark">
<span>Moving a git local branch from one local to another</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Fri, 02/24/2012 - 10:32
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>You're maybe at one of the many Drupal Co-worker Friday events that are taking place around the world today. You've packed up your laptop and your lunchbox, and you're looking forward to a day out of the house with some human contact.</p>
<p>But yesterday you were halfway through a big piece of work on your project. And you were using a git local branch, of course. Why? Because it keeps your work isolated off the main development branch, allowing other work to continue independently. And because while your commits are only local you're free to reorder them, edit the log messages, fixup mistakes as if they never happened, and so on. In fact, if you so choose, merging your local branch in with the --squash option makes it look like you made all of the work in a single, perfect commit. Wow!</p>
<p>But that branch is on your desktop machine, and today you're on the laptop. How to get it over from one to the other? You don't want to push it to the remote, because then that means you can't rework it, and it doesn't really belong there anyway. You could make one big patch of your branch against the development branch, but then on your laptop you won't have the dozen or so commits you made yesterday (and you work with small, simple commits, because it makes it easier to roll back should you need to, and to see what's been changed). Furthermore, you've a bunch of changes that aren't yet committed because they're work in progress. You need those too, but not mixed in with what's already committed and reasonably stable.</p>
<p>The solution is the git format-patch command. At first try this is a rather weird one, which fills your folder up with cryptic mailbox files (which as far as I can tell are nigh on useless in the modern world of webmail). But it has an option which turns it into something very useful indeed: --stout. So much so that I've added it to my git global config thus:</p>
<div class="codeblock"><code>&nbsp; fp&nbsp; = format-patch --stdout</code></div>
<p>So standing in your repository and doing </p>
<div class="codeblock"><code>&nbsp; git fp the-dev-branch &gt; my-local-branch.patch</code></div>
<p>will give you one single file that comprises multiple patches, one for each commit. Copy that to your laptop by your favourite means, and over there do:</p>
<div class="codeblock"><code>&nbsp; git co -b my-local-branch<br>&nbsp; git am&nbsp; my-local-branch.patch</code></div>
<p>And all your commits from your desktop machine are reproduced on your laptop.</p>
<p>But what about your work in progress? I was coming to that. Before you begin, make one commit of all of them, perhaps with a log message to remind you it's the work in progress.</p>
<p>Then after you've done 'git am', all we have to do is kill off that final tip commit, while keeping the changes it contains in the filesystem. The command for that is git reset with the --mixed option:</p>
<div class="codeblock"><code>&nbsp; git reset --mixed HEAD^</code></div>
<p>All your work in progress changes are now 'unstaged changes', and your laptop's copy of the repository is in exactly the same stage as your desktop machine.</p>
<p>What about going back the other way? Well I'll figure that one out tonight, I expect ;)</p>
<p>PS. The return trip is easily done thus:</p>
<p>When you create the branch on the new machine, but before you apply the patch, add a tag: git tag mytag. Then at the end of the day, do the original process in reverse but take your diff from the tab: git fp mytag &gt; homeward.patch</p>
<p>And on your home machine, remember to kill the 'work in progress' commit before you apply the patch, with 'git reset --hard HEAD^'. That's a hard reset this time, since the changes in that commit are in the new commits you're bringing back.</p>
<p>Hope your Drupal Coworker Friday was as productive as mine!</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/1" hreflang="en">drupal</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/6" hreflang="en">drupal planet</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/46" hreflang="en">git</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="https://joachim-n.github.io//blog/concept-limiting-taxonomy-terms-common-fields" rel="bookmark">
<span>A concept for limiting taxonomy terms by common fields</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Wed, 11/23/2011 - 13:20
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>There are several modules that provide taxonomy term widgets that are more efficient at drilling down into large and complex vocabularies of terms, but I've not yet found something that just limits terms in some way.</p>
<p>The use case is somewhat like this: I have products that are classified by sport and by team. And teams can be rugby teams or football teams, and so on. Having one vocabulary per type of team feels somewhat weak, but putting them all in one vocabulary means the user has to wade through a lot of irrelevant terms.</p>
<p>So I've been thinking of ways to limit the terms in the field widget. I don't think this is something I'm going to develop (for reasons that will become clear), but it's just a wacky idea[*] I'm putting out there.</p>
<p>I've discarded my initial thought to use a hierarchy of terms, because that would result in terms that are essentially empty: the group of football team terms is not correctly a team term. It would also mean needing to prevent its selection in the widget, and its appearance in filter forms.</p>
<p>What I've landed on as a concept instead seems wacky but I think makes a lot of sense: now we can have fields on anything, we can <em>match them</em>. What I mean by this is that we compare the value in the 'sport' field on the product, and the value in the <em>identical sport field</em> applied to the terms. (Yes, taxonomy terms on taxonomy terms. It was bound to happen eventually, right?)</p>
<p>In terms of IA, this is actually quite simple and logical: add a term reference field to the team vocabulary, and add the sport field, which is already on products, to the team terms (which the client will be doing; I have no idea what teams belong to what sport).</p>
<p>In terms of the work the UI has to do, it's not that complex either once it's laid out. It goes like this: when the value in the sport field changes, make an ajax call on the team field. In the callback, load all the terms. For each term, look at its team value. Does that match the current value of the sport field in the product form? If so, let the term into the new options array. If not, discard it.</p>
<p>It's simple, but I've hit a problem: we have two really good JavaScript systems in Drupal 7 that work very well individually, but as far as I can tell live in completely different universes. The states system is great for telling one form element to show, hide, or change its value depending on the value of another element. The ajax system is great for telling one form element to react to a change in itself by updating something via ajax. What I don't see how to do is get the term reference widget element to watch for changes in other elements (like the states system does), and then update itself with ajax (using the ajax system ideally).</p>
<p>So that's where I've hit the buffers: my JavaScript skills are pretty minimal, and so that's where I leave this latest wacky idea for now. I've got proof-of-concept code of a term reference widget updating itself via ajax based on form values, but the missing piece is getting it to react to changes in another field, whose form elements can't be altered in PHP (because the term reference widget is being changed in hook_field_widget_form_alter(), which only sees that form element). I'd be grateful for any hints; I actually think this model is not as wacky as it first seems and could have a lot of applications.</p>
<p>[*] Back at DrupalCon London I chanced upon a conversation webchick and stella were having about Coder review automation on Drupal.org, and prefixed a suggestion with, 'I've got a wacky idea...', to which webchick said, 'When are your ideas not wacky?' I don't know whether it was just an off the cuff quip, or whether I really do come up with a lot of crazy stuff. I guess I can live with that reputation ;)</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/1" hreflang="en">drupal</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/6" hreflang="en">drupal planet</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/43" hreflang="en">taxonomy</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/44" hreflang="en">javascript</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/45" hreflang="en">ajax</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="https://joachim-n.github.io//blog/dynamically-changing-views-table-joins" rel="bookmark">
<span>Dynamically changing Views table joins</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Fri, 10/28/2011 - 08:52
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>I've recently had cause to make Views make joins to tables in peculiar ways. Here's some notes on the peculiar things I did with the views_join class to accomplish that.</p>
<p>First of all I'll briefly recap how we define a table to Views. Each item in the $data array returned to hook_view_data() represents all the information about a table. Each key in the array is a field on that table (well, or pseudofield), except for the 'table' key which has the basic data about our table, like this:</p>
<div class="codeblock"><code>$data['my_table'] = array(<br>&nbsp; // This defines how the table joins back to different bases.<br>&nbsp; 'table' =&gt; array(<br>&nbsp;&nbsp;&nbsp; // How to join back to the base table 'crm_party'.<br>&nbsp;&nbsp;&nbsp; 'crm_party' =&gt; array(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'left_field' =&gt; 'pid',<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'field' =&gt; 'pid',<br>&nbsp;&nbsp;&nbsp; ),<br>&nbsp; ),<br>);<br>// Now we can add field definitions on this table.</code></div>
<p>That's the simplest case. It says, 'to join back to {crm_party}, join on the column 'pid' on both tables'. (Note I will say 'column' when I am speaking of the database, and 'field' for Views, though that can mean both a field that you add to the view, and a field on the table that provides filters, sorts, or arguments.)</p>
<p>So adding a field on this table will cause Views to add this join clause to the query:</p>
<p> ... JOIN my_table ON crm_party.pid = my_table.pid</p>
<p>We can easily join where the columns have different names, by giving different values for 'field' and 'left_field' in the table definition.</p>
<p>If the join requires conditions, that's where the 'extra' clause comes in, like this:</p>
<div class="codeblock"><code>// How to join back to the base table 'crm_party'.<br>'crm_party' =&gt; array(<br>&nbsp; 'left_field' =&gt; 'pid',<br>&nbsp; 'field' =&gt; 'pid',<br>&nbsp; 'extra' =&gt; 'foo = 42',<br>),</code></div>
<p>This now gives us:</p>
<p>... JOIN my_table ON crm_party.pid = my_table.pid AND foo = 42</p>
<p>The 'extra' can also take an array, in which case each item is an array containing field, operator, and value. (If it seems a bit like the <a href="http://drupal.org/developing/api/database">Database API</a>, but not quite, that's because all this was introduced in Views 2 on Drupal 6).</p>
<div class="codeblock"><code>// How to join back to the base table 'crm_party'.<br>'crm_party' =&gt; array(<br>&nbsp; 'left_field' =&gt; 'pid',<br>&nbsp; 'field' =&gt; 'pid',<br>&nbsp; 'extra' =&gt; array(<br>&nbsp;&nbsp;&nbsp; // The 'extra' array is numeric, hence has no keys. This always looks odd to me!<br>&nbsp;&nbsp;&nbsp; array(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'field' =&gt; 'foo',<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'value' =&gt; 42,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'numeric' =&gt; TRUE,<br>&nbsp;&nbsp;&nbsp; ),<br>&nbsp; ),<br>),</code></div>
<p>So far, this is all covered in the Advanced Help documentation contained within Views. But for our relationship handler from <a href="http://drupal.org/sandbox/joachim/1260650">CRM Parties</a> to attached entities, we needed a condition on the join depending on values selected in the UI. So the 'extra', defined in hook_views_alter(), won't do, as it's not changeable. Or is it?</p>
<p>When a relationship handler is adding itself to the query, the query hasn't been fully built yet. Rather, Views has a views_plugin_query_default object which will eventually be used to make a DatabaseAPI SelectQuery. This means we can actually reach into the table queue and change the definition for any table to the left of us, like this:</p>
<div class="codeblock"><code>// Our relationship handler's query method:<br>function query() {<br>&nbsp; // Call our parent query method to set up all our tables and joins.<br>&nbsp; parent::query();<br><br>&nbsp; if ($this-&gt;options['main']) {<br>&nbsp;&nbsp;&nbsp; // This is a little weird.<br>&nbsp;&nbsp;&nbsp; // We don't add an 'extra' (ie a further join condition) on our<br>&nbsp;&nbsp;&nbsp; // relationship join, but rather on the join that got us here from<br>&nbsp;&nbsp;&nbsp; // the {crm_party} table.<br>&nbsp;&nbsp;&nbsp; // This means reaching into the query object's table queue and fiddling<br>&nbsp;&nbsp;&nbsp; // with the join object.<br>&nbsp;&nbsp;&nbsp; // Setting a join handler for the join definition is not useful, as that<br>&nbsp;&nbsp;&nbsp; // would have no knowledge of the user option set in this relationship<br>&nbsp;&nbsp;&nbsp; // handler.<br>&nbsp;&nbsp;&nbsp; // @todo: It might however be cleaner to set one anyway and give it<br>&nbsp;&nbsp;&nbsp; // a method to add the extra rather than hack the object directly...<br>&nbsp;&nbsp;&nbsp; $table = $this-&gt;table;<br>&nbsp;&nbsp;&nbsp; $base_join = $this-&gt;query-&gt;table_queue[$table]['join'];<br>&nbsp;&nbsp;&nbsp; $base_join-&gt;extra = array(array('field' =&gt; 'main', 'value' =&gt; TRUE));<br>&nbsp; }</code></div>
<p>When I wrote those comments in the code last week, I'd found that using a custom join handler isn't useful, because that has no knowledge of the relationship handler's data. However, this week I found myself working on a different case where I did need to find a way to do just that.</p>
<p>This week's problem was <a href="http://drupal.org/node/1318358">how to filter out Drupal Commerce products that are in the current cart</a>, or more generally in any order (and the current cart's order ID can be supplied with a default argument plugin).</p>
<p>It seems a reasonable enough thing to ask of Views, but it's actually pretty complex, as what's in a cart or order is not products but line items, each of which refers to a product with a reference field.</p>
<p>After several failed attempts, I managed to write a query that produces the correct result, but it requires joining to a subquery which itself has the order ID within it (see the issue for gory details).</p>
<p>The first hurdle with this is easy to overcome: there's nothing wrong about telling Views about a table that doesn't exist. This is often done with aliased tables, but in fact it can be totally fictional provided we also provide our own join handler which understands what to do to the query. That can be anything, as long as the SELECT fields we also add make sense. Hence it's fine to do this in hook_views_data():</p>
<div class="codeblock"><code>// Fake table for the 'product is in order' argument, made from a subquery.<br>$data['commerce_product_commerce_line_item'] = array(<br>&nbsp; 'table' =&gt; array(<br>&nbsp;&nbsp;&nbsp; 'group' =&gt; 'Commerce Product',<br>&nbsp;&nbsp;&nbsp; 'join' =&gt; array(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Join to the commerce_product base.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'commerce_product' =&gt; array(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'left_field' =&gt; 'entity_id',<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'field' =&gt; 'line_item_id',<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'handler' =&gt; 'views_join_commerce_product_line_item',<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ),<br>&nbsp;&nbsp;&nbsp; ),<br>&nbsp; ),<br>);</code></div>
<p>Our custom join class now has to add the subquery to the view, but it also needs the argument value to do this.</p>
<p>The way I worked around this was to override the ensure_my_table() method in the argument handler. Normally, this calls $this-&gt;query-&gt;ensure_table() which then creates the join, but ensure_table() can take a join parameter to work with. The overridden version of ensure_my_table() creates the join object, and sets the argument value on it:</p>
<div class="codeblock"><code>function ensure_my_table() {<br>&nbsp; // Pre-empt views_plugin_query_default::ensure_table() by setting our join up now.<br>&nbsp; // Argh, hack this in for now. This may mean relationships using this break?<br>&nbsp; $relationship = 'commerce_product';<br><br>&nbsp; // Get a join object for our table.<br>&nbsp; // This is of class views_join_commerce_product_line_item, which takes<br>&nbsp; // care of joining to a subquery rather than a table.<br>&nbsp; $join = $this-&gt;query-&gt;get_join_data($this-&gt;table, $this-&gt;query-&gt;relationships[$relationship]['base']);<br><br>&nbsp; // We add the argument value to the join handler as it needs to use it<br>&nbsp; // within its subquery.<br>&nbsp; $join-&gt;argument = $this-&gt;argument;</code></div>
<p>This means that in the build_join() method for our custom join handler, views_join_commerce_product_line_item, we can rely on the argument value that the views has received:</p>
<div class="codeblock"><code>function build_join($select_query, $table, $view_query) {<br>&nbsp; // (snip...) build a SelectQuery object for the subquery<br>&nbsp; // Set the condition based on the argument value.<br>&nbsp; $subquery-&gt;condition('cli.order_id', $this-&gt;argument);<br>&nbsp; // (snip...)<br>&nbsp; // Add the join on the subquery.<br>&nbsp; $select_query-&gt;addJoin($this-&gt;type, $subquery, $table['alias'], $condition);</code></div>
<p>The views_join class's build_join() method is where the Views system of building a query is translated into a DatabaseAPI SelectQuery object. Here we build up our own query (and we don't need Views-safe aliases, as it's a completely internal, non-correlated subquery), and pass it in as a join which uses it as a subquery.</p>
<p>It remains only for the argument handler's query() method to add the conditions for its field, using the alias and field names we gave for the subquery.</p>
<p>In conclusion, the data structure Views understands may appear to be a fixed, declared thing, but with a little bit of tweaking the way tables are joined in a Views query can be affected by both site configuration and user input.</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/1" hreflang="en">drupal</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/40" hreflang="en">views</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/41" hreflang="en">drupal commerce</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/42" hreflang="en">drupal crm</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/6" hreflang="en">drupal planet</a></li>
      </ul>
</div>

  </div>
  </article>
</div>

    </div>
  
        <nav class="pager layout--content-medium" role="navigation" aria-labelledby="pagination-heading">
    <h4 id="pagination-heading" class="visually-hidden">Pagination</h4>
    <ul class="pager__items js-pager__items">
                    <li class="pager__item pager__item--control pager__item--first"><a href="/planet" title="Go to first page" class="pager__link"><span class="visually-hidden">First page</span><svg xmlns="http://www.w3.org/2000/svg" width="15px" height="16px" viewBox="0 0 15 16"><path d="M5.1,7.2l8.3-6C14.1,0.7,15,1.1,15,2V14c0,0.8-0.9,1.3-1.6,0.8l-8.3-6C4.6,8.4,4.6,7.6,5.1,7.2z M0,0h2v16H0V0z"/></svg></a></li>      
                    <li class="pager__item pager__item--control pager__item--previous"><a href="/planet/page/3" title="Go to previous page" rel="prev" class="pager__link"><span class="visually-hidden">Previous page</span><svg xmlns="http://www.w3.org/2000/svg" width="11" height="16" viewBox="0 0 11 16"><path d="M1.11201 7.19126L9.41183 1.15503C10.0728 0.674329 11 1.14648 11 1.96377V14.0362C11 14.8535 10.0728 15.3257 9.41183 14.845L1.11201 8.80874C0.562908 8.40939 0.562907 7.59061 1.11201 7.19126Z"/></svg></a></li>      
            
                    <li class="pager__item pager__item--number"><a href="/planet" title="Go to page 1" class="pager__link"><span class="visually-hidden">
              Page
            </span>
            1
                          </a></li>              <li class="pager__item pager__item--number"><a href="/planet/page/2" title="Go to page 2" class="pager__link"><span class="visually-hidden">
              Page
            </span>
            2
                          </a></li>              <li class="pager__item pager__item--number"><a href="/planet/page/3" title="Go to page 3" class="pager__link"><span class="visually-hidden">
              Page
            </span>
            3
                          </a></li>              <li class="pager__item pager__item--active pager__item--number"><span class="visually-hidden">
              Current page
            </span>
            4
                      </li>              <li class="pager__item pager__item--number"><a href="/planet/page/5" title="Go to page 5" class="pager__link"><span class="visually-hidden">
              Page
            </span>
            5
                          </a></li>              <li class="pager__item pager__item--number"><a href="/planet/page/6" title="Go to page 6" class="pager__link"><span class="visually-hidden">
              Page
            </span>
            6
                          </a></li>      
            
                    <li class="pager__item pager__item--control pager__item--next"><a href="/planet/page/5" title="Go to next page" rel="next" class="pager__link"><span class="visually-hidden">Next page</span><svg xmlns="http://www.w3.org/2000/svg" width="11" height="16" viewBox="0 0 11 16"><path d="M1.11201 7.19126L9.41183 1.15503C10.0728 0.674329 11 1.14648 11 1.96377V14.0362C11 14.8535 10.0728 15.3257 9.41183 14.845L1.11201 8.80874C0.562908 8.40939 0.562907 7.59061 1.11201 7.19126Z"/></svg></a></li>      
                    <li class="pager__item pager__item--control pager__item--last"><a href="/planet/page/6" title="Go to last page" class="pager__link"><span class="visually-hidden">Last page</span><svg xmlns="http://www.w3.org/2000/svg" width="15px" height="16px" viewBox="0 0 15 16"><path d="M5.1,7.2l8.3-6C14.1,0.7,15,1.1,15,2V14c0,0.8-0.9,1.3-1.6,0.8l-8.3-6C4.6,8.4,4.6,7.6,5.1,7.2z M0,0h2v16H0V0z"/></svg></a></li>          </ul>
  </nav>

              <div class="feed-icons">
      


<a href="https://joachim-n.github.io//planet/feed" class="feed-icon">
  <span class="feed-icon__label">
    Joachim&amp;#039;s blog
  </span>
  <span class="feed-icon__icon" aria-hidden="true">
    <svg xmlns="http://www.w3.org/2000/svg" width="14.2" height="14.2" viewBox="0 0 14.2 14.2">
  <path d="M4,12.2c0-2.5-3.9-2.4-3.9,0C0.1,14.7,4,14.6,4,12.2z M9.1,13.4C8.7,9,5.2,5.5,0.8,5.1c-1,0-1,2.7-0.1,2.7c3.1,0.3,5.5,2.7,5.8,5.8c0,0.7,2.1,0.7,2.5,0.3C9.1,13.7,9.1,13.6,9.1,13.4z M14.2,13.5c-0.1-3.5-1.6-6.9-4.1-9.3C7.6,1.7,4.3,0.2,0.8,0c-1,0-1,2.6-0.1,2.6c5.8,0.3,10.5,5,10.8,10.8C11.5,14.5,14.3,14.4,14.2,13.5z"/>
</svg>
  </span>
</a>

    </div>
  </div>
</div>

    </div>
  </div>

  </div>

              </main>
                        
          </div>
        </div>
        <div class="social-bar">
          
        </div>
      </div>
    </div>

    <footer class="site-footer">
      <div class="site-footer__inner container">
        

  <div class="region region--footer-top grid-full layout--pass--content-medium">
    <div class="region--footer_top__inner">
      

<div id="block-joachim-blog-theme-powered" class="block block-system block-system-powered-by-block">
  
    
    
  <span>
    Powered by    <a href="https://www.drupal.org">Drupal</a>
    <span class="drupal-logo" role="img" aria-label="Drupal Logo">
      <svg width="14" height="19" viewBox="0 0 42.15 55.08" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M29.75 11.73C25.87 7.86 22.18 4.16 21.08 0 20 4.16 16.28 7.86 12.4 11.73 6.59 17.54 0 24.12 0 34a21.08 21.08 0 1042.15 0c0-9.88-6.59-16.46-12.4-22.27zM10.84 35.92a14.13 14.13 0 00-1.65 2.62.54.54 0 01-.36.3h-.18c-.47 0-1-.92-1-.92-.14-.22-.27-.45-.4-.69l-.09-.19C5.94 34.25 7 30.28 7 30.28a17.42 17.42 0 012.52-5.41 31.53 31.53 0 012.28-3l1 1 4.72 4.82a.54.54 0 010 .72l-4.93 5.47zm10.48 13.81a7.29 7.29 0 01-5.4-12.14c1.54-1.83 3.42-3.63 5.46-6 2.42 2.58 4 4.35 5.55 6.29a3.08 3.08 0 01.32.48 7.15 7.15 0 011.3 4.12 7.23 7.23 0 01-7.23 7.25zM35 38.14a.84.84 0 01-.67.58h-.14a1.22 1.22 0 01-.68-.55 37.77 37.77 0 00-4.28-5.31l-1.93-2-6.41-6.65a54 54 0 01-3.84-3.94 1.3 1.3 0 00-.1-.15 3.84 3.84 0 01-.51-1v-.19a3.4 3.4 0 011-3c1.24-1.24 2.49-2.49 3.67-3.79 1.3 1.44 2.69 2.82 4.06 4.19a57.6 57.6 0 017.55 8.58A16 16 0 0135.65 34a14.55 14.55 0 01-.65 4.14z"/>
</svg>
    </span>
  </span>
</div>

    </div>
  </div>

        
      </div>
    </footer>

    <div class="overlay" data-drupal-selector="overlay"></div>

  </div>
</div>

  </div>

    
    <script type="application/json" data-drupal-selector="drupal-settings-json">{"path":{"baseUrl":"\/","pathPrefix":"","currentPath":"planet","currentPathIsAdmin":false,"isFront":false,"currentLanguage":"en","currentQuery":{"page":"3"}},"pluralDelimiter":"\u0003","suppressDeprecationErrors":true,"user":{"uid":0,"permissionsHash":"01dd47ecd9bcd15f4ce2dda67f9266a98e8b92ff7b9c64558fb5367373af7d61"}}</script>
<script src="/sites/default/files/js/js_8VAq5rHg72u4MA8hrGwHx9Lz8WNC8wFO7od1Rvg4xTA.js?scope=footer&amp;delta=0&amp;language=en&amp;theme=joachim_blog_theme&amp;include=eJxLzk9JTcvMKUkt0k-GM3Wy8hOTMzJz45Ny8tPjSzJSc1P103PykxJzdItLKnMy89IBYRsVxQ"></script>

  </body>
</html>
