<!DOCTYPE html>
<html lang="en" dir="ltr" style="--color--primary-hue:202;--color--primary-saturation:79%;--color--primary-lightness:50">
  <head>
    <meta charset="utf-8" />
<meta name="Generator" content="Drupal 10 (https://www.drupal.org)" />
<meta name="MobileOptimized" content="width" />
<meta name="HandheldFriendly" content="true" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="icon" href="/themes/custom/joachim_blog_theme/favicon.ico" type="image/vnd.microsoft.icon" />
<link rel="alternate" type="application/rss+xml" title="Blog" href="https://joachim-n.github.io/blog.xml" />

    <title>Blog | Joachim&#039;s blog</title>
    <link rel="stylesheet" media="all" href="/sites/default/files/css/css_6pN0lBBBErbaoeWin5tdErkUyV-X6Hys294X41Zy_jg.css?delta=0&amp;language=en&amp;theme=joachim_blog_theme&amp;include=eJxtykEOgCAMBdELgRzJgHwBba2xKOH2Gre6mcXLLOKnXHgMJGmsGQw3A9EsX08kwZPV2qls6e_YpeFAtKHbR6f176k-qdGuFeyCV5iroKl7O7DEk3ADz2I5qA" />
<link rel="stylesheet" media="all" href="/sites/default/files/css/css_1jXAH4oZpERf974X1bp6_kLxFzUh9NogUun0JLEBbNE.css?delta=1&amp;language=en&amp;theme=joachim_blog_theme&amp;include=eJxtykEOgCAMBdELgRzJgHwBba2xKOH2Gre6mcXLLOKnXHgMJGmsGQw3A9EsX08kwZPV2qls6e_YpeFAtKHbR6f176k-qdGuFeyCV5iroKl7O7DEk3ADz2I5qA" />

    
    
<link rel="preload" href="/themes/custom/joachim_blog_theme/fonts/metropolis/Metropolis-Regular.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/themes/custom/joachim_blog_theme/fonts/metropolis/Metropolis-SemiBold.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/themes/custom/joachim_blog_theme/fonts/metropolis/Metropolis-Bold.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/themes/custom/joachim_blog_theme/fonts/lora/lora-v14-latin-regular.woff2" as="font" type="font/woff2" crossorigin>
    <noscript><link rel="stylesheet" href="/themes/custom/joachim_blog_theme/css/components/navigation/nav-primary-no-js.css?sspisc" />
</noscript>
  </head>
  <body class="path-frontpage">
        <a href="#main-content" class="visually-hidden focusable skip-link">
      Skip to main content
    </a>
    
      <div class="dialog-off-canvas-main-canvas" data-off-canvas-main-canvas>
    
<div id="page-wrapper" class="page-wrapper">
  <div id="page">

          <header id="header" class="site-header" data-drupal-selector="site-header" role="banner">

                <div class="site-header__fixable" data-drupal-selector="site-header-fixable">
          <div class="site-header__initial">
            <button class="sticky-header-toggle" data-drupal-selector="sticky-header-toggle" role="switch" aria-controls="site-header__inner" aria-label="Sticky header" aria-checked="false">
              <span class="sticky-header-toggle__icon">
                <span></span>
                <span></span>
                <span></span>
              </span>
            </button>
          </div>

                    <div id="site-header__inner" class="site-header__inner" data-drupal-selector="site-header-inner">
            <div class="container site-header__inner__container">

              


<div id="block-joachim-blog-theme-site-branding" class="site-branding block block-system block-system-branding-block">
  
    
    <div class="site-branding__inner">
              <div class="site-branding__text">
        <div class="site-branding__name">
          <a href="/" title="Home" rel="home">Joachim&#039;s blog</a>
        </div>
      </div>
      </div>
</div>
<nav  id="block-joachim-blog-theme-main-menu" class="primary-nav block block-menu navigation menu--main" aria-labelledby="block-joachim-blog-theme-main-menu-menu" role="navigation">
            
  <h2 class="visually-hidden block__title" id="block-joachim-blog-theme-main-menu-menu">Main navigation</h2>
  
        
          <ul  class="menu menu--level-1">
            
                          
        
        
        <li class="menu__item menu__item--link menu__item--level-1">
                    
          <a href="/" class="menu__link menu__link--link menu__link--level-1" data-drupal-link-system-path="&lt;front&gt;">Home</a>

          
        </li>
      
                          
        
        
        <li class="menu__item menu__item--link menu__item--level-1">
                    
          <a href="/about" class="menu__link menu__link--link menu__link--level-1" data-drupal-link-system-path="node/1">About</a>

          
        </li>
          </ul>
  


  </nav>

<div class="header-nav-overlay" data-drupal-selector="header-nav-overlay"></div>


                          </div>
          </div>
        </div>
      </header>
    
    <div id="main-wrapper" class="layout-main-wrapper layout-container">
      <div id="main" class="layout-main">
        <div class="main-content">
          <a id="main-content" tabindex="-1"></a>
          
          <div class="main-content__container container">
            

  <div class="region region--highlighted grid-full layout--pass--content-medium">
    <div data-drupal-messages-fallback class="hidden messages-list"></div>

  </div>

            



                          <main role="main">
                

  <div class="region region--content-above grid-full layout--pass--content-medium">
    

<div id="block-joachim-blog-theme-page-title" class="block block-core block-page-title-block">
  
  

  <h1 class="title page-title">Blog</h1>


  
</div>

  </div>

                

  <div class="region region--content grid-full layout--pass--content-medium" id="content">
    

<div id="block-joachim-blog-theme-content" class="block block-system block-system-main-block">
  
    
      <div class="block__content">
      <div class="views-element-container"><div class="view view-blog view-id-blog view-display-id-page_1 js-view-dom-id-8f31fbae8ff214262df6eb0a5b81e406530b76fe60c41aecac0864c1b90516a5">
  
    
      
      <div class="view-content">
          <div class="views-row">

<article class="node node--type-article grid-full node--promoted node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/i-would-sme-fucking-content" rel="bookmark">
<span>I would like sme fucking content</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>admin</span></span>, Thu, 06/05/2025 - 17:12
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item">xfsdfsd</div>
      
  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--promoted node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/changing-your-mind-about-dependency-injection" rel="bookmark">
<span>Changing your mind about dependency injection</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Thu, 10/24/2024 - 11:25
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>When I start writing a class that has a dependency injection, I have a clear idea about which services it needs. I generate it -- the plugin, form, controller, or service -- and specify those services.</p>
<p>Then nearly always, unless it's something really very simple, I find that no matter how much I thought about it and planned it, I need to add more services. Maybe remove some too.</p>
<p>Fortunately, because Module Builder saves the configuration of the module code you've generated, it's easy to go back to it and edit it to add more services:</p>
<ol>
<li>Edit your module in Module Builder</li>
<li>Add to the injected services for your component</li>
<li>Ensure your code file is committed to version control</li>
<li>Generate the code, and write the updated version of the code file</li>
<li>Add and commit the new DI code, while discarding the changes that remove your code. (I find it helps to use a git GUI for things like this, though <code>git add -p</code> works too.)</li>
</ol>
<p>But I tend to find that I make this mistake several times as the class develops, and so I adopt the approach of using the <code>\Drupal::service()</code> function to get my services, and only when I'm fairly confident I'm not going to need to make any more changes to DI, I update the injected services in one go, converting all the service calls to use the service properties.</p>
<p>I was asked yesterday at Drupal Drinks about how to do that, and it occurred to me that there's a way of doing this so after you've updated the dependency injection with Module Builder, it's a simple find and replace to update your code.</p>
<p>If you write your code like this whenever you need a service:</p>
<pre><code>$service_entityTypeManager = \Drupal::service('entity_type.manager');
$stuff = $service_entityTypeManager-&gt;doSomething();
</code></pre>
<p>Then you need to do only two find and replace operations to convert this to DI:</p>
<ol>
<li>Replace <code>'^.+Drupal::service.+\n'</code> with <code>''</code>. This removes all the lines where you get the service from the Drupal class.</li>
<li>Replace <code>'\$service_(\w+)'</code> with <code>'$this-&gt;$1'</code>. This replaces all the service variables
with the class property.</li>
</ol>
<p>Up until now I'd been calling the service variables something like <code>$entityTypeManager</code> so that I could easily change that to <code>$this-&gt;entityTypeManager</code> manually, but prefixing the variable name with a camel case <code>'service_'</code> gives you something to find with a regular expression.</p>
<p>If you want to be really fancy, you can use a regular expression like <code>'(?&lt;=::service..)[\w.]+'</code> (using dots to avoid having to escape the open bracket and the quote mark) to find all the services that you need to add to the class's dependency injection.</p>
<p>Something like this:</p>
<pre><code>$ ag -G MyClass.php '(?&lt;=::service..)[\w.]+' -o --nonumbers --nofilename | sort | uniq | tr "\n" ", "
</code></pre>
<p>will give you a list of service names that you can copy-paste into the Module Builder form. This is probably overkill for something you can do pretty quickly with the search in a text editor or IDE, but it's a nice illustration of the power of unix tools: <code>ag</code> has options to output just the found text, then <code>sort</code> and <code>uniq</code> eliminate duplicates, and finally <code>tr</code> turns it into a comma-separated list.</p></div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/68" hreflang="en">dependency injection</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/56" hreflang="en">drupal code builder</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/8" hreflang="en">module builder</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/refactoring-rector" rel="bookmark">
<span>Refactoring with Rector</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Fri, 05/03/2024 - 20:47
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>Rector is a tool for making changes to PHP code, which powers tools that assist with upgrading deprecated code in Drupal. When I recently made some refactoring changes in Drupal Code Builder, which were too complex to do with search and replace regexes, it seemed like a good opportunity to experiment with Rector, and learn a bit more about it.</p>
<p>Besides, I'm an inveterate condiment-passer: I tend to prefer spending longer on a generalisation of a problem than on the problem itself, and the more dull the problem and the more interesting the generalisation, the more the probability increases.</p>
<p>So faced with a refactoring from this return from the <code>getFileInfo()</code> method:</p>
<pre><code>    return [
      'path' =&gt; '',
      'filename' =&gt; $this-&gt;component_data['filename'],
      'body' =&gt; $body,
      'merged' =&gt;$merged,
    ];
</code></pre>
<p>to this:</p>
<pre><code>    return new CodeFile(
      body_pieces: $body,
      merged: $merged,
    );
</code></pre>
<p>which was going to be tedious as hell to do in a ton of files, obviously, I elected to spend time fiddling with Rector.</p>
<p>The first thing I'll say is that the same sort of approach as I use with migrations works well: work with a small indicative sample, and iterate small changes. With a migration, I will find a small number of source rows which represent different variations (or if there is too much variation, I'll iterate the iteration multiple times). I'll run the migration with just those sources, examine the result, make refinements to the migration, then roll back and repeat.</p>
<p>With Rector, you can specify just a single class in the code that registers the rule to RectorConfig in the rector.php file, so I picked a class which had very little code, as the dump() output of an entire PHP file's PhpParser analysis is enormous.</p>
<p>You then use the rule class's <code>getNodeTypes()</code> method to declare which node types you are interested in. Here, I made a mis-step at first. I wanted to replace Array_ nodes, but only in the <code>getFileInfo()</code> method. So in my first attempt, I specified ClassMethod nodes, and then in <code>refactor()</code> I wrote code to drill down into them to get the array Array_ nodes. This went well until I tried returning a new replacement node, and then Rector complained, and I realised the obvious thing I'd skipped over: the <code>refactor()</code> method expects you to return a node to replace the found node. So my approach was completely wrong.</p>
<p>I rewrote <code>getNodeTypes()</code> to search for <code>Array_</code> nodes: those represent the creation of an array value. This felt more dangerous: arrays are defined in lots of places in my code! And I haven't been able to see a way to determine the parentage of a node: there do not appear to be pointers that go back up the PhpParser syntax tree (it would be handy, but would make the dump() output even worse to read!). Fortunately, the combination of array keys was unique in DrupalCodeBuilder, or at least I hoped it was fairly unique. So I wrote code to get a list of the array's keys, and then compare it to what was expected:</p>
<pre><code>        foreach ($node-&gt;items as $item) {
            $seen_array_keys[] = $item-&gt;key-&gt;value;
        }
        if (array_intersect(static::EXPECTED_MINIMUM_ARRAY_KEYS, $seen_array_keys) != static::EXPECTED_MINIMUM_ARRAY_KEYS) {
            return NULL;
        }
</code></pre>
<p>Returning NULL from <code>refactor()</code> means we aren't interested in this node and don't want to change it.</p>
<p>With the arrays that made it through the filter, I needed to make a new node that's a class instantiation, to replace the array, passing the same values to the <code>new</code> statement as the array keys (mostly).</p>
<p>Rector's <a href="https://github.com/rectorphp/php-parser-nodes-docs">list of commonly used PhpParser nodes</a> was really useful here.</p>
<p>A <code>new</code> statement node is made thus:</p>
<pre><code>use PhpParser\Node\Name;
use PhpParser\Node\Expr\New_;

        $class = new Name('\DrupalCodeBuilder\File\CodeFile');
        return new New_($class);
</code></pre>
<p>This doesn't have any parameters yet, but running Rector on this with my sample set showed me it was working properly. Rector has a dry run option for development, which shows you what would change but doesn't write anything to files, so you can run it over and over again. What's confusing is that it also has a cache; until I worked this out I was repeatedly confused by some runs having no effect and no output. I have honestly no idea what the point is of caching something that's designed to make changes, but there is an option to disable it. So the command to run is: <code>$ vendor/bin/rector --dry-run --clear-cache</code>. Over and over again.</p>
<p>Once that worked, I needed to convert array items to constructor parameters. Fortunately, the value from the array items work for parameters too:</p>
<pre><code>use PhpParser\Node\Arg;

        foreach ($node-&gt;items as $array_item) {
                $construct_argument = new Arg(
                   $array_item-&gt;value,
                );
</code></pre>
<p>That gave me the values. But I wanted named parameters for my constructor, partly because they're cool and mostly because the CodeFile class's <code>__construct()</code> has optional parameters, and using names makes that simpler.</p>
<p>Inspecting the <code>Arg</code> class's own constructor showed how to do this:</p>
<pre><code>use PhpParser\Node\Arg;
use PhpParser\Node\Identifier;

                $construct_argument = new Arg(
                    value: $array_item-&gt;value,
                    name: new Identifier($key),
                );
</code></pre>
<p>Using named parameters here too to make the code clearer to read!</p>
<p>It's also possible to copy over any inline comments that are above one node to a new node:</p>
<pre><code>            // Preserve comments.
            $construct_argument-&gt;setAttribute('comments', $array_item-&gt;getComments());
</code></pre>
<p>The constructor parameters are passed as a parameter to the <code>New_</code> class:</p>
<pre><code>        return new New_($class, $new_call_args);
</code></pre>
<p>Once this was all working, I decided to do some more refactoring in the CodeFile class in DrupalCodeBuilder. The changes I was making with Rector made it more apparent that in a lot of cases, I was passing empty values. Also, the <code>$body</code> parameter wasn't well-named, as it's an array of pieces, so could do with a more descriptive name such as <code>$body_pieces</code>.</p>
<p>Changes like this are really easy to do (though by this point, I had made a git repository for my Rector rule, so I could make further enhancements without breaking what I'd got working already).</p>
<pre><code>        foreach ($node-&gt;items as $array_item) {
            $key = $array_item-&gt;key-&gt;value;

            // Rename the 'body' key.
            if ($key == 'body') {
                $key = 'body_pieces';
            }
</code></pre>
<p>And that's my Rector rule done.</p>
<p>Although it's taken me far more time than changing each file by hand, it's been far more interesting, and I've learned a lot about how Rector works, which will be useful to me in the future. I can definitely see how it's a very useful tool even for refactoring a small codebase such as DrupalCodeBuilder, where a rule is only going to be used once. It might even prompt me to undertake some minor refactoring tasks I've been putting off because of how tedious they'll be.</p>
<p>What I've not figured out is how to extract namespaces from full class names to an import statement, or how to put line breaks in the <code>new</code> statement. I'm hoping that a pass through with PHP_CodeSniffer and Drupal Coder's rules will fix those. If not, there's always good old regexes!</p></div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/65" hreflang="en">refactoring</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/66" hreflang="en">Rector</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/67" hreflang="en">PhpParser</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/56" hreflang="en">drupal code builder</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/defining-bundle-fields-code" rel="bookmark">
<span>Defining bundle fields in code</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Mon, 01/31/2022 - 17:14
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>Fields in Drupal 9 can be defined in code, or they can be defined in configuration. Both techniques have their uses and advantages. Typically code fields apply to all bundles of the entity type, as so-called base fields, while config fields apply only to a single bundle.</p>
<p>But there is a way to have code fields which apply only to specific bundles: these are called bundle fields. These are particularly useful for adding computed fields to specific bundles of an entity (more on computed fields in a future blog post).</p>
<p>The API for these is a bit clunky, as it wasn't finalised for Drupal 8, and it may in fact be <a href="https://www.drupal.org/node/2346347">completely changed in the future</a>. If that causes you apprehension at implementing bundle fields in your code, it's worth mentioning that the last patch on that issue was in 2017: it's a complex problem without many applications, so accordingly doesn't get much attention.</p>
<p>Bundle fields need to be defined in two places: the field storage, and field definition itself. This is similar to how config fields work; it's actually the
same as base fields, but the BaseFieldDefinition hides this from you as it does double duty. (There is <a href="https://www.drupal.org/project/drupal/issues/2980922">an issue to remove the need to define the storage</a>, but again, not much happening there.)</p>
<p>You also need a field definition class. The <a href="https://www.drupal.org/project/entity">entity contrib module</a> provides a BundleFieldDefinition class, but if you don't want to install that module just for a single class, <a href="https://git.drupalcode.org/project/entity/-/blob/8.x-1.x/src/BundleFieldDefinition.php">copy-pasting that class</a> to your custom module is fine too.</p>
<p>(There is a class in core FieldDefinition, which was
<a href="https://www.drupal.org/node/2982512">added for this purpose</a>, however, that requires a storage class to work alongside it, and <a href="https://www.drupal.org/node/2280639">the issue to provide that</a> has not yet been fixed.)</p>
<p>Once you have that class, how you define the field depends on the entity you're adding it to.</p>
<h3>Bundle fields on your own entity type</h3>
<p>In your own entity type, you define the entity class. You can therefore implement the bundleFieldDefinitions() method in that class:</p>
<pre><code>  // In MyEntity class:
  /**
   * {@inheritdoc}
   */
  public static function bundleFieldDefinitions(EntityTypeInterface $entity_type, $bundle, array $base_field_definitions) {
    $definitions = [];

    if ($bundle == 'mybundle') {
      $definitions['myfield'] = BundleFieldDefinition::create('entity_reference')
        // This is essential: the array key is NOT used as the field machine name,
        // so it MUST be specified here!
        -&gt;setName('myfield')
        // These two are essential: they define the entity type and the bundle
        // that the field is on.
        -&gt;setTargetEntityTypeId($entity_type-&gt;id())
        -&gt;setTargetBundle($bundle)
        // Further define the field as you would with a base field.
        -&gt;setLabel(t('Label'))
        -&gt;setDescription(t('Description.'));
    }

    return $definitions;
  }
</code></pre>
<p>That defines the field. Because these are bundle fields, the storage must be
defined separately in hook_entity_field_storage_info(). However, we can take
advantage of the BundleFieldDefinition class doing double duty as a storage
and a field, and piggy-back on the definition in the entity class:</p>
<pre><code>/**
 * Implements hook_entity_field_storage_info().
 */
function mymodule_entity_field_storage_info(EntityTypeInterface $entity_type) {
  // Entity bundle fields need to declare their storage separately. However, we
  // can piggyback on the field definition itself, since the
  // BundleFieldDefinition class does double duty as field and storage
  // definition since it extends from BaseFieldDefinition.
  // We cheat on the parameters we pass in, as the entity's
  // bundleFieldDefinitions() method expects a list of base field definitions,
  // but we have none here to give. For our purposes, bundleFieldDefinitions()
  // does not need them.
  if ($entity_type-&gt;id() == 'myentity') {
    return MyEntity::bundleFieldDefinitions($entity_type, 'mybundle', []);
  }
}
</code></pre>
<p>The documentation for hook_entity_bundle_field_info() suggests you do it the other way round,
and define the storage first, then derive the field from the storage, but doing it in the way shown above means that the code for your field is in
your entity class where it's alongside the base field definition, and more easily discoverable.</p>
<h3>Bundle fields on someone else's entity type</h3>
<p>For an entity type you don't control, you could switch the entity class to a
custom subclass and implement bundleFieldDefinitions() in that, but it's simpler to use hook_entity_bundle_field_info().</p>
<pre><code>/**
 * Implements hook_entity_bundle_field_info().
 */
function mymodule_entity_bundle_field_info(EntityTypeInterface $entity_type, $bundle, array $base_field_definitions) {
  if ($entity_type-&gt;id() == 'myentity' &amp;&amp; $bundle == 'mybundle') {
    $fields = [];
    $fields['myfield'] = BundleFieldDefinition::create('list_integer')
      // This is essential: the array key is NOT used as the field machine name,
      // so it MUST be specified here!
      -&gt;setName('myfield')
      // These two are essential: they define the entity type and the bundle
      // that the field is on.
      -&gt;setTargetEntityTypeId($entity_type-&gt;id())
      -&gt;setTargetBundle($bundle)
      // Further define the field as you would with a base field.
      -&gt;setLabel(t('Label'))
      -&gt;setDescription(t('Description.'));

    return $fields;
  }
}

/**
 * Implements hook_entity_field_storage_info().
 */
function mymodule_entity_field_storage_info(EntityTypeInterface $entity_type) {
  if ($entity_type-&gt;id() == 'myentity') {
    return mymodule_entity_bundle_field_info($entity_type, 'mybundle', []);
  }
}
</code></pre>
<p>We use the same piggybacking trick here. In the case of altering someone else's entity type,
it makes just as much sense to define the storage and derive the field, but following the same pattern as the
custom entity keeps the two methods matching.</p>
<p>As you can see, this is an area of Drupal's entity system which is unfortunately incomplete,
and liable to change in the future. Nonetheless, the usefulness of bundle fields means that it's worth using them. Just be sure to document your code so future developers (who might be you!)
know that it's area of the code that may need maintainance when the API is updated. And keep an eye on the Drupal core change records!</p></div>
      
  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/commit-your-composer-managed-files-version-control" rel="bookmark">
<span>Commit your Composer-managed files to version control</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Tue, 04/20/2021 - 08:46
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>According to the Composer documentation, you shouldn't commit to version control
any of the files in packages that are managed by Composer. For a Drupal project,
that means the following folders are not in your git repository:</p>
<ul>
<li>vendor</li>
<li>web/core</li>
<li>web/modules/contrib</li>
</ul>
<p>Bluntly, I think this is the wrong thing to do. Doing the exact opposite saves you time, effort, heartache, and energy.</p>
<p>Let's start by comparing the two workflows.</p>
<h2>Composer-recommended workflow: the wrong way</h2>
<ol>
<li>Alice, the developer, updates some packages in her local dev.</li>
<li>She commits only the composer.json and composer.lock files.</li>
<li>Bob pulls changes, and runs <code>composer install</code> to update his local dev.</li>
<li>When the project is deployed, the server needs to run <code>composer install</code> as part of the deployment process.</li>
</ol>
<h2>Git-managed workflow: the right way</h2>
<ol>
<li>Alice, the developer, updates some packages in her local dev.</li>
<li>She commits all the new and changed files.</li>
<li>Bob pulls changes.</li>
<li>When the project is deployed... it's deployed. All the files necessary to run the app are in git, and so updating the server's git clone gives it all the files.</li>
</ol>
<p>The first reason this workflow is better should jump out: developers save time. Git is much faster and pulling files from a repository than Composer is at resolving, downloading, and installing packages. Switching git branches is fast, even when a lot of files change. Having to run Composer because one branch has package updates on it and the other doesn't, or has different ones, is a waste of developer time.</p>
<p>The second reason is related: save time in deployment. That's not just developer time, that's time your production server is down.</p>
<p>The third reason is more philosophical: Composer is not a <em>file</em> management tool. It's a <em>dependency</em> management tool. Let Composer do what it does well, which is figuring out which versions of which packages should be installed. Let git handle what it does well, which is synchronizing different copies of a codebase. Purists may point out that git is a version control tool, not a file management tool: that's a valid point, but doesn't diminish my argument: commit all files, and then use rsync or whatever to get the files from a git clone to the server.</p>
<p>Related to this: don't make your webserver do package management work; that's not its job. And don't make Bob repeat the work Alice already did.</p>
<p>Finally, committing files to git puts them under version control. That's merely stating the obvious, but putting files under version control has many benefits.</p>
<ul>
<li>
<p>IDEs typically ignore git-ignored files for things like searching and code analysis. On my IDE at least (VSCode), disabling that means it then wants to include things like the uploaded files folder.</p>
</li>
<li>
<p>Similarly, search tools such as <code>ag</code> and <code>ack</code> take <code>.gitignore</code> files into account, and having to override that robs you of useful behaviour.</p>
</li>
<li>
<p>Finally, files under version control are easier to debug and tinker with. I for one often go digging in core or contrib modules, trying to figure out why something isn't working the way it's supposed to, or trying to fix a bug. To do that, I put in dump statements; sometimes tons of dump statements. (I can never get xdebug to work. Dump statements are quick and easy.) With code under version control, cleaning up all that mess is trivial: git can discard all changes. Without version control, I'm hunting through files for all the debug changes I made, or bouncing on CMD-Z like it's still the dark ages.</p>
</li>
</ul>
<p>So, put all your files in version control. And remember the adage: if it's not under version control, it doesn't exist.</p></div>
      
  </div>
  </article>
</div>

    </div>
  
        <nav class="pager layout--content-medium" role="navigation" aria-labelledby="pagination-heading">
    <h4 id="pagination-heading" class="visually-hidden">Pagination</h4>
    <ul class="pager__items js-pager__items">
            
            
            
                    <li class="pager__item pager__item--active pager__item--number"><span class="visually-hidden">
              Current page
            </span>
            1
                      </li>              <li class="pager__item pager__item--number"><a href="/blog/page/2" title="Go to page 2" class="pager__link"><span class="visually-hidden">
              Page
            </span>
            2
                          </a></li>              <li class="pager__item pager__item--number"><a href="/blog/page/3" title="Go to page 3" class="pager__link"><span class="visually-hidden">
              Page
            </span>
            3
                          </a></li>              <li class="pager__item pager__item--number"><a href="/blog/page/4" title="Go to page 4" class="pager__link"><span class="visually-hidden">
              Page
            </span>
            4
                          </a></li>              <li class="pager__item pager__item--number"><a href="/blog/page/5" title="Go to page 5" class="pager__link"><span class="visually-hidden">
              Page
            </span>
            5
                          </a></li>              <li class="pager__item pager__item--number"><a href="/blog/page/6" title="Go to page 6" class="pager__link"><span class="visually-hidden">
              Page
            </span>
            6
                          </a></li>              <li class="pager__item pager__item--number"><a href="/blog/page/7" title="Go to page 7" class="pager__link"><span class="visually-hidden">
              Page
            </span>
            7
                          </a></li>              <li class="pager__item pager__item--number"><a href="/blog/page/8" title="Go to page 8" class="pager__link"><span class="visually-hidden">
              Page
            </span>
            8
                          </a></li>              <li class="pager__item pager__item--number"><a href="/blog/page/9" title="Go to page 9" class="pager__link"><span class="visually-hidden">
              Page
            </span>
            9
                          </a></li>      
                    <li class="pager__item pager__item--ellipsis" role="presentation">&hellip;</li>
      
                    <li class="pager__item pager__item--control pager__item--next"><a href="/blog/page/2" title="Go to next page" rel="next" class="pager__link"><span class="visually-hidden">Next page</span><svg xmlns="http://www.w3.org/2000/svg" width="11" height="16" viewBox="0 0 11 16"><path d="M1.11201 7.19126L9.41183 1.15503C10.0728 0.674329 11 1.14648 11 1.96377V14.0362C11 14.8535 10.0728 15.3257 9.41183 14.845L1.11201 8.80874C0.562908 8.40939 0.562907 7.59061 1.11201 7.19126Z"/></svg></a></li>      
                    <li class="pager__item pager__item--control pager__item--last"><a href="/blog/page/21" title="Go to last page" class="pager__link"><span class="visually-hidden">Last page</span><svg xmlns="http://www.w3.org/2000/svg" width="15px" height="16px" viewBox="0 0 15 16"><path d="M5.1,7.2l8.3-6C14.1,0.7,15,1.1,15,2V14c0,0.8-0.9,1.3-1.6,0.8l-8.3-6C4.6,8.4,4.6,7.6,5.1,7.2z M0,0h2v16H0V0z"/></svg></a></li>          </ul>
  </nav>

              <div class="feed-icons">
      


<a href="https://joachim-n.github.io/blog.xml" class="feed-icon">
  <span class="feed-icon__label">
    Blog
  </span>
  <span class="feed-icon__icon" aria-hidden="true">
    <svg xmlns="http://www.w3.org/2000/svg" width="14.2" height="14.2" viewBox="0 0 14.2 14.2">
  <path d="M4,12.2c0-2.5-3.9-2.4-3.9,0C0.1,14.7,4,14.6,4,12.2z M9.1,13.4C8.7,9,5.2,5.5,0.8,5.1c-1,0-1,2.7-0.1,2.7c3.1,0.3,5.5,2.7,5.8,5.8c0,0.7,2.1,0.7,2.5,0.3C9.1,13.7,9.1,13.6,9.1,13.4z M14.2,13.5c-0.1-3.5-1.6-6.9-4.1-9.3C7.6,1.7,4.3,0.2,0.8,0c-1,0-1,2.6-0.1,2.6c5.8,0.3,10.5,5,10.8,10.8C11.5,14.5,14.3,14.4,14.2,13.5z"/>
</svg>
  </span>
</a>

    </div>
  </div>
</div>

    </div>
  </div>

  </div>

              </main>
                        
          </div>
        </div>
        <div class="social-bar">
          
        </div>
      </div>
    </div>

    <footer class="site-footer">
      <div class="site-footer__inner container">
        

  <div class="region region--footer-top grid-full layout--pass--content-medium">
    <div class="region--footer_top__inner">
      

<div id="block-joachim-blog-theme-powered" class="block block-system block-system-powered-by-block">
  
    
    
  <span>
    Powered by    <a href="https://www.drupal.org">Drupal</a>
    <span class="drupal-logo" role="img" aria-label="Drupal Logo">
      <svg width="14" height="19" viewBox="0 0 42.15 55.08" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M29.75 11.73C25.87 7.86 22.18 4.16 21.08 0 20 4.16 16.28 7.86 12.4 11.73 6.59 17.54 0 24.12 0 34a21.08 21.08 0 1042.15 0c0-9.88-6.59-16.46-12.4-22.27zM10.84 35.92a14.13 14.13 0 00-1.65 2.62.54.54 0 01-.36.3h-.18c-.47 0-1-.92-1-.92-.14-.22-.27-.45-.4-.69l-.09-.19C5.94 34.25 7 30.28 7 30.28a17.42 17.42 0 012.52-5.41 31.53 31.53 0 012.28-3l1 1 4.72 4.82a.54.54 0 010 .72l-4.93 5.47zm10.48 13.81a7.29 7.29 0 01-5.4-12.14c1.54-1.83 3.42-3.63 5.46-6 2.42 2.58 4 4.35 5.55 6.29a3.08 3.08 0 01.32.48 7.15 7.15 0 011.3 4.12 7.23 7.23 0 01-7.23 7.25zM35 38.14a.84.84 0 01-.67.58h-.14a1.22 1.22 0 01-.68-.55 37.77 37.77 0 00-4.28-5.31l-1.93-2-6.41-6.65a54 54 0 01-3.84-3.94 1.3 1.3 0 00-.1-.15 3.84 3.84 0 01-.51-1v-.19a3.4 3.4 0 011-3c1.24-1.24 2.49-2.49 3.67-3.79 1.3 1.44 2.69 2.82 4.06 4.19a57.6 57.6 0 017.55 8.58A16 16 0 0135.65 34a14.55 14.55 0 01-.65 4.14z"/>
</svg>
    </span>
  </span>
</div>

    </div>
  </div>

        
      </div>
    </footer>

    <div class="overlay" data-drupal-selector="overlay"></div>

  </div>
</div>

  </div>

    
    <script type="application/json" data-drupal-selector="drupal-settings-json">{"path":{"baseUrl":"\/","pathPrefix":"","currentPath":"blog","currentPathIsAdmin":false,"isFront":true,"currentLanguage":"en","currentQuery":{"page":"0"}},"pluralDelimiter":"\u0003","suppressDeprecationErrors":true,"user":{"uid":0,"permissionsHash":"01dd47ecd9bcd15f4ce2dda67f9266a98e8b92ff7b9c64558fb5367373af7d61"}}</script>
<script src="/sites/default/files/js/js_to3MlzT0zacJEn6DCn7TBvEhDiQiZ5VxNxM_K58AE18.js?scope=footer&amp;delta=0&amp;language=en&amp;theme=joachim_blog_theme&amp;include=eJzLyk9MzsjMjU_KyU-PL8lIzU3VT8_JT0rM0S0uqczJzEsHAN_bDSg"></script>

  </body>
</html>
