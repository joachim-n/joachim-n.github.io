<!DOCTYPE html>
<html lang="en" dir="ltr" style="--color--primary-hue:202;--color--primary-saturation:79%;--color--primary-lightness:50">
  <head>
    <meta charset="utf-8" />
<meta name="Generator" content="Drupal 10 (https://www.drupal.org)" />
<meta name="MobileOptimized" content="width" />
<meta name="HandheldFriendly" content="true" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="icon" href="/themes/custom/joachim_blog_theme/favicon.ico" type="image/vnd.microsoft.icon" />
<link rel="alternate" type="application/rss+xml" title="Blog" href="https://joachim-n.github.io//blog.xml" />

    <title>Blog | Joachim&#039;s blog</title>
    <link rel="stylesheet" media="all" href="/sites/default/files/css/css_ihN9gV-WXsqs_8HEEt45YyjirGu6jPu5ot_R6_FnoJc.css?delta=0&amp;language=en&amp;theme=joachim_blog_theme&amp;include=eJxtiksOgCAQxS4EciTD54no4Bhn1HB7jQtXbJqmaeSEqZDicPFXs7CPc6ljIM6jzqhwE5B6PRMHT1a0Udly79j5xoFkQ7NvjWvvUZ_FSBNFdcELzFVwi_s4VE4n4QEvZUJF" />
<link rel="stylesheet" media="all" href="/sites/default/files/css/css_1jXAH4oZpERf974X1bp6_kLxFzUh9NogUun0JLEBbNE.css?delta=1&amp;language=en&amp;theme=joachim_blog_theme&amp;include=eJxtiksOgCAQxS4EciTD54no4Bhn1HB7jQtXbJqmaeSEqZDicPFXs7CPc6ljIM6jzqhwE5B6PRMHT1a0Udly79j5xoFkQ7NvjWvvUZ_FSBNFdcELzFVwi_s4VE4n4QEvZUJF" />

    
    
<link rel="preload" href="/themes/custom/joachim_blog_theme/fonts/metropolis/Metropolis-Regular.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/themes/custom/joachim_blog_theme/fonts/metropolis/Metropolis-SemiBold.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/themes/custom/joachim_blog_theme/fonts/metropolis/Metropolis-Bold.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/themes/custom/joachim_blog_theme/fonts/lora/lora-v14-latin-regular.woff2" as="font" type="font/woff2" crossorigin>
    <noscript><link rel="stylesheet" href="/themes/custom/joachim_blog_theme/css/components/navigation/nav-primary-no-js.css?sxcib3" />
</noscript>
  </head>
  <body class="path-frontpage">
        <a href="#main-content" class="visually-hidden focusable skip-link">
      Skip to main content
    </a>
    
      <div class="dialog-off-canvas-main-canvas" data-off-canvas-main-canvas>
    
<div id="page-wrapper" class="page-wrapper">
  <div id="page">

          <header id="header" class="site-header" data-drupal-selector="site-header" role="banner">

                <div class="site-header__fixable" data-drupal-selector="site-header-fixable">
          <div class="site-header__initial">
            <button class="sticky-header-toggle" data-drupal-selector="sticky-header-toggle" role="switch" aria-controls="site-header__inner" aria-label="Sticky header" aria-checked="false">
              <span class="sticky-header-toggle__icon">
                <span></span>
                <span></span>
                <span></span>
              </span>
            </button>
          </div>

                    <div id="site-header__inner" class="site-header__inner" data-drupal-selector="site-header-inner">
            <div class="container site-header__inner__container">

              


<div id="block-joachim-blog-theme-site-branding" class="site-branding block block-system block-system-branding-block">
  
    
    <div class="site-branding__inner">
              <div class="site-branding__text">
        <div class="site-branding__name">
          <a href="https://joachim-n.github.io//" title="Home" rel="home">Joachim&#039;s blog</a>
        </div>
      </div>
      </div>
</div>
<nav  id="block-joachim-blog-theme-main-menu" class="primary-nav block block-menu navigation menu--main" aria-labelledby="block-joachim-blog-theme-main-menu-menu" role="navigation">
            
  <h2 class="visually-hidden block__title" id="block-joachim-blog-theme-main-menu-menu">Main navigation</h2>
  
        
          <ul  class="menu menu--level-1">
            
                          
        
        
        <li class="menu__item menu__item--link menu__item--level-1">
                    
          <a href="https://joachim-n.github.io//" class="menu__link menu__link--link menu__link--level-1" data-drupal-link-system-path="&lt;front&gt;">Home</a>

          
        </li>
      
                          
        
        
        <li class="menu__item menu__item--link menu__item--level-1">
                    
          <a href="https://joachim-n.github.io//about" class="menu__link menu__link--link menu__link--level-1" data-drupal-link-system-path="node/1">About</a>

          
        </li>
          </ul>
  


  </nav>

<div class="header-nav-overlay" data-drupal-selector="header-nav-overlay"></div>


                          </div>
          </div>
        </div>
      </header>
    
    <div id="main-wrapper" class="layout-main-wrapper layout-container">
      <div id="main" class="layout-main">
        <div class="main-content">
          <a id="main-content" tabindex="-1"></a>
          
          <div class="main-content__container container">
            

  <div class="region region--highlighted grid-full layout--pass--content-medium">
    <div data-drupal-messages-fallback class="hidden messages-list"></div>

  </div>

            



                          <main role="main">
                

  <div class="region region--content-above grid-full layout--pass--content-medium">
    

<div id="block-joachim-blog-theme-page-title" class="block block-core block-page-title-block">
  
  

  <h1 class="title page-title">Blog</h1>


  
</div>

  </div>

                

  <div class="region region--content grid-full layout--pass--content-medium" id="content">
    

<div id="block-joachim-blog-theme-content" class="block block-system block-system-main-block">
  
    
      <div class="block__content">
      <div class="views-element-container"><div class="view view-blog view-id-blog view-display-id-page_1 js-view-dom-id-101cd0fbffe837d08c9aedf9ef9a50405bb27a1a4dad1f3944e3ea6aacd98819">
  
    
      
      <div class="view-content">
          <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="https://joachim-n.github.io//blog/script-making-patches" rel="bookmark">
<span>A script for making patches</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Fri, 03/27/2015 - 13:46
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>I have a standard format for patchnames: 1234-99.project.brief-description.patch, where 1234 is the issue number and 99 is the (expected) comment number. However, it involves two copy-pastes: one for the issue number, taken from my browser, and one for the project name, taken from my command line prompt.</p>
<p>Some automation of this is clearly possible, especially as I usually name my git branches 1234-brief-description. More automation is less typing, and so in true XKCD condiment-passing style, I've now written that script, which you can find on github as <a href="https://github.com/joachim-n/dorgpatch">dorgpatch</a>. (The hardest part was thinking of a good name, and as you can see, in the end I gave up.)</p>
<p>Out of the components of the patch name, the issue number and description can be deduced from the current git branch, and the project from the current folder. For the comment number, a bit more work is needed: but drupal.org now has a public API, so a simple REST request to that gives us data about the issue node including the comment count.</p>
<p>So far, so good: we can generate the filename for a new patch. But really, the script should take care of doing the diff too. That's actually the trickiest part: figuring out which branch to diff against. It requires a bit of git branch wizardry to look at the branches that the current branch forks off from, and some regular expression matching to find one that looks like a Drupal development branch (i.e., 8.x-4.x, or 8.0.x). It's probably not perfect; I don't know if I accounted for a possibility such as 8.x-4.x branching off a 7.x-3.x which then has no further commits and so is also reachable from the feature branch.</p>
<p>The other thing this script can do is create a tests-only patch. These are useful, and generally advisable on drupal.org issues, to demonstrate that the test not only checks for the correct behaviour, but also fails for the problem that's being fixed. The script assumes that you have two branches: the one you're on, 1234-brief-description, and also one called 1234-tests, which contains only commits that change tests.</p>
<p>The git workflow to get to that point would be:</p>
<ol>
<li>Create the branch 1234-brief-description
</li>
<li>Make commits to fix the bug
</li>
<li>Create a branch 1234-tests
</li>
<li>Make commits to tests (I assume most people are like me, and write the tests after the fix)
</li>
<li>Move the string of commits that are only tests so they fork off at the same point as the feature branch: git rebase --onto 8.x-4.x 1234-brief-description 1234-tests
</li>
<li>Go back to 1234-brief-description and do: git merge 1234-tests, so the feature branch includes the tests.
</li>
<li>If you need to do further work on the tests, you can repeat with a temporary branch that you rebase onto the tip of 1234-tests. (Or you can cherry-pick the commits. Or do cherry-pick with git rev-list, which is a trick I discovered today.)
</li>
</ol>
<p>Next step will be having the script make an interdiff file, which is a task I find particularly fiddly.</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/46" hreflang="en">git</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/49" hreflang="en">patching</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/54" hreflang="en">drupal.org</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/55" hreflang="en">workflow</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="https://joachim-n.github.io//blog/git-based-patch-workflow-drupalorg-interdiffs-free" rel="bookmark">
<span>A git-based patch workflow for drupal.org (with interdiffs for free!)</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Thu, 11/27/2014 - 08:39
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>There's been a lot of discussion about how we need github-like features on d.org. Will we get them? There's definitely many improvements in the pipeline to the way our issue queues work. Whether we actually need to replicate github is another debate (and my take on it is that I don't think we do).</p>
<p>In the meantime, I think that it's possible to have a good collaborative workflow with what we have right now on drupal.org, with just the issue queue and patches, and git local branches. Here's what I've gradually refined over the years. It's fast, it helps you keep track of things, and it makes the most of git's strengths.</p>
<h2>A word on local branches</h2>
<p>Git's killer feature, in my opinion, is local branches. Local branches allow you to keep work on different issues separate, and they allow you to experiment and backtrack. To get the most out of git, you should be making small, frequent commits.</p>
<p>Whenever I do a presentation on git, I ask for a show of hands of who's ever had to bounce on CMD-Z in their text editor because they broke something that was working five minutes ago. Commit often, and never have that problem again: my rule of thumb is to commit any time that your work has reached a state where if subsequent changes broke it, you'd be dismayed to lose it.</p>
<h2>Starting work on an issue</h2>
<p>My first step when I'm working on an issue is obviously:</p>
<div class="codeblock"><code>&nbsp; git pull</code></div>
<p>This gets the current branch (e.g. 7.x, 7.x-2.x) up to date. Then it's a good idea to reload your site and check it's all okay. If you've not worked on core or the contrib project in question in a while, then you might need to run update.php, in case new commits have added updates.</p>
<p>Now start a new local branch for the issue:</p>
<div class="codeblock"><code>&nbsp; git checkout -b 123456-foobar-is-broken</code></div>
<p>I like to prefix my branch name with the issue number, so I can always find the issue for a branch, and find my work in progress for an issue. A description after that is nice, and as git has bash autocompletion for branch names, it doesn't get in the way. Using the issue number also means that it's easy to see later on which branches I can delete to unclutter my local git checkout: if the issue has been fixed, the branch can be deleted!</p>
<p>So now I can go ahead and start making commits. Because a local branch is private to me, I can feel free to commit code that's a total mess. So something like:</p>
<div class="codeblock"><code>&nbsp; dpm($some_variable_I_needed_to_examine);<br>&nbsp; /*<br>&nbsp; // Commented-out earlier approach that didn't quite work right.<br>&nbsp; $foo += $bar;<br>&nbsp; */<br>&nbsp; // Badly-formatted code that will need to be cleaned up.<br>&nbsp; if($badly-formatted_code) { $arg++; }</code></div>
<p>That last bit illustrates an important point: commit code before cleaning up. I've lost count of the number of times that I've got it working, and cleaned up, and then broken it because I've accidentally removed an important line that was lost among the cruft. So as soon as code is working, I make a commit, usually whose message is something like 'TOUCH NOTHING IT WORKS!'. Then, start cleaning up: remove the commented-out bits, the false starts, the stray code that doesn't do anything, in small commits of course. (This is where you find it actually does, and breaks everything: but that doesn't matter, because you can just revert to a previous commit, or even use git bisect.)</p>
<h2>Keeping up to date</h2>
<p>Core (or the module you're working on) doesn't stay still. By the time you're ready to make a patch, it's likely that there'll be new commits on the main development branch (with core it's almost certain). And before you're ready, there may be commits that affect your ongoing work in some way: API changes, bug fixes that you no longer need to work around, and so on.</p>
<p>Once you've made sure there's no work currently uncommitted (either use git stash, or just commit it!), do:</p>
<div class="codeblock"><code>git fetch<br>git rebase BRANCH</code></div>
<p>where BRANCH is the main development branch that is being committed to on drupal.org, such as 8.0.x, 7.x-2.x-dev, and so on.</p>
<p>(This is arguably one case where a local branch is easier to work with than a github-style forked repository.)</p>
<p>There's lots to read about rebasing elsewhere on the web, and some will say that rebasing is a terrible thing. It's not, when used correctly. It can cause merge conflicts, it's true. But here's another place where small, regular commits help you: small commits mean small conflicts, that shouldn't be too hard to resolve.</p>
<h2>Making a patch</h2>
<p>At some point, I'll have code I'm happy with (and I'll have made a bunch of commits whose log messages are 'clean-up' and 'formatting'), and I want to make a patch to post to the issue:</p>
<div class="codeblock"><code>&nbsp; git diff 7.x-1.x &gt; 123456.PROJECT.foobar-is-broken.patch</code></div>
<p>Again, I use the issue number in the name of the patch. Tastes differ on this. I like the issue number to come first. This means it's easy to use autocomplete, and all patches are grouped together in my file manager and the sidebar of my text editor.</p>
<h2>Reviewing and improving on a patch</h2>
<p>Now suppose Alice comes along, reviews my patch, and wants to improve it. She should make her own local branch:</p>
<div class="codeblock"><code>&nbsp; git checkout -b 123456-foobar-is-broken</code></div>
<p>and download and apply my patch:</p>
<div class="codeblock"><code>&nbsp; wget PATCHURL<br>&nbsp; patch -p1 &lt; 123456.PROJECT.foobar-is-broken.patch</code></div>
<p>(Though I would hope she has a bash alias for 'patch -p1' like I do. The other thing to say about the above is that while wget is working at downloading the patch, there's usually enough time to double-click the name of the patch in its progress output and copy it to the clipboard so you don't have to type it at all.)</p>
<p>And finally commit it to her branch. I would suggest she uses a commit message that describes it thus:</p>
<div class="codeblock"><code>&nbsp; git commit -m "joachim's patch at comment #1"</code></div>
<p>(Though again, I would hope she uses a GUI for git, as it makes this sort of thing much easier.)</p>
<p>Alice can now make further commits in her local branch, and when she's happy with her work, make a patch the same way I did. She can also make an interdiff very easily, by doing a git diff against the commit that represents my patch.</p>
<h2>Incorporating other people's changes to ongoing work</h2>
<p>All simple so far. But now suppose I want to fix something else (patches can often bounce around like this, as it's great to have someone else to spot your mistakes and to take turns with). My branch looks like it did at my patch. Alice's patch is against the main branch (for the purposes of this example, 7.x-1.x).</p>
<p>What I want is a new commit on the tip of my local branch that says 'Alice's changes from comment #2'. What I need is for git to believe it's on my local branch, but for the project files to look like the 7.x-1.x branch. With git, there's nearly always a way:</p>
<div class="codeblock"><code>&nbsp; git checkout 7.x-1.x .</code></div>
<p>Note the dot at the end. This is the filename parameter to the checkout command, which tells git that rather than switch branches, you want to checkout just the given file(s) while staying on your current branch. And that the filename is a dot means we're doing that for the entire project. The branch remains unchanged, but all the files from 7.x-1.x are checked out.</p>
<p>I can now apply Alice's patch:</p>
<div class="codeblock"><code>&nbsp; wget PATCHURL<br>&nbsp; patch -p1 &lt; 123456.2.PROJECT.foobar-is-broken.patch</code></div>
<p>(Alice has put the comment ID after the issue ID in the patch filename.)</p>
<p>When I make a commit, the new commit goes on the tip of my local branch. The commit diff won't look like Alice's patch: it'll look like the difference between my patch and Alice's patch: effectively, an interdiff. I now make a commit for Alice's patch:</p>
<div class="codeblock"><code>&nbsp; git commit -m "Alice's patch at comment #2"</code></div>
<p>I can make more changes, then do a diff as before, post a patch, and work on the issue advances to another iteration.</p>
<p>Here's an example of my local branch for an issue on Migrate I've been working on recently. You can see where I made a bunch of commits to clean up the documentation to get ready to make a patch. Following that is a commit for the patch the module maintainer posted in response to mine. And following that are a few further tweaks that I made on top of the maintainer's patch, which I then of course posted as another patch.</p>
<p><img src="sites/default/files/article/image/git-local-branch-issue-workflow.png" width="457" height="257" alt="A screenshot of a git GUI showing the tip of a local branch, with a commit for a patch from another user."></p>
<p>(Notice how in a local branch, I don't feel the need to type terribly accurately for my commit messages, or indeed be all that clear.)</p>
<h2>Improving on our tools</h2>
<p>Where next? I'm pretty happy with this workflow as it stands, though I think there's plenty of scope for making it easier with some git or bash aliases. In particular, applying Alice's patch is a little tricky. (Though the stumbling block there is that you need to know the name of the main development branch. Maybe pass the script the comment URL, and let it ask d.org what the branch of that issue is?)</p>
<p>Beyond that, I wonder if any changes can be made to the way git works on d.org. A sandbox per issue would replace the passing around of patch files: you'd still have your local branch, and merge in and push instead of posting a patch. But would we have one single branch for the issue's development, which then runs the risk of commit clashes, or start a new branch each time someone wants to share something, which adds complexity to merging? And finally, sandboxes with public branches mean that rebasing against the main project's development can't be done (or at least, not without everyone know how to handle the consequences). The alternative would be merging in, which isn't perfect either.</p>
<p>The key thing, for me, is to preserve (and improve) the way that so often on d.org, issues are not worked on by just one person. They're a ball that we take turns pushing forward (snowball, Sisyphean rock, take your pick depending on the issue!). That's our real strength as a community, and whatever changes we make to our toolset have to be made with the goal of supporting that.</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/46" hreflang="en">git</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/6" hreflang="en">drupal planet</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/48" hreflang="en">issue queue</a></li>
          <li class="field--tags__item"><a href="https://joachim-n.github.io//taxonomy/term/49" hreflang="en">patching</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="https://joachim-n.github.io//blog/building-fast-and-flexible-application-uis-entity-operations" rel="bookmark">
<span>Building Fast and Flexible Application UIs with Entity Operations</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Tue, 11/18/2014 - 13:38
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>Now I've finished the Big Monster Project of Doom that I've been on the last two years, I can talk more about some of the code that I wrote for it. I can also say what it was: it was a web application for activists to canvass the public for a certain recent national referendum (I'll let you guess which one).</p>
<p>One of the major modules I wrote was <a href="https://www.drupal.org/project/entity_operations">Entity Operations</a> module. What began as a means to avoid repeating the same code each time I needed a new entity type soon became the workhorse for the whole application UI.</p>
<p>The initial idea was this: if you want a custom entity type, and you want a UI for adding, editing, and deleting entities (much like with nodes), then you have to build this all yourself: hook_menu() items, various entity callbacks, form builders (and validation and submit handlers) for the entity form and the delete confirmation form. (The <a href="https://www.drupal.org/project/model">Model module</a> demonstrates this well.)</p>
<p>That's a lot of boilerplate code, where the only difference is the entity type's name, the base path where the entity UI sits, and the entity form builder itself (but even that can be generalized, as will be seen).</p>
<p>Faced with this and a project on which I knew from the start I was going to need a good handful of custom entities (for use with Microsoft Dynamics CRM, accessed with another custom module of mine, <a href="http://drupal.org/project/remote_entity">Remote Entity API</a>), I undertook to build a framework that would take away all the repetition.</p>
<p>An Entity UI is thus built by declaring:</p>
<ul>
<li>A base path (for nodes, this would be 'node'; we'll ignore the fact that in core, this path itself is a listing of content).</li>
<li>A list of subpaths to form the tabs, and the operation handler class for each one</li>
</ul>
<p>With this in hand, why stop at just the entity view and edit tabs? The operation handlers can output static content or forms: they can output anything. One of the most powerful enhancements I made to this early on was to write an operations handler that outputs a view. It's the same idea as the <a href="http://drupal.org/project/eva">EVA</a> module.</p>
<p>So for the referendum canvassing application, I had a custom Campaign entity, that functioned as an Organic Group, and had as UI tabs several different views of members, views of contacts in the Campaign's geographic area, views of Campaign group content (such as tasks and contact lists), and so on.</p>
<p>This approach proved very flexible and quick. The group content entities were themselves also built with this, so that, for example, Contact List entities had operations for a user to book the entity, input data, and release it when done working on it. These were built with custom operation handlers specific to the Contact List entity, subclassing the generic form operation handler.</p>
<p>An unexpected bonus to all this was how easy it was to expose form-based operations to Views Bulk Operations and Services (as 'targeted actions' on the entity). This allowed the booking and release operations to work in bulk on views, and also to be done via a mobile app over Services.</p>
<p>A final piece of icing on the cake was the addition of alternative operation handlers for entity forms that provide just a generic bare bones form that invokes Field API to attach field widgets. With these, the amount of code needed to build a custom entity type is reduced to just three functions:</p>
<ul>
<li>hook_entity_info(), to declare the entity type to Drupal core</li>
<li>hook_entity_operations_info(), to declare the operations that make up the UI</li>
<li><a href="https://www.drupal.org/node/2240921">callback_entity_access()</a>, which controls the access to the operations</li>
</ul>
<p>The module has a few further tricks up its sleeve. If you're using user permissions for your entities, there's a helper function to use in your hook_permission(), which creates permissions out of all the operations (so: 'edit foobar entities', 'book foobar entities', 'discombobulate foobar entities' and so on). The entity URI callback that Drupal core requires you to have can be taken care of by a helper callback which uses the entity's base path definition. There's a form builder that lets you easily embed form-based operations into the entity build, so that you can put the sort of operations that are single buttons ('publish', 'book', etc) on the entity rather than in a tab. And finally, the links to operation tabs can be added to a view as fields, allowing a list of entities with links to view, edit, book, discombobulate, and so on.</p>
<p>So what started as a way to simplify and remove repetitive code became a system for building a whole entity-based UI, which ended up powering the whole of the application.</p>
</div>
      
  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="https://joachim-n.github.io//blog/graphing-relationships-between-entity-types" rel="bookmark">
<span>Graphing relationships between entity types</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Sun, 08/31/2014 - 21:00
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>Another thing that was developed as a result of my big Commerce project (see <a href="http://www.noreiko.com/blog/ripple-effect">my previous blog post for the run-down of the various modules this contributed back to Drupal</a>) was a bit of code for generating a graph that represents the relationships between entity types.</p>
<p>For a site with a lot of entityreference fields it's a good idea to draw diagrams before you get started, to figure out how everything ties together. But it's also nice to have a diagram that's based on what you've built, so you can compare it, and refer back to it (not to mention that it's a lot easier to read than my handwriting).</p>
<p>The code for this never got released; I tried various graph engines that work with <a href="https://www.drupal.org/project/graphapi">Graph API</a>, but none of them produced quite what I was hoping for. It just sat in my local copy of Field Tools for the last couple of years (I didn't even make a git branch for it, that shows how rough it was!). Then yesterday I came across the <a href="http://sigmajs.org/">Sigma.js graph library</a>, and that inspired me to dig out the code and finish it off.</p>
<p>To give the complete picture, I've added support for the relationships that are formed between entity types by their schema fields: things like the uid property on a node. These are easily picked out of hook_schema()'s foreign keys array.</p>
<p>In the end, I found Sigma.js wasn't the right fit: it looks very pretty, but it expects you to dictate the position of the nodes in the canvass, which for a generated graph doesn't really work. There is a plugin for it that allows the graph to be force-directed, but that was starting to be too fiddly. Instead though, I found <a href="http://getspringy.com/">Springy</a>, that while maybe not quite as versatile, automatically lays out the graph nodes out of the box. It didn't take too long to write <a href="https://www.drupal.org/sandbox/joachim/2330333">a library module for using Springy with Graph API</a>.</p>
<p>Here's the result:</p>
<p><img src="sites/default/files/article/image/field-tools-graph-springy_0.png" width="785" height="487" alt="Graph showing relationships between entity types on a development Drupa site"></p>
<p>Because this uses Graph API, it'll work with any graph engine, not just Springy. So I'll be interested to see what people who are more familiar with graphing can make it do. To get something that looks like the above for your site, it's simple: install the 7.x-1.x-dev release of <a href="http://drupal.org/project/field_tools">Field Tools</a>, install <a href="https://www.drupal.org/project/graphapi">Graph API</a>, install <a href="https://www.drupal.org/sandbox/joachim/2330333">the Springy module</a>, and follow the instructions in the README of that last module for installing the Springy Javascript library.</p>
<p>The next stage of development for this tool is figuring out a nice way of showing entity bundles. After all, entityreference fields are on specific bundles, and may point to only certain bundles. However, they sometimes point to all bundles of an entity type. And meanwhile, schema properties are always on all bundles and point to all bundles. How do we represent that without the graph turning into a total mess? I'm pondering adding a form that lets you pick which entity types should be shown as separate bundles, but it's starting to get complicated. If you have any thoughts on this, or other ways to improve this feature, please share them with me in the Field Tools issue queue!</p>
</div>
      
  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="https://joachim-n.github.io//blog/getting-module-builder-ready-drupal-8" rel="bookmark">
<span>Getting Module Builder ready for Drupal 8</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Tue, 08/19/2014 - 08:12
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>I've just made a commit to <a href="https://www.drupal.org/project/module_builder">Module Builder</a> that adds unit tests. This is a big deal, because having these frees me up to start making the big changes that are needed for supporting Drupal 8's new structures: routes, plugins, forms, and so on.</p>
<p>The biggest challenge is going to be the interface. Currently, you give Module Builder just a module name and a list of hook names, and it does the necessary. On the command line it's nice and simple:</p>
<div class="codeblock"><code>drush mb mymodule install schema node_insert form_alter views_data_alter</code></div>
<p>The first parameter is the module name, and everything that follows is a hook name. Now we add to the mix requests such as a form called MyModuleCakeToppingForm, or an entity type plugin, or a route bake_my_cake and its page controller. How to elegantly specify all that over the command line, without making it horribly unwieldy and impossible to remember how to use?</p>
<p>It's also going to be an interesting exercise in reading my own documentation and seeing how much sense it makes after something like 7 months away from the code.</p>
<p>From what I recall, Module Builder uses a hierarchy of component generators to build your module. Taking our example above, the first thing that happens is that the Module generator class kicks in. 'So, you want a module, do you?' it asks, 'You'll need some of these.' And it begins to assemble a list of further generators, for the components it needs: an info file, and the hooks generator. The hooks generator does the actual job of examining your list of requested hooks, and decides based on that that you need three code files: a .module, a .install, and a .views.inc. So by now we have a tree of generators like this:</p>
<pre>
- Module
-- Info file
-- Hooks
--- Code file: .module
--- Code file: .install
--- Code file: .views.inc
</pre><p>
This is not a class hierarchy; this is a tree of objects where each generator has a list of the generators beneath it, and is responsible for collecting data from them. Once we have the tree, we iteratively have each generator assemble the data it wants to contribute, starting with the Module generator at the top.</p>
<p>The original plan when I wrote this system was to make the smallest granularity be a file. The leaves of the generator tree would assemble the text for their file's contents, and the Module generator would collect the files up and return them to the caller for output (either in the UI, or to write them directly).</p>
<p>However, while the original intention of this system was that it could be generalised to base components other than modules (so profiles and themes, which are both supported to some extend but lack the UI, see above!), it's also proven to be extendable downwards to smaller components, and to be worthwhile to do so.</p>
<p>Enter the Form generator. Once we have a generic Function generator (and its child class the HookImplementation), we can create a Form generator. Given a form machine name, 'foo_form', it simply knows to add three copies of the Function generator: 'foo_form', 'foo_form_validate', 'foo_form_submit', along with the correct parameters and some boiler plate code.</p>
<p>And we can specialize this further: the AdminSettingsForm simply extends the Form generator, and adds a menu item component, which itself ensures hook_menu() is requested.</p>
<p>At this point it starts to get a bit complicated, as we have components that request other components that are in totally different parts of the component tree. That's the point at which I think I was when I realized I needed tests so that I can refactor and clean up the messy bits of this, and enhance and extend it, without breaking what's already there.</p>
<p>So that's the current state of Module Builder: not yet ready for Drupal 8, but has lots of potential. At this point, I'd really welcome input on the Drush interface, as that's the big quandary. And any input on new Drupal 8 component generators would be great too; there are a few open issues in the queue. And finally, Module Builder is a complex beast; should anyone looking at the code find it baffling and impenetrable, do please file a documentation issue to highlight the problem and request clarification.</p>
</div>
      
  </div>
  </article>
</div>

    </div>
  
        <nav class="pager layout--content-medium" role="navigation" aria-labelledby="pagination-heading">
    <h4 id="pagination-heading" class="visually-hidden">Pagination</h4>
    <ul class="pager__items js-pager__items">
                    <li class="pager__item pager__item--control pager__item--first"><a href="/" title="Go to first page" class="pager__link"><span class="visually-hidden">First page</span><svg xmlns="http://www.w3.org/2000/svg" width="15px" height="16px" viewBox="0 0 15 16"><path d="M5.1,7.2l8.3-6C14.1,0.7,15,1.1,15,2V14c0,0.8-0.9,1.3-1.6,0.8l-8.3-6C4.6,8.4,4.6,7.6,5.1,7.2z M0,0h2v16H0V0z"/></svg></a></li>      
                    <li class="pager__item pager__item--control pager__item--previous"><a href="/page/5" title="Go to previous page" rel="prev" class="pager__link"><span class="visually-hidden">Previous page</span><svg xmlns="http://www.w3.org/2000/svg" width="11" height="16" viewBox="0 0 11 16"><path d="M1.11201 7.19126L9.41183 1.15503C10.0728 0.674329 11 1.14648 11 1.96377V14.0362C11 14.8535 10.0728 15.3257 9.41183 14.845L1.11201 8.80874C0.562908 8.40939 0.562907 7.59061 1.11201 7.19126Z"/></svg></a></li>      
                    <li class="pager__item pager__item--ellipsis" role="presentation">&hellip;</li>
      
                    <li class="pager__item pager__item--number"><a href="/page/2" title="Go to page 2" class="pager__link"><span class="visually-hidden">
              Page
            </span>
            2
                          </a></li>              <li class="pager__item pager__item--number"><a href="/page/3" title="Go to page 3" class="pager__link"><span class="visually-hidden">
              Page
            </span>
            3
                          </a></li>              <li class="pager__item pager__item--number"><a href="/page/4" title="Go to page 4" class="pager__link"><span class="visually-hidden">
              Page
            </span>
            4
                          </a></li>              <li class="pager__item pager__item--number"><a href="/page/5" title="Go to page 5" class="pager__link"><span class="visually-hidden">
              Page
            </span>
            5
                          </a></li>              <li class="pager__item pager__item--active pager__item--number"><span class="visually-hidden">
              Current page
            </span>
            6
                      </li>              <li class="pager__item pager__item--number"><a href="/page/7" title="Go to page 7" class="pager__link"><span class="visually-hidden">
              Page
            </span>
            7
                          </a></li>              <li class="pager__item pager__item--number"><a href="/page/8" title="Go to page 8" class="pager__link"><span class="visually-hidden">
              Page
            </span>
            8
                          </a></li>              <li class="pager__item pager__item--number"><a href="/page/9" title="Go to page 9" class="pager__link"><span class="visually-hidden">
              Page
            </span>
            9
                          </a></li>              <li class="pager__item pager__item--number"><a href="/page/10" title="Go to page 10" class="pager__link"><span class="visually-hidden">
              Page
            </span>
            10
                          </a></li>      
                    <li class="pager__item pager__item--ellipsis" role="presentation">&hellip;</li>
      
                    <li class="pager__item pager__item--control pager__item--next"><a href="/page/7" title="Go to next page" rel="next" class="pager__link"><span class="visually-hidden">Next page</span><svg xmlns="http://www.w3.org/2000/svg" width="11" height="16" viewBox="0 0 11 16"><path d="M1.11201 7.19126L9.41183 1.15503C10.0728 0.674329 11 1.14648 11 1.96377V14.0362C11 14.8535 10.0728 15.3257 9.41183 14.845L1.11201 8.80874C0.562908 8.40939 0.562907 7.59061 1.11201 7.19126Z"/></svg></a></li>      
                    <li class="pager__item pager__item--control pager__item--last"><a href="/page/21" title="Go to last page" class="pager__link"><span class="visually-hidden">Last page</span><svg xmlns="http://www.w3.org/2000/svg" width="15px" height="16px" viewBox="0 0 15 16"><path d="M5.1,7.2l8.3-6C14.1,0.7,15,1.1,15,2V14c0,0.8-0.9,1.3-1.6,0.8l-8.3-6C4.6,8.4,4.6,7.6,5.1,7.2z M0,0h2v16H0V0z"/></svg></a></li>          </ul>
  </nav>

              <div class="feed-icons">
      


<a href="https://joachim-n.github.io//blog.xml" class="feed-icon">
  <span class="feed-icon__label">
    Blog
  </span>
  <span class="feed-icon__icon" aria-hidden="true">
    <svg xmlns="http://www.w3.org/2000/svg" width="14.2" height="14.2" viewBox="0 0 14.2 14.2">
  <path d="M4,12.2c0-2.5-3.9-2.4-3.9,0C0.1,14.7,4,14.6,4,12.2z M9.1,13.4C8.7,9,5.2,5.5,0.8,5.1c-1,0-1,2.7-0.1,2.7c3.1,0.3,5.5,2.7,5.8,5.8c0,0.7,2.1,0.7,2.5,0.3C9.1,13.7,9.1,13.6,9.1,13.4z M14.2,13.5c-0.1-3.5-1.6-6.9-4.1-9.3C7.6,1.7,4.3,0.2,0.8,0c-1,0-1,2.6-0.1,2.6c5.8,0.3,10.5,5,10.8,10.8C11.5,14.5,14.3,14.4,14.2,13.5z"/>
</svg>
  </span>
</a>

    </div>
  </div>
</div>

    </div>
  </div>

  </div>

              </main>
                        
          </div>
        </div>
        <div class="social-bar">
          
        </div>
      </div>
    </div>

    <footer class="site-footer">
      <div class="site-footer__inner container">
        

  <div class="region region--footer-top grid-full layout--pass--content-medium">
    <div class="region--footer_top__inner">
      

<div id="block-joachim-blog-theme-powered" class="block block-system block-system-powered-by-block">
  
    
    
  <span>
    Powered by    <a href="https://www.drupal.org">Drupal</a>
    <span class="drupal-logo" role="img" aria-label="Drupal Logo">
      <svg width="14" height="19" viewBox="0 0 42.15 55.08" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M29.75 11.73C25.87 7.86 22.18 4.16 21.08 0 20 4.16 16.28 7.86 12.4 11.73 6.59 17.54 0 24.12 0 34a21.08 21.08 0 1042.15 0c0-9.88-6.59-16.46-12.4-22.27zM10.84 35.92a14.13 14.13 0 00-1.65 2.62.54.54 0 01-.36.3h-.18c-.47 0-1-.92-1-.92-.14-.22-.27-.45-.4-.69l-.09-.19C5.94 34.25 7 30.28 7 30.28a17.42 17.42 0 012.52-5.41 31.53 31.53 0 012.28-3l1 1 4.72 4.82a.54.54 0 010 .72l-4.93 5.47zm10.48 13.81a7.29 7.29 0 01-5.4-12.14c1.54-1.83 3.42-3.63 5.46-6 2.42 2.58 4 4.35 5.55 6.29a3.08 3.08 0 01.32.48 7.15 7.15 0 011.3 4.12 7.23 7.23 0 01-7.23 7.25zM35 38.14a.84.84 0 01-.67.58h-.14a1.22 1.22 0 01-.68-.55 37.77 37.77 0 00-4.28-5.31l-1.93-2-6.41-6.65a54 54 0 01-3.84-3.94 1.3 1.3 0 00-.1-.15 3.84 3.84 0 01-.51-1v-.19a3.4 3.4 0 011-3c1.24-1.24 2.49-2.49 3.67-3.79 1.3 1.44 2.69 2.82 4.06 4.19a57.6 57.6 0 017.55 8.58A16 16 0 0135.65 34a14.55 14.55 0 01-.65 4.14z"/>
</svg>
    </span>
  </span>
</div>

    </div>
  </div>

        
      </div>
    </footer>

    <div class="overlay" data-drupal-selector="overlay"></div>

  </div>
</div>

  </div>

    
    <script type="application/json" data-drupal-selector="drupal-settings-json">{"path":{"baseUrl":"\/","pathPrefix":"","currentPath":"blog","currentPathIsAdmin":false,"isFront":true,"currentLanguage":"en","currentQuery":{"page":"5"}},"pluralDelimiter":"\u0003","suppressDeprecationErrors":true,"user":{"uid":0,"permissionsHash":"01dd47ecd9bcd15f4ce2dda67f9266a98e8b92ff7b9c64558fb5367373af7d61"}}</script>
<script src="/sites/default/files/js/js_8VAq5rHg72u4MA8hrGwHx9Lz8WNC8wFO7od1Rvg4xTA.js?scope=footer&amp;delta=0&amp;language=en&amp;theme=joachim_blog_theme&amp;include=eJxLzk9JTcvMKUkt0k-GM3Wy8hOTMzJz45Ny8tPjSzJSc1P103PykxJzdItLKnMy89IBYRsVxQ"></script>

  </body>
</html>
