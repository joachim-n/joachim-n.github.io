<!DOCTYPE html>
<html lang="en" dir="ltr" style="--color--primary-hue:202;--color--primary-saturation:79%;--color--primary-lightness:50">
  <head>
    <meta charset="utf-8" />
<meta name="Generator" content="Drupal 10 (https://www.drupal.org)" />
<meta name="MobileOptimized" content="width" />
<meta name="HandheldFriendly" content="true" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="icon" href="/themes/custom/joachim_blog_theme/favicon.ico" type="image/vnd.microsoft.icon" />

    <title>Joachim&#039;s blog</title>
    <link rel="stylesheet" media="all" href="/sites/default/files/css/css_ihN9gV-WXsqs_8HEEt45YyjirGu6jPu5ot_R6_FnoJc.css?delta=0&amp;language=en&amp;theme=joachim_blog_theme&amp;include=eJxtiksOgCAQxS4EciTD54no4Bhm1HB7jQtXbpqmaeSEqZCiufipWdjHudQxEOdRZ1S4TBw8WdFOZct_x84XGpIN3T41rn-P-ixGuiiqC15gzoJL3MuhcjoIN22tOQY" />
<link rel="stylesheet" media="all" href="/sites/default/files/css/css_FfI1KBxjzizfquKZc-UBRYzejEfzH7TlH2sPqJxC3Hk.css?delta=1&amp;language=en&amp;theme=joachim_blog_theme&amp;include=eJxtiksOgCAQxS4EciTD54no4Bhm1HB7jQtXbpqmaeSEqZCiufipWdjHudQxEOdRZ1S4TBw8WdFOZct_x84XGpIN3T41rn-P-ixGuiiqC15gzoJL3MuhcjoIN22tOQY" />

    
    
<link rel="preload" href="/themes/custom/joachim_blog_theme/fonts/metropolis/Metropolis-Regular.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/themes/custom/joachim_blog_theme/fonts/metropolis/Metropolis-SemiBold.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/themes/custom/joachim_blog_theme/fonts/metropolis/Metropolis-Bold.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/themes/custom/joachim_blog_theme/fonts/lora/lora-v14-latin-regular.woff2" as="font" type="font/woff2" crossorigin>
    <noscript><link rel="stylesheet" href="/themes/custom/joachim_blog_theme/css/components/navigation/nav-primary-no-js.css?sspisc" />
</noscript>
  </head>
  <body class="path-test-everything">
        <a href="#main-content" class="visually-hidden focusable skip-link">
      Skip to main content
    </a>
    
      <div class="dialog-off-canvas-main-canvas" data-off-canvas-main-canvas>
    
<div id="page-wrapper" class="page-wrapper">
  <div id="page">

          <header id="header" class="site-header" data-drupal-selector="site-header" role="banner">

                <div class="site-header__fixable" data-drupal-selector="site-header-fixable">
          <div class="site-header__initial">
            <button class="sticky-header-toggle" data-drupal-selector="sticky-header-toggle" role="switch" aria-controls="site-header__inner" aria-label="Sticky header" aria-checked="false">
              <span class="sticky-header-toggle__icon">
                <span></span>
                <span></span>
                <span></span>
              </span>
            </button>
          </div>

                    <div id="site-header__inner" class="site-header__inner" data-drupal-selector="site-header-inner">
            <div class="container site-header__inner__container">

              


<div id="block-joachim-blog-theme-site-branding" class="site-branding block block-system block-system-branding-block">
  
    
    <div class="site-branding__inner">
              <div class="site-branding__text">
        <div class="site-branding__name">
          <a href="/" title="Home" rel="home">Joachim&#039;s blog</a>
        </div>
      </div>
      </div>
</div>
<nav  id="block-joachim-blog-theme-main-menu" class="primary-nav block block-menu navigation menu--main" aria-labelledby="block-joachim-blog-theme-main-menu-menu" role="navigation">
            
  <h2 class="visually-hidden block__title" id="block-joachim-blog-theme-main-menu-menu">Main navigation</h2>
  
        
          <ul  class="menu menu--level-1">
            
                          
        
        
        <li class="menu__item menu__item--link menu__item--level-1">
                    
          <a href="/" class="menu__link menu__link--link menu__link--level-1" data-drupal-link-system-path="&lt;front&gt;">Home</a>

          
        </li>
      
                          
        
        
        <li class="menu__item menu__item--link menu__item--level-1">
                    
          <a href="/about" class="menu__link menu__link--link menu__link--level-1" data-drupal-link-system-path="node/1">About</a>

          
        </li>
          </ul>
  


  </nav>

<div class="header-nav-overlay" data-drupal-selector="header-nav-overlay"></div>


                          </div>
          </div>
        </div>
      </header>
    
    <div id="main-wrapper" class="layout-main-wrapper layout-container">
      <div id="main" class="layout-main">
        <div class="main-content">
          <a id="main-content" tabindex="-1"></a>
          
          <div class="main-content__container container">
            

  <div class="region region--highlighted grid-full layout--pass--content-medium">
    <div data-drupal-messages-fallback class="hidden messages-list"></div>

  </div>

            

  <div class="region region--breadcrumb grid-full layout--pass--content-medium">
    

<div id="block-joachim-blog-theme-breadcrumbs" class="block block-system block-system-breadcrumb-block">
  
    
      <div class="block__content">
        <nav class="breadcrumb" role="navigation" aria-labelledby="system-breadcrumb">
    <h2 id="system-breadcrumb" class="visually-hidden">Breadcrumb</h2>
    <div class="breadcrumb__content">
      <ol class="breadcrumb__list">
                  <li class="breadcrumb__item">
                          <a href="/" class="breadcrumb__link">Home</a>
                      </li>
              </ol>
    </div>
  </nav>

    </div>
  </div>

  </div>


                          <main role="main">
                

  <div class="region region--content-above grid-full layout--pass--content-medium">
    

<div id="block-joachim-blog-theme-page-title" class="block block-core block-page-title-block">
  
  



  
</div>

  </div>

                

  <div class="region region--content grid-full layout--pass--content-medium" id="content">
    

<div id="block-joachim-blog-theme-content" class="block block-system block-system-main-block">
  
    
      <div class="block__content">
      <div class="views-element-container"><div class="view view-test-everything view-id-test_everything view-display-id-page_1 js-view-dom-id-313d4c96e618d1408306dea0f289136ed2d417ddf4d86fa4891d0eecfb604038">
  
    
      
      <div class="view-content">
          <div class="views-row">

<article class="node node--type-article grid-full node--promoted node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/i-would-sme-fucking-content" rel="bookmark">
<span>I would like sme fucking content</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>admin</span></span>, Thu, 06/05/2025 - 17:12
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item">xfsdfsd</div>
      
  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--promoted node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/changing-your-mind-about-dependency-injection" rel="bookmark">
<span>Changing your mind about dependency injection</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Thu, 10/24/2024 - 11:25
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>When I start writing a class that has a dependency injection, I have a clear idea about which services it needs. I generate it -- the plugin, form, controller, or service -- and specify those services.</p>
<p>Then nearly always, unless it's something really very simple, I find that no matter how much I thought about it and planned it, I need to add more services. Maybe remove some too.</p>
<p>Fortunately, because Module Builder saves the configuration of the module code you've generated, it's easy to go back to it and edit it to add more services:</p>
<ol>
<li>Edit your module in Module Builder</li>
<li>Add to the injected services for your component</li>
<li>Ensure your code file is committed to version control</li>
<li>Generate the code, and write the updated version of the code file</li>
<li>Add and commit the new DI code, while discarding the changes that remove your code. (I find it helps to use a git GUI for things like this, though <code>git add -p</code> works too.)</li>
</ol>
<p>But I tend to find that I make this mistake several times as the class develops, and so I adopt the approach of using the <code>\Drupal::service()</code> function to get my services, and only when I'm fairly confident I'm not going to need to make any more changes to DI, I update the injected services in one go, converting all the service calls to use the service properties.</p>
<p>I was asked yesterday at Drupal Drinks about how to do that, and it occurred to me that there's a way of doing this so after you've updated the dependency injection with Module Builder, it's a simple find and replace to update your code.</p>
<p>If you write your code like this whenever you need a service:</p>
<pre><code>$service_entityTypeManager = \Drupal::service('entity_type.manager');
$stuff = $service_entityTypeManager-&gt;doSomething();
</code></pre>
<p>Then you need to do only two find and replace operations to convert this to DI:</p>
<ol>
<li>Replace <code>'^.+Drupal::service.+\n'</code> with <code>''</code>. This removes all the lines where you get the service from the Drupal class.</li>
<li>Replace <code>'\$service_(\w+)'</code> with <code>'$this-&gt;$1'</code>. This replaces all the service variables
with the class property.</li>
</ol>
<p>Up until now I'd been calling the service variables something like <code>$entityTypeManager</code> so that I could easily change that to <code>$this-&gt;entityTypeManager</code> manually, but prefixing the variable name with a camel case <code>'service_'</code> gives you something to find with a regular expression.</p>
<p>If you want to be really fancy, you can use a regular expression like <code>'(?&lt;=::service..)[\w.]+'</code> (using dots to avoid having to escape the open bracket and the quote mark) to find all the services that you need to add to the class's dependency injection.</p>
<p>Something like this:</p>
<pre><code>$ ag -G MyClass.php '(?&lt;=::service..)[\w.]+' -o --nonumbers --nofilename | sort | uniq | tr "\n" ", "
</code></pre>
<p>will give you a list of service names that you can copy-paste into the Module Builder form. This is probably overkill for something you can do pretty quickly with the search in a text editor or IDE, but it's a nice illustration of the power of unix tools: <code>ag</code> has options to output just the found text, then <code>sort</code> and <code>uniq</code> eliminate duplicates, and finally <code>tr</code> turns it into a comma-separated list.</p></div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/68" hreflang="en">dependency injection</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/56" hreflang="en">drupal code builder</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/8" hreflang="en">module builder</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/refactoring-rector" rel="bookmark">
<span>Refactoring with Rector</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Fri, 05/03/2024 - 20:47
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>Rector is a tool for making changes to PHP code, which powers tools that assist with upgrading deprecated code in Drupal. When I recently made some refactoring changes in Drupal Code Builder, which were too complex to do with search and replace regexes, it seemed like a good opportunity to experiment with Rector, and learn a bit more about it.</p>
<p>Besides, I'm an inveterate condiment-passer: I tend to prefer spending longer on a generalisation of a problem than on the problem itself, and the more dull the problem and the more interesting the generalisation, the more the probability increases.</p>
<p>So faced with a refactoring from this return from the <code>getFileInfo()</code> method:</p>
<pre><code>    return [
      'path' =&gt; '',
      'filename' =&gt; $this-&gt;component_data['filename'],
      'body' =&gt; $body,
      'merged' =&gt;$merged,
    ];
</code></pre>
<p>to this:</p>
<pre><code>    return new CodeFile(
      body_pieces: $body,
      merged: $merged,
    );
</code></pre>
<p>which was going to be tedious as hell to do in a ton of files, obviously, I elected to spend time fiddling with Rector.</p>
<p>The first thing I'll say is that the same sort of approach as I use with migrations works well: work with a small indicative sample, and iterate small changes. With a migration, I will find a small number of source rows which represent different variations (or if there is too much variation, I'll iterate the iteration multiple times). I'll run the migration with just those sources, examine the result, make refinements to the migration, then roll back and repeat.</p>
<p>With Rector, you can specify just a single class in the code that registers the rule to RectorConfig in the rector.php file, so I picked a class which had very little code, as the dump() output of an entire PHP file's PhpParser analysis is enormous.</p>
<p>You then use the rule class's <code>getNodeTypes()</code> method to declare which node types you are interested in. Here, I made a mis-step at first. I wanted to replace Array_ nodes, but only in the <code>getFileInfo()</code> method. So in my first attempt, I specified ClassMethod nodes, and then in <code>refactor()</code> I wrote code to drill down into them to get the array Array_ nodes. This went well until I tried returning a new replacement node, and then Rector complained, and I realised the obvious thing I'd skipped over: the <code>refactor()</code> method expects you to return a node to replace the found node. So my approach was completely wrong.</p>
<p>I rewrote <code>getNodeTypes()</code> to search for <code>Array_</code> nodes: those represent the creation of an array value. This felt more dangerous: arrays are defined in lots of places in my code! And I haven't been able to see a way to determine the parentage of a node: there do not appear to be pointers that go back up the PhpParser syntax tree (it would be handy, but would make the dump() output even worse to read!). Fortunately, the combination of array keys was unique in DrupalCodeBuilder, or at least I hoped it was fairly unique. So I wrote code to get a list of the array's keys, and then compare it to what was expected:</p>
<pre><code>        foreach ($node-&gt;items as $item) {
            $seen_array_keys[] = $item-&gt;key-&gt;value;
        }
        if (array_intersect(static::EXPECTED_MINIMUM_ARRAY_KEYS, $seen_array_keys) != static::EXPECTED_MINIMUM_ARRAY_KEYS) {
            return NULL;
        }
</code></pre>
<p>Returning NULL from <code>refactor()</code> means we aren't interested in this node and don't want to change it.</p>
<p>With the arrays that made it through the filter, I needed to make a new node that's a class instantiation, to replace the array, passing the same values to the <code>new</code> statement as the array keys (mostly).</p>
<p>Rector's <a href="https://github.com/rectorphp/php-parser-nodes-docs">list of commonly used PhpParser nodes</a> was really useful here.</p>
<p>A <code>new</code> statement node is made thus:</p>
<pre><code>use PhpParser\Node\Name;
use PhpParser\Node\Expr\New_;

        $class = new Name('\DrupalCodeBuilder\File\CodeFile');
        return new New_($class);
</code></pre>
<p>This doesn't have any parameters yet, but running Rector on this with my sample set showed me it was working properly. Rector has a dry run option for development, which shows you what would change but doesn't write anything to files, so you can run it over and over again. What's confusing is that it also has a cache; until I worked this out I was repeatedly confused by some runs having no effect and no output. I have honestly no idea what the point is of caching something that's designed to make changes, but there is an option to disable it. So the command to run is: <code>$ vendor/bin/rector --dry-run --clear-cache</code>. Over and over again.</p>
<p>Once that worked, I needed to convert array items to constructor parameters. Fortunately, the value from the array items work for parameters too:</p>
<pre><code>use PhpParser\Node\Arg;

        foreach ($node-&gt;items as $array_item) {
                $construct_argument = new Arg(
                   $array_item-&gt;value,
                );
</code></pre>
<p>That gave me the values. But I wanted named parameters for my constructor, partly because they're cool and mostly because the CodeFile class's <code>__construct()</code> has optional parameters, and using names makes that simpler.</p>
<p>Inspecting the <code>Arg</code> class's own constructor showed how to do this:</p>
<pre><code>use PhpParser\Node\Arg;
use PhpParser\Node\Identifier;

                $construct_argument = new Arg(
                    value: $array_item-&gt;value,
                    name: new Identifier($key),
                );
</code></pre>
<p>Using named parameters here too to make the code clearer to read!</p>
<p>It's also possible to copy over any inline comments that are above one node to a new node:</p>
<pre><code>            // Preserve comments.
            $construct_argument-&gt;setAttribute('comments', $array_item-&gt;getComments());
</code></pre>
<p>The constructor parameters are passed as a parameter to the <code>New_</code> class:</p>
<pre><code>        return new New_($class, $new_call_args);
</code></pre>
<p>Once this was all working, I decided to do some more refactoring in the CodeFile class in DrupalCodeBuilder. The changes I was making with Rector made it more apparent that in a lot of cases, I was passing empty values. Also, the <code>$body</code> parameter wasn't well-named, as it's an array of pieces, so could do with a more descriptive name such as <code>$body_pieces</code>.</p>
<p>Changes like this are really easy to do (though by this point, I had made a git repository for my Rector rule, so I could make further enhancements without breaking what I'd got working already).</p>
<pre><code>        foreach ($node-&gt;items as $array_item) {
            $key = $array_item-&gt;key-&gt;value;

            // Rename the 'body' key.
            if ($key == 'body') {
                $key = 'body_pieces';
            }
</code></pre>
<p>And that's my Rector rule done.</p>
<p>Although it's taken me far more time than changing each file by hand, it's been far more interesting, and I've learned a lot about how Rector works, which will be useful to me in the future. I can definitely see how it's a very useful tool even for refactoring a small codebase such as DrupalCodeBuilder, where a rule is only going to be used once. It might even prompt me to undertake some minor refactoring tasks I've been putting off because of how tedious they'll be.</p>
<p>What I've not figured out is how to extract namespaces from full class names to an import statement, or how to put line breaks in the <code>new</code> statement. I'm hoping that a pass through with PHP_CodeSniffer and Drupal Coder's rules will fix those. If not, there's always good old regexes!</p></div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/65" hreflang="en">refactoring</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/66" hreflang="en">Rector</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/67" hreflang="en">PhpParser</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/56" hreflang="en">drupal code builder</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/defining-bundle-fields-code" rel="bookmark">
<span>Defining bundle fields in code</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Mon, 01/31/2022 - 17:14
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>Fields in Drupal 9 can be defined in code, or they can be defined in configuration. Both techniques have their uses and advantages. Typically code fields apply to all bundles of the entity type, as so-called base fields, while config fields apply only to a single bundle.</p>
<p>But there is a way to have code fields which apply only to specific bundles: these are called bundle fields. These are particularly useful for adding computed fields to specific bundles of an entity (more on computed fields in a future blog post).</p>
<p>The API for these is a bit clunky, as it wasn't finalised for Drupal 8, and it may in fact be <a href="https://www.drupal.org/node/2346347">completely changed in the future</a>. If that causes you apprehension at implementing bundle fields in your code, it's worth mentioning that the last patch on that issue was in 2017: it's a complex problem without many applications, so accordingly doesn't get much attention.</p>
<p>Bundle fields need to be defined in two places: the field storage, and field definition itself. This is similar to how config fields work; it's actually the
same as base fields, but the BaseFieldDefinition hides this from you as it does double duty. (There is <a href="https://www.drupal.org/project/drupal/issues/2980922">an issue to remove the need to define the storage</a>, but again, not much happening there.)</p>
<p>You also need a field definition class. The <a href="https://www.drupal.org/project/entity">entity contrib module</a> provides a BundleFieldDefinition class, but if you don't want to install that module just for a single class, <a href="https://git.drupalcode.org/project/entity/-/blob/8.x-1.x/src/BundleFieldDefinition.php">copy-pasting that class</a> to your custom module is fine too.</p>
<p>(There is a class in core FieldDefinition, which was
<a href="https://www.drupal.org/node/2982512">added for this purpose</a>, however, that requires a storage class to work alongside it, and <a href="https://www.drupal.org/node/2280639">the issue to provide that</a> has not yet been fixed.)</p>
<p>Once you have that class, how you define the field depends on the entity you're adding it to.</p>
<h3>Bundle fields on your own entity type</h3>
<p>In your own entity type, you define the entity class. You can therefore implement the bundleFieldDefinitions() method in that class:</p>
<pre><code>  // In MyEntity class:
  /**
   * {@inheritdoc}
   */
  public static function bundleFieldDefinitions(EntityTypeInterface $entity_type, $bundle, array $base_field_definitions) {
    $definitions = [];

    if ($bundle == 'mybundle') {
      $definitions['myfield'] = BundleFieldDefinition::create('entity_reference')
        // This is essential: the array key is NOT used as the field machine name,
        // so it MUST be specified here!
        -&gt;setName('myfield')
        // These two are essential: they define the entity type and the bundle
        // that the field is on.
        -&gt;setTargetEntityTypeId($entity_type-&gt;id())
        -&gt;setTargetBundle($bundle)
        // Further define the field as you would with a base field.
        -&gt;setLabel(t('Label'))
        -&gt;setDescription(t('Description.'));
    }

    return $definitions;
  }
</code></pre>
<p>That defines the field. Because these are bundle fields, the storage must be
defined separately in hook_entity_field_storage_info(). However, we can take
advantage of the BundleFieldDefinition class doing double duty as a storage
and a field, and piggy-back on the definition in the entity class:</p>
<pre><code>/**
 * Implements hook_entity_field_storage_info().
 */
function mymodule_entity_field_storage_info(EntityTypeInterface $entity_type) {
  // Entity bundle fields need to declare their storage separately. However, we
  // can piggyback on the field definition itself, since the
  // BundleFieldDefinition class does double duty as field and storage
  // definition since it extends from BaseFieldDefinition.
  // We cheat on the parameters we pass in, as the entity's
  // bundleFieldDefinitions() method expects a list of base field definitions,
  // but we have none here to give. For our purposes, bundleFieldDefinitions()
  // does not need them.
  if ($entity_type-&gt;id() == 'myentity') {
    return MyEntity::bundleFieldDefinitions($entity_type, 'mybundle', []);
  }
}
</code></pre>
<p>The documentation for hook_entity_bundle_field_info() suggests you do it the other way round,
and define the storage first, then derive the field from the storage, but doing it in the way shown above means that the code for your field is in
your entity class where it's alongside the base field definition, and more easily discoverable.</p>
<h3>Bundle fields on someone else's entity type</h3>
<p>For an entity type you don't control, you could switch the entity class to a
custom subclass and implement bundleFieldDefinitions() in that, but it's simpler to use hook_entity_bundle_field_info().</p>
<pre><code>/**
 * Implements hook_entity_bundle_field_info().
 */
function mymodule_entity_bundle_field_info(EntityTypeInterface $entity_type, $bundle, array $base_field_definitions) {
  if ($entity_type-&gt;id() == 'myentity' &amp;&amp; $bundle == 'mybundle') {
    $fields = [];
    $fields['myfield'] = BundleFieldDefinition::create('list_integer')
      // This is essential: the array key is NOT used as the field machine name,
      // so it MUST be specified here!
      -&gt;setName('myfield')
      // These two are essential: they define the entity type and the bundle
      // that the field is on.
      -&gt;setTargetEntityTypeId($entity_type-&gt;id())
      -&gt;setTargetBundle($bundle)
      // Further define the field as you would with a base field.
      -&gt;setLabel(t('Label'))
      -&gt;setDescription(t('Description.'));

    return $fields;
  }
}

/**
 * Implements hook_entity_field_storage_info().
 */
function mymodule_entity_field_storage_info(EntityTypeInterface $entity_type) {
  if ($entity_type-&gt;id() == 'myentity') {
    return mymodule_entity_bundle_field_info($entity_type, 'mybundle', []);
  }
}
</code></pre>
<p>We use the same piggybacking trick here. In the case of altering someone else's entity type,
it makes just as much sense to define the storage and derive the field, but following the same pattern as the
custom entity keeps the two methods matching.</p>
<p>As you can see, this is an area of Drupal's entity system which is unfortunately incomplete,
and liable to change in the future. Nonetheless, the usefulness of bundle fields means that it's worth using them. Just be sure to document your code so future developers (who might be you!)
know that it's area of the code that may need maintainance when the API is updated. And keep an eye on the Drupal core change records!</p></div>
      
  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/commit-your-composer-managed-files-version-control" rel="bookmark">
<span>Commit your Composer-managed files to version control</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Tue, 04/20/2021 - 08:46
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>According to the Composer documentation, you shouldn't commit to version control
any of the files in packages that are managed by Composer. For a Drupal project,
that means the following folders are not in your git repository:</p>
<ul>
<li>vendor</li>
<li>web/core</li>
<li>web/modules/contrib</li>
</ul>
<p>Bluntly, I think this is the wrong thing to do. Doing the exact opposite saves you time, effort, heartache, and energy.</p>
<p>Let's start by comparing the two workflows.</p>
<h2>Composer-recommended workflow: the wrong way</h2>
<ol>
<li>Alice, the developer, updates some packages in her local dev.</li>
<li>She commits only the composer.json and composer.lock files.</li>
<li>Bob pulls changes, and runs <code>composer install</code> to update his local dev.</li>
<li>When the project is deployed, the server needs to run <code>composer install</code> as part of the deployment process.</li>
</ol>
<h2>Git-managed workflow: the right way</h2>
<ol>
<li>Alice, the developer, updates some packages in her local dev.</li>
<li>She commits all the new and changed files.</li>
<li>Bob pulls changes.</li>
<li>When the project is deployed... it's deployed. All the files necessary to run the app are in git, and so updating the server's git clone gives it all the files.</li>
</ol>
<p>The first reason this workflow is better should jump out: developers save time. Git is much faster and pulling files from a repository than Composer is at resolving, downloading, and installing packages. Switching git branches is fast, even when a lot of files change. Having to run Composer because one branch has package updates on it and the other doesn't, or has different ones, is a waste of developer time.</p>
<p>The second reason is related: save time in deployment. That's not just developer time, that's time your production server is down.</p>
<p>The third reason is more philosophical: Composer is not a <em>file</em> management tool. It's a <em>dependency</em> management tool. Let Composer do what it does well, which is figuring out which versions of which packages should be installed. Let git handle what it does well, which is synchronizing different copies of a codebase. Purists may point out that git is a version control tool, not a file management tool: that's a valid point, but doesn't diminish my argument: commit all files, and then use rsync or whatever to get the files from a git clone to the server.</p>
<p>Related to this: don't make your webserver do package management work; that's not its job. And don't make Bob repeat the work Alice already did.</p>
<p>Finally, committing files to git puts them under version control. That's merely stating the obvious, but putting files under version control has many benefits.</p>
<ul>
<li>
<p>IDEs typically ignore git-ignored files for things like searching and code analysis. On my IDE at least (VSCode), disabling that means it then wants to include things like the uploaded files folder.</p>
</li>
<li>
<p>Similarly, search tools such as <code>ag</code> and <code>ack</code> take <code>.gitignore</code> files into account, and having to override that robs you of useful behaviour.</p>
</li>
<li>
<p>Finally, files under version control are easier to debug and tinker with. I for one often go digging in core or contrib modules, trying to figure out why something isn't working the way it's supposed to, or trying to fix a bug. To do that, I put in dump statements; sometimes tons of dump statements. (I can never get xdebug to work. Dump statements are quick and easy.) With code under version control, cleaning up all that mess is trivial: git can discard all changes. Without version control, I'm hunting through files for all the debug changes I made, or bouncing on CMD-Z like it's still the dark ages.</p>
</li>
</ul>
<p>So, put all your files in version control. And remember the adage: if it's not under version control, it doesn't exist.</p></div>
      
  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/better-way-work-drupal-core" rel="bookmark">
<span>A better way to work on Drupal core</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Fri, 04/16/2021 - 13:32
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>Often when things seem really complicated, I think it's because I must be doing it wrong.</p>
<p>Working on Drupal core since dependencies were removed from git has seemed really fiddly. For a long time I thought I must have missed something, that there was some undocumented technique I wasn't aware of.</p>
<p>But I've asked various people who work on core a lot more than I do, and they've confirmed that what I've been doing is pretty much the way that they do it:</p>
<ol>
<li>Get a git clone of Drupal core.</li>
<li>Run <code>composer install</code> on it.</li>
<li>Write code!</li>
<li>Make a patch (well, a merge request now!)</li>
</ol>
<p>That all sounds simple, right? But wait! If you're working on core, you're going to want Devel module for its useful debugging and inspection tools, right? And Drush, for quick cache clearing. And probably Admin Toolbar so going around the UI is quicker.</p>
<p>But you have to install all those with Composer. And doing that dirties the composer.lock file that's part of Drupal core's git clone.</p>
<p>It's fairly simple to keep changes to that file out of your merge request or patch, but pretty soon, you're going to do a <code>git pull</code> on core that's going to include changes to the composer.lock file, because core will have updates to dependencies.</p>
<p>And that's where it all starts to go wrong, because the <code>git pull</code> will fail because of conflicts in the composer.lock file and in other Composer files, and conflicts in that file are really painful to resolve.</p>
<p>So maintaining an ongoing Drupal install that uses a Drupal core git clone quickly becomes a mess. As far as I know, most core developers frequently reset the whole thing and reinstall from scratch.</p>
<p>The problem is caused by using the git clone of Drupal core as the Composer project, so that Drupal core's composer.json is being used as the project composer.json. But there's a better way...</p>
<h2>Using Composer with git clones</h2>
<p>Composer has a way of using a git clone for a package in a project:</p>
<ol>
<li>Create your own git clone of the package</li>
<li>Declare that git clone as a Composer package repository in the project's composer.json</li>
<li>Install the package</li>
</ol>
<p>The result is that Composer creates a symlink from your git clone into the project, and doesn't touch the git clone. You need to be fairly lax in the version requirement you give for the package, so that Composer doesn't object to the git clone being on a feature branch later on.</p>
<p>This, as far as I know, is the standard way for working on a Composer package that you need to operate in the context of a project. It works for library packages and Composer plugins.</p>
<p>For Drupal core...? Well, it works, but as you might have guessed it's a little more complicated.</p>
<p>Drupal has opinions about where it expects to be located in a project, and furthermore, has a scaffolding system which writes files into the webroot when you install it. All of that gets a bit confused if you put Drupal core out of the way and symlink it in.</p>
<p>But with a few symlinks, and one sneaky patch to a scaffold file, it works. It's all quite fiddly and so I've made...</p>
<h2>The Drupal Core development project</h2>
<p>This is a Composer project template, available at <a href="https://github.com/joachim-n/drupal-core-development-project">https://github.com/joachim-n/drupal-core-development-project</a>. It handles all the necessary tweaks to get Drupal to work when symlinked into a project: install it as a Composer project.</p>
<p>There are still a few limitations: those are detailed in the README too.</p>
<p>Of course, I've now fallen down the rabbithole of doing more work towards making Drupal completely agnostic of its location, rather than the core issues I wanted to work on in the first place.</p>
<p>Please try it, report any problems, and happy coding on Drupal core!</p></div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/59" hreflang="en">Composer</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/64" hreflang="en">Drupal core</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/different-ways-make-entity-bundles" rel="bookmark">
<span>Different ways to make entity bundles</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Tue, 10/27/2020 - 11:52
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>A lot of the time, a custom content entity type only needs a single bundle: all the entities of this type have the same structure. But there are times where they need to vary, typically to have different fields, while still being the same type. This is where entity bundles come in.</p>
<p>Bundles are to a custom entity type what node types are to the node entity type. They could be called sub-types instead (and there is <a href="https://www.drupal.org/project/drupal/issues/1380720">a long-running core issue to rename them to this</a>; I'd say go help but I'm not sure what can be done to move it forward), but the name 'bundle' has stuck because initially the concept was just about different 'bundles of fields', and then the name ended up being applied across the whole entity system.</p>
<p>History lesson over; how do you define bundles on your entity type? Well there are several ways, and of course they each have their use cases.</p>
<p>And of course, <a href="https://www.drupal.org/project/module_builder">Module Builder</a> can help generate your code, whichever of these methods you use.</p>
<h2>Quick and simple: hardcode</h2>
<p>The simplest way to do anything is to hardcode it. If you have a fixed number of bundles that aren't going to change over time, or at least so rarely that requiring a code deployment to change them is acceptable, then you can simply define the bundles in code. The way to do this is with a hook (though there's a core issue -- which I filed -- to <a href="https://www.drupal.org/project/drupal/issues/3112239">allow these to be defined in a method on the entity class</a>).</p>
<p>Here's how you'd define your hardcoded bundles:</p>
<pre><code>/**
 * Implements hook_entity_bundle_info().
 */
function mymodule_entity_bundle_info() {
  $bundles['my_entity_type'] = [
    'bundle_alpha_' =&gt; [
      'label' =&gt; t('Alpha'),
      'description' =&gt; t('Represents an alpha entity.')
    ],
    'bundle_beta_' =&gt; [
      'label' =&gt; t('Beta'),
      'description' =&gt; t('Represents a beta entity.')
    ],
  ];

  return $bundles;
}
</code></pre>
<p>The machine names of the bundles (which are used as the bundle field values, and in field names, admin paths, and so on) are the keys of the array. The labels are used in UI messages and page titles. The descriptions are used on the 'Add entity' page's list of bundles.</p>
<h2>Classic: bundle entity type</h2>
<p>The way Drupal core does bundles is with a bundle entity type. In addition to the content entity type you want to have bundles, there is also a config entity type, called the 'bundle entity type'. Each single entity of the bundle entity type defines a bundle of the content entity type. So for example, a single node type entity called 'page' defines the 'page' node type; a single taxonomy vocabulary entity called 'tags' defines the 'tags' taxonomy term type.</p>
<p>This is great if you want extensibility, and you want the bundles to be configurable by site admins in the UI rather than developers. The downside is that it's a lot of extra code, as there's a whole second entity type to define.</p>
<p>Very little glue is required between the two entity types, though. They basically each need to reference the other in their entity type annotations:</p>
<p>The content entity type needs:</p>
<pre><code> *   bundle_entity_type = "my_entity_type_bundle",
</code></pre>
<p>and the bundle entity needs:</p>
<pre><code> *   bundle_of = "my_entity_type",
</code></pre>
<p>and the bundle entity class should inherit from <code>\Drupal\Core\Config\Entity\ConfigEntityBundleBase</code>.</p>
<h2>Per-bundle functionality: plugins as bundles</h2>
<p>This third method needs more than just Drupal core: it's a technique provided by <a href="https://www.drupal.org/project/entity">Entity module</a>.</p>
<p>Here, you define a plugin type (an annotation plugin type, rather than YAML), and each plugin of that type corresponds to a bundle. This means you need a whole class for each bundle, which seems like a lot of code compared to the hook technique, but there are cases where that's what you want.</p>
<p>First, because Entity module's framework for this allows each plugin class to define different fields for each bundle. These so-called bundle fields are installed in the same way as entity base fields, but are only on one bundle. This gives you the diversification of per-bundle fields that you get with config fields, but with the definition of the fields in your code where it's easier to maintain.</p>
<p>Second, because in your plugin class you can code different behaviours for different bundles of your entity type. Suppose you want the entity label to be slightly different. No problem, in your entity class simply hand over to the bundle:</p>
<pre><code>class PluginAlpha {

  public function label() {
    $bundle_plugin = \Drupal::service('plugin.manager.my_plugin_type')
    return $bundle_plugin-&gt;label($this);
  }
  
}
</code></pre>
<p>Add a label() method to the plugin classes, and you can specialise the behaviour for each bundle. If you want to have behaviour that's grouped across more than one plugin, one way to do it is to add properties to your plugin type's annotation, and then implement the functionality in the plugin base class with a conditional on the value in the plugin's definition.</p>
<pre><code>/**
 * @MyPluginType(
 *   id = "plugin_alpha",
 *   label = @Translation("Alpha"),
 *   label_handling = "combolulate"
</code></pre>
<pre><code>class MyPluginBase {

  public function label() {
    switch ($this-&gt;getPluginDefinition()['floopiness']) {
      case 'combolulate':
        // Return the combolulated label. 
    }
  }

}
</code></pre>
<p>For a plugin type to be used as entity bundles, the plugins need to implement \Drupal\entity\BundlePlugin\BundlePluginInterface, and your entity type needs to declare the plugin:</p>
<pre><code> *   bundle_plugin_type = "my_plugin_type",
</code></pre>
<p>Here, the string 'my_plugin_type' is the part of the plugin manager's service name that comes after the 'plugin.manager' prefix. (The plugin system unfortunately doesn't have a standard concept of a plugin type's name, but this is informally what is used in various places such as Entity module and Commerce.)</p>
<p>The bundle plugin technique is well-suited to entities that are used as 'machinery' in some way, rather than content. For example, in Commerce License, each bundle of the license entity is a plugin which provides the behaviour that's specific to that type of license.</p>
<p>One thing to note on this technique: if you're writing kernel tests, you'll need to manually install the bundle plugins for them to exist in the test. See the tests in Entity module for an example.</p>
<p>These three techniques for bundles each have their advantages, so it's not unusual to find all three in use in a single project codebase. It's a question of which is best for a particular entity type.</p></div>
      
  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/using-lazy-builders-twig-templates" rel="bookmark">
<span>Using lazy builders with Twig templates</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Thu, 06/04/2020 - 14:04
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>Lazy builders were introduced in Drupal 8's render system to solve the problem of pieces of your page that have a low cacheability affecting the cacheability of the whole page. Typical uses of this technique are with entire render arrays which are handed over to a lazy builder.</p>
<p>However, in retrofitting an existing site to make use of caching more effectively, I found that we have a large amount of content that would be cacheable were it not for a single string. Specifically, we have a DIV of the details for a product, but also in that DIV there is the serial number for the user's specific instance of that product.</p>
<p>The whole of this product DIV was output by a Twig template. I could have ripped this up and remade it as a big render array, putting the lazy builder in for the serial number, but this seemed like a lot of work, and would also make our front-end developers unhappy.</p>
<p>It turned out there was another way. The render system deals with placeholders for lazy builders automatically, so you typically will just do:</p>
<pre><code>$build['uncacheable_bit'] = [
  '#lazy_builder' =&gt; [
    'my_service:myLazyBuilder',
    [],
  ],
];
</code></pre>
<p>but as I learned from a <a href="http://tech.dichtlog.nl/php/2015/08/03/lazy-builder-callback.html">blog post</a> by <a href="https://twitter.com/borisson">Borisson</a>, you can make the placeholders yourself put them <em>anywhere in the content</em> and attach the lazy builders to the build array. This is what the render system does when it handles a '#lazy_builder' builder render array item.</p>
<p>One application of this is that you can pass the placeholder as a parameter to a twig template:</p>
<pre><code>// Your placeholder can be anything, but using a hash like the render system
// does prevents accidental replacements.
$placeholder = Crypt::hashBase64('some_data');

$build['my_content'] = [
  '#theme' =&gt; 'my_template',
  '#var_1' =&gt; $var_1,
  // This is just a regular parameter as far as the Twig template cares, 
  // output with {{lazy_builder_var}} as normal.
  '#lazy_builder_var' =&gt; $placeholder,
];

$build['#attached']['placeholders'][$placeholder] = [
  '#lazy_builder' =&gt; [
    // The lazy builder callback and parameters.
    'my_service:myLazyBuilder',
    [],
  ],
];
</code></pre>
<p>With this approach, the Twig template just needed some minor changes. It doesn't care about the lazy builder; all it sees is the placeholder string which it treats like any other text. The render system finds the placeholder in the '#attached' attribute, and handles the replacement when the rendered template is retrieved from the render cache.</p>
<p>The result is that we're able to cache much more in the render cache, and improve site performance.</p>
<p>Now I just have to figure out the cache tags...</p></div>
      
  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/base-fields-versus-config-fields-and-how-handle-latter-tests" rel="bookmark">
<span>Base fields versus config fields, and how to handle the latter in tests</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Thu, 03/19/2020 - 14:07
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>All fields are equal in Drupal 8! Back in Drupal 7 we had two different systems for data on entities, which worked fairly differently: entity properties that were defined as database fields and controlled by hardcoded form elements, and user-created fields on entities that had widgets and formatters. But now in Drupal 8, every value on an entity is a field, with the same configuration in the UI, access to the widgets and formatters, and whose data is accessed in the same way.</p>
<p>Is this the end of the story? No, not quite. For site builders, everything is unified, and that's great. For code that consumes data from entities, everything is unified, and that's great too. But for the developer actually working with those fields, whether a field is a base field or a config field still makes a big difference.</p>
<h3>Config fields are easier...</h3>
<p>Config fields are manipulated via a UI, and that makes them simple to work with.</p>
<h4>Setup</h4>
<p>Config fields win easily here: a few clicks in the UI to create the field, a few options to choose in dropdowns for the widget and formatter options and you're set. Export to config, commit: done!</p>
<p>Base fields are more fiddly here. You need to be familiar with the Entity system, and understand (or copy-pasta!) the base field definitions. Then, knowing the right widget and formatter to use and how to set their options requires close reading of the relevant plugin classes.</p>
<h4>Update</h4>
<p>Config fields win again: change in the UI, export to config, deploy!</p>
<p>For base fields, you once again need to know what you're doing with the code,
and you now need a hook_update_N() to make the change to the database (now that entity updates are longer done automatically).</p>
<h4>Removal</h4>
<p>This is maybe a minor point, but while removing a config field is again just a
UI click and a config export, removing a base field will again require a hook_update_N() to tell the Entity API to update the database tables.</p>
<h3>...but base fields are more robust</h3>
<p>Given the above, why bother with base fields? Well, if your fields just sit there holding data, you can stop reading. But if your fields are involved in your custom code, as a developer, this should give you an unpleasant feeling: your code in <code>modules/custom/mymodule</code> is dependent on configuration that lives in the site's config export.</p>
<h4>Robustness</h4>
<p>The fact that config fields are so easy to change in the UI is now a mark <em>against</em> them. Another developer could change a field without a full understanding of the code that works with it. The code might expect a value to always be there, but the field is now non-required. The code might expect certain options, but the field now has an extra one.</p>
<p>Instead of this brittle dependency, it feels much safer to have base fields defined closer to the code that makes use of them: in the same module.</p>
<h4>Tests</h4>
<p>The solution to the dependency problem is obviously tests, which would pick up any change that breaks the code's expectations of how the fields behave. But now we hit a big problem with config fields: your test site doesn't have those fields!</p>
<p>My first attempt at solving this problem was to use the <a href="https://www.drupal.org/project/config_devel">Configuration development module</a>. This allows you to export config from the site to a module's <code>/config/install</code> folder. A test that installs that module then gets those config items imported.</p>
<p>It's a quick and simple approach: when a test crashes because of a missing field, find it in the config folder, add it to the right module's <code>.info.yml</code> file, do <code>drush cde MODULE</code> and commit the changes and the newly created files.</p>
<p>This approach also works for all other sorts of config your test might need: taxonomy vocabularies, node types, roles, and more!</p>
<p>But now you have an additional maintenance burden because your site config is now in <em>three</em> places: the site itself, the config export, and now also in module config. And if developers who change config forget to also export to module config, your test is now no longer testing how the site actually works, and so will either fail, or worse, won't be actually covering what you expect any more.</p>
<h3>Best of both worlds: import from config</h3>
<p>To summarize: we want the convenience of config fields, but we want them to be close to our code and testable. If they're testable, we can maybe stand to forego the closeness.</p>
<p>My best solution to this so far is simple: allow tests to import configuration
direct from the site config sync folder.</p>
<p>Here's the helper method I've been using:</p>
<pre><code>/**
 * Imports config from a real local site's config folder.
 *
 * TODO: this currently only supports config entities.
 *
 * @param string $site_key
 *   The site key, that is, the subfolder in /config in which to find the
 *   config files.
 * @param string $config_name
 *   The config name. This is the same as the YML filename without the
 *   extension. Note that this is not checked for dependencies.
 *
 * @throws \Exception
 *   Throws an exception if the config can't be imported.
 */
protected function importSiteConfig(string $site_key, string $config_name) {
  $storage = $this-&gt;container-&gt;get('config.storage.sync');

  // Code cribbed from Config Devel module's ConfigImporterExporter.
  $config_filename = "../config/{$site_key}/{$config_name}.yml";

  if (!file_exists($config_filename)) {
    throw new \Exception("Unable to find config file $config_filename to import from.");
  }

  $contents = @file_get_contents($config_filename);

  $data = $storage-&gt;decode($contents);
  if (!$data) {
    throw new \Exception("Failed to import config $config_name from site $site_key.");
  }

  // This assumes we only ever import entities from site config for tests,
  // which so far is the case.
  $entity_type_id = $this-&gt;container-&gt;get('config.manager')-&gt;getEntityTypeIdByName($config_name);

  if (empty($entity_type_id)) {
    throw new \Exception("Non-entity config import not yet supported!");
  }

  $entity = $this-&gt;container-&gt;get('entity_type.manager')-&gt;getStorage($entity_type_id)-&gt;create($data);
  $entity-&gt;save();
}
</code></pre>
<p>Use it in your test's setUp() or test methods like this:</p>
<pre><code>  // Import configuration from the default site config files.
  $this-&gt;importSiteConfig('default', 'field.storage.node.field_my_field');
  $this-&gt;importSiteConfig('default', 'field.field.node.article.field_my_field');
</code></pre>
<p>As you can see from the documentation, this so far only handles config that is entities. I've not yet had a use for importing config that's not an entity (and just about all config items are entities except for the ones that are a collection of a module's settings). And it doesn't check for dependencies: you'll need to import them in the right order (field storage before field) and ensure the modules that provide the various things are enabled in the test.</p>
<p>I should mention for the sake of completeness that there's another sort of field, sort of: bundle fields. These are in code like base fields, but limited to a particular bundle. They also have a variety of problems as the system that support them is somewhat incomplete.</p>
<p>Finally, it occurs to me that another way to bridge the gap would be to allow editing base fields in the UI, and then export that back to code consisting of the BaseFieldDefinition calls. But hang on... haven't I just reinvented Drupal 7-era Features?</p>
<h3>UPDATE</h3>
<p>It turned out this was crashing when importing fields with value options. This code (and that in Config Devel module, which is where I cribbed it from) wasn't properly using the Config API. Here's updated code, which incidentally, also now can handle non-entity config:</p>
<pre><code>  /**
   * Imports config from a real local site's config folder.
   *
   * Needs config module to be enabled.
   *
   * @param string $site_key
   *   The site key, that is, the subfolder in /config in which to find the
   *   config files.
   * @param string $config_name
   *   The config name. This is the same as the YML filename without the
   *   extension.
   *
   * @throws \Exception
   *   Throws an exception if the config can't be imported.
   */
  protected function importSiteConfig(string $site_key, string $config_name) {
    $storage = $this-&gt;container-&gt;get('config.storage.sync');

    // Code cribbed from Config Devel module's ConfigImporterExporter.
    $config_filename = "../config/{$site_key}/{$config_name}.yml";

    if (!file_exists($config_filename)) {
      throw new \Exception("Unable to find config file $config_filename to import from.");
    }

    $contents = @file_get_contents($config_filename);

    $data = $storage-&gt;decode($contents);
    if (!$data) {
      throw new \Exception("Failed to import config $config_name from site $site_key.");
    }

    unset($data['uuid']);

    // We have to partially mock the source storage, because otherwise
    // SystemConfigSubscriber::onConfigImporterValidateSiteUUID() will complain
    // because the source config doesn't contain a system.site config. (For
    // general information, the single-import UI in core doesn't hit this
    // problem because it TOTALLY cheats and pretends its source is the full
    // site config! Though who knows how it manages not to trip up when the site
    // config folder is empty!)
    $source_storage = $this-&gt;getMockBuilder(StorageReplaceDataWrapper::class)
      -&gt;setConstructorArgs([$this-&gt;container-&gt;get('config.storage')])
      -&gt;setMethods(['exists'])
      -&gt;getMock();
    // Satisfy SystemConfigSubscriber that we have a system.site config.
    $source_storage-&gt;expects($this-&gt;any())
      -&gt;method('exists')
      -&gt;willReturn(TRUE);

    $source_storage-&gt;replaceData($config_name, $data);

    // Similarly mock the storage comparer.
    $storage_comparer = $this-&gt;getMockBuilder(StorageComparer::class)
      -&gt;setConstructorArgs([$source_storage, $this-&gt;container-&gt;get('config.storage')])
      -&gt;setMethods(['validateSiteUuid'])
      -&gt;getMock();
    // Satisfy SystemConfigSubscriber that system.site config is valid.
    $storage_comparer-&gt;expects($this-&gt;any())
      -&gt;method('validateSiteUuid')
      -&gt;willReturn(TRUE);

    $storage_comparer-&gt;createChangelist();

    $config_importer = new ConfigImporter(
      $storage_comparer-&gt;createChangelist(),
      $this-&gt;container-&gt;get('event_dispatcher'),
      $this-&gt;container-&gt;get('config.manager'),
      $this-&gt;container-&gt;get('lock'),
      $this-&gt;container-&gt;get('config.typed'),
      $this-&gt;container-&gt;get('module_handler'),
      $this-&gt;container-&gt;get('module_installer'),
      $this-&gt;container-&gt;get('theme_handler'),
      $this-&gt;container-&gt;get('string_translation'),
      $this-&gt;container-&gt;get('extension.list.module')
    );

    $config_importer-&gt;import();
  }

}
</code></pre>
<h3>UPDATE 2</h3>
<p>I've found an occasional problem with site config items that have third-party settings from modules that aren't relevant to the test. Examples include Menu UI settings in node types, and contrib translation settings in fields. Rather than enable extra modules in the test, these settings can be hacked out of the data after we decode it from the YAML. Here's an updated version of the code.</p>
<pre><code>
use Drupal\Core\Config\ConfigImporter;
use Drupal\Core\Config\StorageComparer;
use Drupal\config\StorageReplaceDataWrapper;

  /**
   * Imports config from a real local site's config folder.
   *
   * @param string $site_key
   *   The site key, that is, the subfolder in /config in which to find the
   *   config files.
   * @param string $config_name
   *   The config name. This is the same as the YML filename without the
   *   extension.
   * @param array $third_party_filter
   *   (optional) Keys in the config item's third party settings that are to be
   *   removed prior to import. This prevents unwanted dependencies on modules
   *   that are not relevant to a test. Defaults to an empty array; no keys
   *   removed.
   *
   * @throws \Exception
   *   Throws an exception if the config can't be imported.
   */
  protected function importSiteConfig(string $site_key, string $config_name, array $third_party_filter = []) {
    $storage = $this-&gt;container-&gt;get('config.storage.sync');

    // Code cribbed from Config Devel module's ConfigImporterExporter.
    $config_filename = "../config/{$site_key}/{$config_name}.yml";

    if (!file_exists($config_filename)) {
      throw new \Exception("Unable to find config file $config_filename to import from.");
    }

    $contents = @file_get_contents($config_filename);

    $data = $storage-&gt;decode($contents);
    if (!$data) {
      throw new \Exception("Failed to import config $config_name from site $site_key.");
    }

    unset($data['uuid']);

    // Remove third-party settings.
    foreach ($third_party_filter as $settings_key) {
      unset($data['third_party_settings'][$settings_key]);
    }

    // We have to partially mock the source storage, because otherwise
    // SystemConfigSubscriber::onConfigImporterValidateSiteUUID() will complain
    // because the source config doesn't contain a system.site config. (For
    // general information, the single-import UI in core doesn't hit this
    // problem because it TOTALLY cheats and pretends its source is the full
    // site config! Though who knows how it manages not to trip up when the site
    // config folder is empty!)
    $source_storage = $this-&gt;getMockBuilder(StorageReplaceDataWrapper::class)
      -&gt;setConstructorArgs([$this-&gt;container-&gt;get('config.storage')])
      -&gt;setMethods(['exists'])
      -&gt;getMock();
    // Satisfy SystemConfigSubscriber that we have a system.site config.
    $source_storage-&gt;expects($this-&gt;any())
      -&gt;method('exists')
      -&gt;willReturn(TRUE);

    $source_storage-&gt;replaceData($config_name, $data);

    // Similarly mock the storage comparer.
    $storage_comparer = $this-&gt;getMockBuilder(StorageComparer::class)
      -&gt;setConstructorArgs([$source_storage, $this-&gt;container-&gt;get('config.storage')])
      -&gt;setMethods(['validateSiteUuid'])
      -&gt;getMock();
    // Satisfy SystemConfigSubscriber that system.site config is valid.
    $storage_comparer-&gt;expects($this-&gt;any())
      -&gt;method('validateSiteUuid')
      -&gt;willReturn(TRUE);

    $storage_comparer-&gt;createChangelist();

    $config_importer = new ConfigImporter(
      $storage_comparer-&gt;createChangelist(),
      $this-&gt;container-&gt;get('event_dispatcher'),
      $this-&gt;container-&gt;get('config.manager'),
      $this-&gt;container-&gt;get('lock'),
      $this-&gt;container-&gt;get('config.typed'),
      $this-&gt;container-&gt;get('module_handler'),
      $this-&gt;container-&gt;get('module_installer'),
      $this-&gt;container-&gt;get('theme_handler'),
      $this-&gt;container-&gt;get('string_translation'),
      $this-&gt;container-&gt;get('extension.list.module')
    );

    $config_importer-&gt;import();
  }
</code></pre></div>
      
  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/debugging-and-logging-ajax-requests-tests-docksal" rel="bookmark">
<span>Debugging and Logging AJAX requests tests in Docksal</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Wed, 11/06/2019 - 14:30
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>The hardest thing I find with tests is understanding errors. Every time I think I've got debugging output sorted, I find a new layer where it doesn't work, I've got nothing, and I'm in the dark with something that's crashing and I don't know why.</p>
<p>The first layer is simple: errors in your test code itself. For example, make a typo in your tests/src/Functional/MyTest.php and PHPUnit crashes and you see the error in the terminal.</p>
<p>But when it's site code that's crashing, you're dealing with a system that is being driven by code, and therefore, you can't see it. And that's a major obstacle to figuring out a problem.</p>
<p>The HTML output that Drupal's Functional and Functional Javascript tests produce is a huge help: every time your test code makes a request to the test site, an HTML file is written to the test files directory. If your site crashes when your test makes a request, you'll see the error and the backtrace there.</p>
<p>However, there's no such output when in a Functional Javascript test you cause an AJAX request. And while you can create a screenshot of what the page looks like after the request, our another HTML file of the page (see <a href="https://www.drupal.org/project/drupal/issues/3090498">https://www.drupal.org/project/drupal/issues/3090498</a> for instructions how; the issue is about how to make that automatic but I have no idea how that might be possible), you can't see the actual error, because AJAX requests that fail just sit there doing nothing. There's nothing useful to see in the browser.</p>
<p>So we need to see logs. When a real site has an AJAX crash, with a human being-controlled web browser making the request, you can go and look in the logs. With a test site, the log table is zapped when the test is completed.</p>
<p>Fortunately, Drupal 8's pluggable logging means there are other ways of getting hold of them, more permanent ways.</p>
<p>I first tried <a href="https://www.drupal.org/project/log_stdout">log_stdout module</a>. This outputs log errors to STDOUT. If you're running on Docksal, as I am, you have an extra layer to get though to see that. You can monitor the cli container with <code>fin logs -f cli</code>, and with that module add a <code>| ag WATCHDOG</code> to filter.</p>
<p>However, I wasn't seeing backtrace in this output, and I gave up figuring out why.</p>
<p>So I tried <a href="https://www.drupal.org/project/filelog">filelog module</a> instead, which as the name implies, writes log to a simple text file. This needs a little bit more work, as by default it writes to 'public://logs'. This means that each run of the test gets its own log file, which is perhaps what you want, but for my own uses I wanted a single log file I could <code>tail -f</code> in a terminal window and have continual monitoring.</p>
<p>A quick bit of config setting in the test's setUp() does the trick:</p>
<pre><code>$this-&gt;config('filelog.settings')
  -&gt;set('location', '/var/www/docroot/sites/simpletest/logs')
  -&gt;save();
</code></pre>
<p>And I think that's me at last sorted.</p></div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/62" hreflang="en">debugging</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/63" hreflang="en">tests</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/6" hreflang="en">drupal planet</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/multi-site-search-using-feeds-and-searchapi" rel="bookmark">
<span>Multi-site search using Feeds and SearchAPI</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Wed, 10/30/2019 - 13:08
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>[This is an old post that I wrote for <a href="https://systemseed.com/blog/how-unc-achieved-multi-site-search-using-feeds-and-searchapi">System Seed's blog</a> and meant to put on my own too but it fell off my radar until now. It's also about Drupal 7, but the general principle still applies.]</p>
<p>Handling clients with more than one site involves lots of decisions. And yet, it can sometimes seem like ultimately all that doesn't matter a hill of beans to the end-user, the site visitor. They won't care whether you use Domain module, multi-site, separate sites with common codebase, and so on. Because most people don't notice what's in their URL bar. They want ease of login, and ease of navigation. That translates into things such as the single sign-on that drupal.org uses, and common menus and headers, and also site search: they dont care that its actually sites search, plural, they just want to find stuff.</p>
<p>For the University of North Carolina, who have a network of sites running on a range of different platforms, a unified search system was a key way of giving visitors the experience of a cohesive whole. The hub site, an existing Drupal 7 installation, needed to provide search results from across the whole family of sites.</p>
<p>This presented a few challenges. Naturally, I turned to Apache Solr. Hitherto, I've always considered Solr to be some sort of black magic, from the way in which it requires its own separate server (http not good enough for you?) to the mysteries of its configuration (both Drupal modules that integrate with it require you to dump a bunch of configuration files into your Solr installation). But Solr excels at what it sets out to do, and the Drupal modules around it are now mature enough that things just work out of the box. Even better, Search API module allows you to plug in a different search back-end, so you can develop locally using Drupal's own database as your search provider, with the intention of plugging it all into Solr when you deploy to servers.</p>
<p>One possible setup would have been to have the various sites each send their data into Solr directly. However, with the Pantheon platform this didn't look to be possible: in order to achieve close integration between Drupal and Solr, Pantheon locks down your Solr instance.</p>
<p>That left talking to Solr via Drupal.</p>
<p>Search API lets you define different datasources for your search data, and comes with one for each entity type on your site. In a datasource handler class, you can define how the datasource gets a list of IDs of things to index, and how it gets the content. So writing a custom datasource was one possibility.</p>
<p>Enter the next problem: the external sites that needed to be indexed only exposed their content to us in one format: RSS. In theory, you could have a Search API datasource which pulls in data from an RSS feed. But then you need to write a SearchAPI datasource class which knows how to parse RSS and extract the fields from it.</p>
<p>That sounded like reinventing Feeds, so I turned to that to see what I could do with it. Feeds normally saves data into Drupal entities, but maybe (I thought) there was a way to have the data be passed into SearchAPI for indexing, by writing a custom Feeds plugin?</p>
<p>However, this revealed a funny problem of the sort that you dont consider the existence of until you stumble on it: Feeds works on cron runs, pulling in data from a remote source and saving it into Drupal somehow. But SearchAPI also works on cron runs, pulling data in, usually entities. How do you get two processes to communicate when they both want to be the active participant?</p>
<p>With time pressing, I took the simple option: define a custom entity type for Feeds to put its data into, and SearchAPI to read its data from. (I could have just used a node type, but then there would have been an ongoing burden of needing to ensure that type was excluded from any kind of interaction with nodes.)</p>
<p>Essentially, this custom entity type acted like a bucket: Feeds dumps data in, SearchAPI picks data out. As solutions go, not the most massively elegant, at first glance. But if you think about it, if I had gone down the route of SearchAPI fetching from RSS directly, then re-indexing would have been a really lengthy process, and could have had consequences for the performance of the sites whose content was being slurped up. A sensible approach would then have been to implement some sort of caching on our server, either of the RSS feeds as files, or the processed RSS data. And suddenly our custom entity bucket system doesnt look so inelegant after all: its basically a cache that both Feeds and SearchAPI can talk to easily.</p>
<p>There were a few pitalls. With Search API, our search index needed to work on two entity types (nodes and the custom bucket entities), and while Search API on Drupal 7 allows this, its multiple entity type datasource handler had a few issues to iron out or learn to live with. The good news though is that the Drupal 8 version of Search API has the concept of multi-entity type search indexes at its core, rather than as a side feature: every index can handle multiple entity types, and theres no such thing as a datasource for a single entity type.</p>
<p>With Feeds, I found that not all the configuration is exportable to Features for easy deployment. Everything about parsing the RSS feed into entities can be exported, except the actual URL, which is a separate piece of setup and not exportable. So I had to add a hook_updateN() to take care of setting that up.</p>
<p>The end result though was a site search that seamlessly returns results from multiple sites, allowing users to work with a network of disparate sites built on different technologies as if they were all the same thing. Which is what they were probably thinking they were all along anyway.</p></div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/6" hreflang="en">drupal planet</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/60" hreflang="en">search</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/61" hreflang="en">Feeds</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/controlling-multiple-sites-drush-9" rel="bookmark">
<span>Controlling multiple sites with Drush 9</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Sat, 03/16/2019 - 20:44
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>Drush 9 has removed dynamic site aliases. Site aliases are hardcoded in YAML files rather than declared in PHP. Sadly, that means that many tricks you could do with the declaration of the site aliases are no longer available.</p>
<p>The only grouping possible is based on the YAML filename. So for example, with the Acquia Cloud Site Factory site aliases generated by the 'blt recipes:aliases:init:acquia' command, you can run a command on the same site across different environments.</p>
<p>But what you can't do is run a command on all the sites in one environment.</p>
<p>One use case for this is checking whether a module is enabled on any sites, so you know that it's safe to remove it from the codebase.</p>
<p>Currently, this is quite a laborious process, as 'drush pm-list' needs to be run for each site.</p>
<p>With environment aliases, this would be a one liner:</p>
<pre><code>drush @hypothetical-env-alias pm-list | ag some_module
</code></pre>
<p>('ag' is the very useful <a href="https://github.com/ggreer/the_silver_searcher">silver searcher unix command</a>, which is almost the same as the also excellent 'ack' but faster, and both are much better than grep.)</p>
<p>While site aliases are fixed, they can be altered with Drush hooks. I considered that these might allow something to dynamically declare aliases, or a command option. There's <a href="https://github.com/drush-ops/drush/commit/886354d4fd7516893eac12b2b6f4ca">an example of altering aliases with a hook in the Drush code</a>.</p>
<p>In the meantime, a much simpler solution is to use xargs, which I have recently found is extremely useful in all sorts of situations. Because this allows you to run one command multiple times with a set of parameters, all you need to do is pass it a list of site aliases. Fortunately, the 'drush sa' command has lots of formatting options, and one of them gives us just what we need, a list of aliases with one on each line:</p>
<pre><code>drush sa --format=list 
</code></pre>
<p>That gives us all the aliases, and we probably don't want that. So here's where ag first comes in to play, as we can filter the list, for example, to only run on live sites (I'm using my ACSF aliases here as an example):</p>
<pre><code>drush sa --format=list| ag 01live
</code></pre>
<p>Now we have a filtered list of aliases, and we can feed that into xargs:</p>
<pre><code>drush sa --format=list| ag 01live | xargs -I % drush % pm-list
</code></pre>
<p>Normally, xargs puts the input parameter at the end of its command, but here we want it inserted just after the 'drush' command. The -I parameter allows us to specify a placeholder where the input parameter goes, so:</p>
<pre><code>xargs -I % drush % pm-list
</code></pre>
<p>says that we want the site name to go where the '%' is, and means that that xargs will run:</p>
<pre><code>drush SITE-ALIAS pm-list
</code></pre>
<p>with each value it receives, in this case, each site alias.</p>
<p>Another thing we will do with xargs is set the -t parameter, which outputs each actual command it executes on STDERR. That acts as a heading in the output, so we can clearly see which site is outputting what.</p>
<p>Finally, we can use ag a second time to filter the module list down to just the module we want to find out about:</p>
<pre><code>drush sa --format=list | ag live | xargs -t -I % drush % pml | ag some_module 
</code></pre>
<p>The nice thing about the -t parameter is that as it's STDERR, it's not affected by the final pipe to ag for filtering output. So the output will consist of the drush command for the site, followed by the filtered output.</p>
<p>And hey presto.</p>
<p>In conclusion: dynamic site aliases in Drush were nice, but the maintainers removed them (as far as I can gather) because they were a mess to implement, and removing them vastly simplified things. Doing the equivalent with xargs took a bit of figuring out, but once you know how to do it, it's actually a much more powerful way to work with multiple sites at once.</p></div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/9" hreflang="en">drush</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/6" hreflang="en">drupal planet</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/unnatural-file-changes-git" rel="bookmark">
<span>Unnatural file changes with git</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Sun, 01/27/2019 - 07:19
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>When you check out a branch or commit with git, two things happen: git changes the files in the repository folder, and changes the file that tells it what is currently checked out. In git terms, it changes what HEAD points to. In practical terms, it updates the .git/HEAD text file to contain a different reference.</p>
<p>But these two operations can be done separate from one another, so that while the files correspond to one commit, git thinks that the HEAD commit is another one.</p>
<p>This of course puts your git repository in an unstable, even unnatural state. But there are useful reasons for doing this, and one of these comes up in the operation of <a href="https://github.com/joachim-n/dorgflow">dorgflow, my tool for working with git and drupal.org patches</a>.</p>
<p>Dorgflow creates a local branch for a drupal.org issue, and creates a commit for each patch, so you end up with a nice sequential representation of the work that's been done so far.</p>
<p>But every patch that's uploaded to an issue is a patch against the master branch, so we can't just apply the patches one by one and make commits: the first patch will apply, and all the subsequent ones will fail.</p>
<p>What we need is for the files be in the same state as the master branch, so that the patch applies, but when we make a commit, it needs to be a new commit on the feature branch:</p>
<pre><code> * [Feature branch] Patch 1 &lt;- Make patch 2 commit on top of this commit.
/
* [master branch] Latest master commit. &lt;- Apply patch 2 to these files.
</code></pre>
<p>In git terms, we want the current files (the working tree, as git calls it) to be on the master branch, while git's HEAD is on the feature branch.</p>
<p>For my first attempt at getting this to work, I did the following:</p>
<ol>
<li>Put git on the feature branch.</li>
<li>Check out the master branch's files, with <code>git checkout master -- .</code>
</li>
</ol>
<p>When you use <code>git checkout</code> command with a file or files specified, it doesn't move HEAD, but instead changes just those files to the given commit or branch. If you give '.' as the file to check out, then it does that for all of the repository's files. In effect, you get the files to look like the given commit, in our case the master branch.</p>
<p>This is what we want, but it has one crucial flaw. Suppose patch 1 added a new file, foo.php. When we check out master's files, foo.php is not changed, because it's not on master. There's nothing on master to overwrite it. The <code>git checkout master -- .</code> command doesn't actually say 'make all the files look like master', it says 'check out all the files from master'. foo.php isn't on master, and so it's simply left alone.</p>
<p>Suppose now that patch 2 also adds the foo.php file, which it most likely will, since in most cases, a newer patch incorporates all the work of the previous one.</p>
<p>Applying patch 2 to the files in their current state will fail, because patch 2 tries to create the file foo.php, but it's already there.</p>
<p>So this approach is no good. I was stuck with this problem with dorgflow for months, until I had a brainwave: instead of staying on the feature branch and changing the files to look like master, why not check out the master branch, but tell git that the HEAD is at the feature branch?</p>
<p>That solves the problem of the foo.php file: when you check out master, the foo.php that's at the patch 1 commit vanishes, because it doesn't exist on master. So applying patch 2 will be fine.</p>
<p>The only remaining question was how to you tell git it's on a different branch without doing a checkout of files? Turns out this is a simple plumbing command: <code>git symbolic-ref HEAD refs/heads/BRANCH</code>. This is just telling git to change the reference that HEAD points to, and that's how git stores the fact that a particular branch is the current one.</p>
<p>This was a simple change to make in dorgflow (it was actually more work to update the tests so the mocks had the correct method call expectations!).</p>
<p>This means that dorgflow accordingly now handles applying a sequence of issue patches that add files now works in the latest release.</p></div>
      
  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/getting-more-you-bargained-removing-drupal-module-composer" rel="bookmark">
<span>Getting more than you bargained for: removing a Drupal module with Composer</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Wed, 01/09/2019 - 14:19
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>It's no secret that I find Composer a very troublesome piece of software to work with.</p>
<p>I have issues with Composer on two fronts. First, its output is extremely user-unfriendly, such as the long lists of impenetrable statements about dependencies that it produces when it tells you why it can't make a change you request. Second, many Composer commands have unwanted side-effects, and these work against the practice that changes to your codebase should be as simple as possible for the sake of developer sanity, testing, and user acceptance.</p>
<p>I recently discovered that removing packages is one such task where Composer has ideas of its own. A command such as remove drupal/foo will take it on itself to also update some apparently unrelated packages, meaning that you either have to manage the deployment of these updates as part of your uninstallation of a module, or roll up your sleeves and hack into the mess Composer has made of your codebase.</p>
<p>Guess which option I went for.</p>
<h2>Step 1: Remove the module you actually want to remove</h2>
<p>Let's suppose we want to remove the Drupal module 'foo' from the codebase because we're no longer using it:</p>
<pre><code>$ composer remove drupal/foo
</code></pre>
<p>This will have two side effects, one of which you might want, and one of which you definitely don't.</p>
<h3>Side effect 1: dependent packages are removed</h3>
<p>This is fine, in theory. You probably don't need the modules that are dependencies of foo. Except... Composer knows about dependencies declared in composer.json, which for Drupal modules might be different from the dependencies declared in module info.yml files (if maintainers haven't been careful to ensure they match). UPDATE: I've been informed in comments that drupal.org's packaging process ensures these are kept in sync. So that's one less thing to worry about!</p>
<p>Furthermore, Composer doesn't know about Drupal configuration dependencies. You could have the situation where you installed module Foo, which had a dependency on Bar, so you installed that too. But then you found Bar was quite useful in itself, and you've created content and configuration on your site that depends on Bar. Ideally, at that point, you should have declared Bar explicitly in your project's root composer.json, but most likely, you haven't.</p>
<p>So at this point, you should go through Composer's output of what it's removed,
and check your site doesn't have any of the Drupal modules enabled.</p>
<p>I recommend taking the list of Drupal modules that Composer has just told you it's removed in addition to the requested one, and checking its status on your live site:</p>
<pre><code>$ drush pml | ag MODULE
</code></pre>
<p>If you find that any modules are still enabled, then revert the changes you've just made with the remove command, and declare the modules in your root composer.json, copying the declaration from the composer.json file of the module you are removing. Then start step 1 again.</p>
<h3>Side effect 2: unrelated packages are updated</h3>
<p>This is undesirable basically because any package update is something that has to be evaluated and tested before it's deployed. Having that happen as part of a package removal turns what should be a straight-forward task into something complex and unpredictable. It's forcing the developer to handle two operations that should be separate as one.</p>
<p>(It turns out that the maintainers of Composer don't even consider this to be a problem, and as I have unfortunately come to expect, <a href="https://github.com/composer/composer/issues/7476">the issue on github</a> is a fine example of bad maintainership (for the nadir, see the issue on the use of JSON as a format for the main composer file) -- dismissing the problems that users explain they have, claiming the problems are by design, and so on.)</p>
<p>So to revert this, you need to pick apart the changes Composer has made, and reverse some of them.</p>
<p>Before you go any further, commit everything that Composer changed with the remove command. In my preferred method of operation, that means <em>all</em> the files, including the modules folder and the vendor folder. I know that Composer recommends you don't do that, but frankly I think trusting Composer not to damage your codebase on a whim is folly: you need to be able to back out of any mess it may make.</p>
<h2>Step 2: Repair composer.lock</h2>
<p>The composer.lock file is the record of how the packages currently are, so to undo some of the changes Composer made, we undo some of the changes made to this file, then get Composer to  update based on the lock.</p>
<p>First, restore version of composer.lock to how it was before you started:</p>
<pre><code>$ git checkout HEAD^ composer.lock
</code></pre>
<p>Unstage it. I prefer a GUI for git staging and unstaging operations, but on the command line it's:</p>
<pre><code>$ git reset composer.lock
</code></pre>
<p>Your composer lock file now looks as it did before you started.</p>
<p>Use either git add -p or your favourite git GUI to pick out the right bits. Understanding which bits are the 'right bits' takes a bit of mental gymnastics: overall, we want to keep the changes in the last commit that removed packages completely, but we want to discard the changes that upgrade packages.</p>
<p>But here we've got a reverted diff. So in terms of what we have here, we want to discard changes that re-add a package, and stage and commit the changes that downgrade packages.</p>
<p>When you're done staging you should have:</p>
<ul>
<li>the change to the content hash should be unstaged.</li>
<li>chunks that are a whole package should be unstaged</li>
<li>chunks that change version should be staged (be sure to get all the bits that relate to a package)</li>
</ul>
<p>Then commit what is staged, and discard the rest.</p>
<p>Then do a git diff of composer.lock against your starting point: you should see only complete package removals.</p>
<h2>Step 3: Restore packages with unrelated changes</h2>
<p>Finally, do:</p>
<pre><code>$ composer update --lock
</code></pre>
<p>This will restore the packages that Composer updated against your will in step 1 to their original state.</p>
<p>If you are committing Composer-managed packages to your repository, commit them now.</p>
<p>As a final sanity check, do a git diff against your starting point, like this:</p>
<pre><code>$ git diff --name-status master
</code></pre>
<p>You should see mostly deleted files. To verify there's nothing that shouldn't be there in the changed files, do:</p>
<pre><code>$ git diff --name-status master | ag '^[^D]'
</code></pre>
<p>You should see only composer.json, composer.lock, and the autoloader's files.</p>
<p>PS. If I am wrong and there IS a way to get Compose to remove a package without side-effects, please tell me.</p>
<p>I feel I have exhausted all the options of the remove command:</p>
<ul>
<li>--no-update only changes composer.json, and makes no changes to package files at all. I'm not sure what the point of this is.</li>
<li>--no-update-with-dependencies only removes the one package, and doesn't remove any dependencies that are not required anywhere else. This leaves you having to pick through composer.json files yourself and remove dependencies individually, and completely obviates the purpose of a package manager!</li>
</ul>
<p>Why is something as simple as a package removal turned into a complex operation by Composer? Honestly, I'm baffled. I've tried reasoning with the maintainers, and it's a brick wall.</p>
<p>PPS. Since writing this post, Ive made <a href="https://github.com/joachim-n/composer-manifest">Composer Manifest</a> a small Composer plugin which makes it easier to see what Composer has decided to change behind your back. Every time you do a Composer update, install, or remove, it writes a YAML file that lists all the installed packages with their versions. Committing that to your repository means you have an easy way to see exactly what's been changed and when.</p></div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/59" hreflang="en">Composer</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/drupal-code-builder-analytical-adaptive-code-generator" rel="bookmark">
<span>Drupal Code Builder: the analytical, adaptive code generator</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Sun, 09/09/2018 - 21:26
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>It's now just over 10 years since webchick handed maintainership of the Module Builder project over to me. I can still remember nervously approaching her at the end of a day at DrupalCon 2008, outside the building where people were chatting, and asking her if she'd had time to look at the patches I'd posted for it. I was at my first DrupalCon; she'd just been named as the core co-maintainer for the work about to start on Drupal 7. No, she hadn't, she said, and she instantly came to the conclusion that she'd never have the time to look at them, and so got her laptop out of her rucksack and there and then edited the project node to make me the maintainer.</p>
<p>Given the longevity of the project, I am often surprised when I talk to people that they don't know what its crucial advantage is over the other Drupal code generating tools that now also exist. Drupal Code Builder, as it's now called, is fundamentally different from Drupal Console's Generator command, and the Drupal Code Generator library thats included in Drush 9.</p>
<p>I feel that perhaps this requires a buzzword, to make it more noticeable and memorable.</p>
<p>So here is one: Drupal Code Builder is an <strong>analytical</strong> code generator.</p>
<p>I'm going to add a second one: the Drupal Code Builder Drush commands and Module Builder (which still exists, though is now just module that provides a Drupal-based UI for the Drupal Code Builder library) are <strong>adaptive</strong>.</p>
<p>What do I mean by those?</p>
<p>When you first install Drupal Code Builder, it has no information about Drupal hooks, or plugin types, or services. There is no data in the codebase on how to generate a hook_form_alter() implementation, or a Block plugin, or how to inject the entity_type.manager service.</p>
<p>Before you can generate code, you need to run a command or submit an admin form which will analyse your entire codebase, and store the resulting data on hooks, plugin types, services, and other Drupal structures (the list of what is analysed keeps growing.).</p>
<p>The consequence of this is huge: Drupal Code Builder is not limited to core hooks, or to the hooks that it's been programmed for. Drupal Code Builder knows all the hooks in <strong>your</strong> codebase: from core, from contrib module, even from any of your own custom code that invents hooks.</p>
<p>Now repeat that statement for plugin types, for services, and so on.</p>
<p>And that analysis process can, and should, be repeated when you download a new module, because then any Drupal structures (hooks, plugin types, etc) that are defined in new modules gets added to the list of what Drupal Code Builder can generate.</p>
<p>This means that you can use Drupal Code Builder to do something like this:</p>
<ol>
<li>Generate a new plugin type. This creates a plugin manager service class and declaration, an annotation class that defines the plugin annotation, and an interface and base class for the plugins.</li>
<li>Re-run DCB's analysis.</li>
<li>Generate a plugin of the type you've just made.</li>
</ol>
<p>When I say that this technique of analysis makes Drupal Coder Builder more powerful than other code generators, I'm not even blowing my own trumpet: the module I was handed in 2008 did the same. Back then in the Drupal 6 era is needed to connect to drupal.org's CVS repository to download the api.php files that document a module's hooks (which is why the Drush command for updating the code analysis prior to Drush 9 is called mb-download). For Drupal 7, the api.php files were moved into the core Drupal codebase, so from that point the process would scan the site's codebase directly. For Drupal 8, I added lots more code analysis, of plugin types and services, but still, the original idea remains: Drupal Code Builder knows how to detect Drupal structures, so it can know more structures than can be hardcoded.</p>
<p>This analysis can get pretty complex. While for hooks, it's just a case of running a regex on api.php files, for detecting information about plugin types, all sorts of techniques are used, such as searching the class parentage of all the plugins of a type to try to guess whether there is a plugin base class. Its not always perfect, and it could always use more refinement, but its a more powerful approach than hardcoding a necessarily finite number of cases. (If only plugin types were declared in some way, or if the documentation for them were systematic in the way hook documentation is, this would all be so much simpler, and much more importantly, it would be more accurate!)</p>
<p>My second buzzword, that UIs for Drupal Code Builder are adaptive, describes the way that neither of the Drush command nor the Drupal module need to know what Drupal Code Builder can build. They merely know the API for describing properties, and how to present them to the user, to then pass the input values to Drupal Code Builder to get the generated code.</p>
<p>This is analogous to the way that Form API doesnt know anything about a particular form, just about the different kinds of form elements.</p>
<p>This isnt as exciting or indeed relevant to the end-user, but it does mean that development on Drupal Code Builder can move quickly, as adding new things to generate doesnt require coordinated releases of software packages for the UI. In fact, I think nearly every new release of Drupal Code Builder has featured some sort of new code generating functionality, while keeping the API the same.</p>
<p>For example, this used to be the UI for adding a route on Drupal and Drush:</p>
<img src="https://joachim-n.github.io/sites/default/files/article/image/DCB%20adaptive%20-%20Drush%20routes%20before.png" width="550" height="47" alt="Screenshot showing Drush UI">
<img src="https://joachim-n.github.io/sites/default/files/article/image/DCB%20adaptive%20-%20MB%20routes%20before.png" width="545" height="146" alt="Screenshot showing Module Builder UI">
<p>A later release of Drupal Code Builder turned the UI into this, without the Drush command or Module Builder needing their code to be updated:</p>
<img src="https://joachim-n.github.io/sites/default/files/article/image/DCB%20adaptive%20-%20Drush%20routes%20after.png" width="556" height="320" alt="Screenshot showing Drush UI">
<img src="https://joachim-n.github.io/sites/default/files/article/image/DCB%20adaptive%20-%20MB%20routes%20after.png" width="603" height="331" alt="Screenshot showing Module Builder UI">
<p>Similarly, an even later version of Drupal Code Builder added code analysis to detect all top-level admin menu items, and so the admin settings form generation now lets you pick where to place the form in the menu.</p>
<p>It would be nice to think that a couple of buzzwords could gain Drupal Code Builder more attention and more users, but I fear that Drupal Consoles generator has got rather more traction in Drupal 8, despite its huge limitation. Its disappointing that Drush has now added a third code generator to the mix, to even further dilute the ecosystem, and that its just as limited by hardcoding.</p>
<p>So where do we go from here?</p>
<p>Well, people get attached to UIs, but they dont care much about what powers them, especially in this day and age of Composer, where adding dependencies no longer creates an imposition on the end-user.</p>
<p>So I suggest the following: the code analysis portion of Drupal Code Builder could be extracted to a new package. It doesnt depend on anything on the code generation side, so that should be fairly simple. It provides an API that supports analysis being run in batches, which could maybe do with being spruced up, but its good enough for a 1.0.0 version for now.</p>
<p>Then, any code generating system would be able to use it. Both Console and Drush could replace their hardcoded lists of hooks and plugins with analytical data, while keeping the commands they expose to the end-user unchanged.</p>
<p>Ill be at DrupalEurope in Darmstadt, where Ill be running a BoF to discuss where we go next with code generation on Drupal.</p></div>
      
  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/making-builder-code-look-output-code" rel="bookmark">
<span>Making builder code look like output code</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Tue, 06/26/2018 - 21:30
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>One of the big challenges with updating Drupal Code Builder for Drupal 8 has been the sheer variety of code to be output. On earlier versions of Drupal, it was just about hooks, and all that needed to be done was to take the API documentation code and replace 'hook_' with the module name. There were info files too, and Drupal 7 added the placing of hooks into different .inc files, but compared to this, Drupal 8 has things like plugin annotations, fluent method calls for content entity baseFieldDefinitions(), FormAPI arrays, not to mention PHP class methods, and more.</p>
<p>But one of the things I enjoy about working on DCB is that I am free to experiment with different ideas, much more so than with work on core or even contrib. It is its own system, without any need to work with what a framework supplies, and it has no need to be extensible. So I can try a new way of doing things as often as I want, and clean up when I've had time to figure out which way works best.</p>
<p>For example, up until recently, the code for a field definition in baseFieldDefinitions() was getting generated in three different ways.</p>
<p>First, the old-fashioned way of doing it line by line, then concatenating the array with a "\n" to make the final code. This is the way most of the old code in DCB was done, but with things that need handling of terminal commas or semicolons, and nesting indents and so on, it was starting to get really clunky.</p>
<p>So then I tried writing something loosely inspired by Drupal's RenderAPI. Because that's a nice big hammer that seems to fit a lot of nails: make a big array of data, chuck your stuff into it, then hand it over to something that makes the output. Except, not so good. Writing the code to make the right sort of array was fiddly. The array of data needed to combine actual data and metadata (such as the class of an annotation), which added levels to the nesting.</p>
<p>Then I hit on an idea: baseFieldDefinitions() fields are a fluent interface, like this:</p>
<pre><code>$fields['changed'] = BaseFieldDefinition::create('changed')
  -&gt;setLabel(t('Changed'))
  -&gt;setDescription(t('The time that the node was last edited.'))
  -&gt;setRevisionable(TRUE)
  -&gt;setTranslatable(TRUE);
</code></pre>
<p>What if the code that builds this could be the same, to the point where you could just copy-paste code from, say, the node entity class, and make a few tweaks? Creating the code in DCB would be much simpler, and having the DCB code look like the output code would make debugging easier too.</p>
<p>Using a class with the magic __call() method lets us have just that: a renderer object that treats a method call as some information about code to render. Here's what the builder code for the base field definition code looks like now:</p>
<pre><code>$changed_field_calls = new FluentMethodCall;
$changed_field_calls
  -&gt;setLabel(FluentMethodCall::t('Changed'))
  -&gt;setDescription(FluentMethodCall::t('The time that the entity was last edited.'));
if ($use_revisionable) {
  $changed_field_calls-&gt;setRevisionable(TRUE);
}
if ($use_translatable) {
  $changed_field_calls-&gt;setTranslatable(TRUE);
}
$method_body = array_merge($method_body, $changed_field_calls-&gt;getCodeLines());
</code></pre>
<p>It's not yet perfect, as the first line isn't done by this, and the handling of the t() calls could do with some polish; probably by creating a separate class called something like FunctionCall, such that FunctionCall::somefunction() returns the code for a call to somefunction().</p>
<p>But the efficiency and elegance of this approach has led me to devise a new principle for DCB: builder code should look as much as possible like that code that it outputs.</p>
<p>So applying this approach to outputting annotations, the code now looks like this:</p>
<pre><code>$annotation = ClassAnnotation::ContentEntityType([
  'id' =&gt; 'cat',
  'label' =&gt; ClassAnnotation::Translation("Cat"),
  'label_count' =&gt; ClassAnnotation::PluralTranslation([
    'singular' =&gt; "@count content item",
    'plural' =&gt; "@count content items",
  ]),
]);
$annotation_lines = $annotation-&gt;render();
</code></pre>
<p>Magic methods used there as well, this time for static calls. The similarity to the output code isn't as good, as annotations aren't PHP code, but it's still close enough that you can copy the code you want to output, make a few simple changes, and you have the builder code.</p>
<p>This work has embodied another principle that I've come to follow: complexity and ugliness should be pushed down, hidden, and encapsulated. Here, the ClassAnnotation and FluentMethodCall have to do fiddly stuff like quoting string values, recurse into nested arrays. They have to handle special cases, like the last line of a fluent call has a semicolon and the last line of an annotation has no comma. All of that is hidden from the code that uses them. That can get on with doing the interesting bits.</p></div>
      
  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/quick-and-dirty-debug-module" rel="bookmark">
<span>The quick and dirty debug module</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Tue, 05/15/2018 - 06:28
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>There's a great module called the debug module. I'd give you the link but it doesn't exist. Or rather, it's not a module you download. It's a module you write yourself, and write again, over and over again.</p>
<p>Do you ever want to inspect the result of a method call, or the data you get back from a service, the result of a query, or the result of some other procedure, without having to wade through the steps in the UI, submit forms, and so on?</p>
<p>This is where the debug module comes in. It's just a single page which outputs whatever code you happen to want to poke around with at the time. On Drupal 8, that page is made with:</p>
<ul>
<li>an info.yml file</li>
<li>a routing file</li>
<li>a file containing the route's callback. You could use a controller class for this, but it's easier to have the callback just be a plain old function in the module file, as there's no need to drill down a folder structure in a text editor to reach it.</li>
</ul>
<p>(You could quickly whip this up with <a href="https://www.drupal.org/project/module_builder">Module Builder</a>!)</p>
<p>Here's what my router file looks like:</p>
<pre><code>joachim_debug:
  path: '/joachim-debug'
  defaults:
    _controller: 'joachim_debug_page'
  options:
    _admin_route: TRUE
  requirements:
    _access: 'TRUE'

</code></pre>
<p>My debug module is called 'joachim_debug'; you might want to call yours something else. Here you can see we're granting access unconditionally, so that whichever user I happen to be logged in as (or none) can see the page. That's of course completely insecure, especially as we're going to output all sorts of internals. But this module is only meant to be run on your local environment and you should on no account commit it to your repository.</p>
<p>I don't want to worry about access, and I want the admin theme so the site theme doesn't get in the way of debug output or affect performance.</p>
<p>If you sometimes want to see themed output, you can add a second route with a different path, which serves up the same content but without the admin theme option:</p>
<pre><code>joachim_debug_theme:
  path: '/joachim-debug-theme'
  defaults:
    _controller: 'joachim_debug_page'
  requirements:
    _access: 'TRUE'
</code></pre>
<p>The module file starts off looking like this:</p>
<pre><code>opcache_reset();

function joachim_debug_page() {
  $build = [
    '#markup' =&gt; aaaaarrrgh!!!!,
  ];

  /*
  // ============================ TEMPLATE


  return $build;
  */

  return $build;
}

</code></pre>
<p>The commented-out section is there for me to quickly copy and paste a new section of code anytime I want to do something different. I always leave the old code in below the return, just in case I want to go back to it later on, or copy-paste snippets from it.</p>
<p>Back in the Drupal 6 and 7 days, the return of the callback function was merely a string. On Drupal 8, it has to be a proper render array. The return text used to be 'It's going wrong!' but these days it's the more expressive 'aaaaarrrgh'. Most of the time, the output I want will be the result of dsm() call, so the $build is there just so Drupal's routing system doesn't complain about a route callback not returning anything.</p>
<p>Here are some examples of the sort of code I might have in here.</p>
<pre><code>  // ============================ Route provider
  $route_provider = \Drupal::service('router.route_provider');
  
  $path = 'node/%/edit';
  $rs = $route_provider-&gt;getRoutesByPattern($path);
  dsm($rs);

  return $build;
</code></pre>
<p>Here I wanted to see the what the route provider service returns. (I have no idea why, this is just something I found in the very long list of old code in my module's menu callback, pushed down by newer stuff.)</p>
<pre><code>  // ============================ order receipt email
  $order = entity_load('commerce_order', 3);
  
  $build = [
    '#theme' =&gt; 'commerce_order_receipt',
    '#order_entity' =&gt; $order,
    '#totals' =&gt; \Drupal::service('commerce_order.order_total_summary')-&gt;buildTotals($order),
  ];

  return $build;
</code></pre>
<p>I wanted to work with the order receipt emails that Commerce sends. But I don't want to have to make a purchase, complete and order, and then look in the mail logger just to see the email! But this is quicker: all I have to do is load up my debug module's page (mine is at the path 'joachim-debug', which is easy to remember for me; you might want to have yours somewhere else), and vavoom, there's the rendered email. I can tweak the template, change the order, and just reload the page to see the effect.</p>
<p>As you can see, it's quick and simple. There's no safety checks, so if you ever put code here that does something (such as an entity_delete(), it's useful for deleting entities in bulk quickly), be sure to comment out the code once you're done with it, or your next reload might blow up! And of course, it's only ever to be used on your local environment; never on shared development sites, and certainly never on production!</p>
<p>I once read something about how a crucial piece of functionality required for programming, and more specifically, for ease of learning to program with a language or a framework, is being able to see and understand the outcomes of the code you are writing. In Drupal 8 more than ever, being able to understand the systems you're working with is vital. There are tools such as debuggers and the Devel and Devel Contrib modules' information pages, but sometimes quick and dirty does the job too.</p></div>
      
  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/regenerating-plugin-dependency-injection-module-builder" rel="bookmark">
<span>Regenerating plugin dependency injection with Module Builder</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Wed, 02/21/2018 - 21:52
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>Dependency injection is a pattern that adds a lot of boilerplate code, but <a href="https://github.com/drupal-code-builder/drupal-code-builder">Drupal Code Builder</a> makes it easy to add injected services to plugins, forms, and service classes.</p>
<p>Now that the Drupal 8 version of <a href="https://www.drupal.org/project/module_builder">Module Builder</a> (the Drupal front-end to the Drupal Code Builder library) uses an autocomplete for service names in the edit form, adding injected services is even easier, and any of the hundreds of services in your sites codebase (443 on my local sandbox Drupal 8 site!) can be injected.</p>
<img src="https://joachim-n.github.io/sites/default/files/styles/large/public/article/image/DCB%20dependency%20injection%20-%20services%20autocomplete.png?itok=i2VY-8K-" width="437" height="420" alt class="image-scale_75">
<p>I often used this when I want to add a service to an existing plugin: re-generate the code, and copy-paste the new code I need.</p>
<p>This is an area in which Module Builder now outshines its Drush counterpart, because unlike the <a href="https://github.com/drupal-code-builder/drupal-code-builder-drush">Drush front end</a> for Drupal Code Builder, which generates code with input parameters every time, Module Builder lets you save your settings for the generated module (as a config entity).</p>
<p>So you can return to the plugin you generated to start with, add an extra service to it, and generate the code again. You can copy and paste, or have Module Builder write the file and then use git to revert custom code its removed. (The ability to insert generated code into existing files is on my list of desirable features, but is realistically a long way off, as it would be rather complex, a require the addition of a code parsing library.)</p>
<p>But why stop at generating code for your own modules? I recently filed <a href="https://www.drupal.org/project/search_api/issues/2945833">an issue on Search API</a>, suggesting that its plugins could do with tweaking to follow the standard core pattern of a static factory method and constructor, rather than rely on setters for injection. Its not a complex change, but a lot of code churn. Then it occurred to me: Drupal Code Builder can generate that boilerplate code: simply create a module in Module Builder <em>called</em> search_api, and then add a plugin with the name of one that is already in Search API, and then set its injected services to the services the real plugin needs.</p>
<p>Drupal Code Builder already knows how to build a Search API plugin: its code analysis detects the right plugin base class and annotation to use, and also any parameters that the constructor method should pass up to the base class.</p>
<img src="https://joachim-n.github.io/sites/default/files/styles/large/public/article/image/DCB%20dependency%20injection%20-%20SearchAPI%20add%20plugin.png?itok=M2AIXwnQ" width="434" height="419" alt class="image-scale_75">
<p>So its pretty quick to copy the plugin name and service names from Search APIs plugin class to the form in Module Builder, and then save and generate the code, and then copy the generated factory methods back to Search API to make a patch.</p>
<p>Im now rather glad I decided to use config entities for generated entities. Originally, I did that just because it was a quick and convenient way to get storage for serialized data (and since then I discovered in other work that <a href="https://www.drupal.org/project/drupal/issues/2887105">map fields are broken in D8</a> so Im very glad I didnt try to make then content entities!). But the ability to save the generating settings for a module, and then return to it to add to them has proved very useful.</p></div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/56" hreflang="en">drupal code builder</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/8" hreflang="en">module builder</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/triggering-events-fly" rel="bookmark">
<span>Triggering events on the fly</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Fri, 01/12/2018 - 21:45
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>As far as I know, there's nothing (yet) for triggering an arbitrary event. The complication is that every event uses a unique event class, whose constructor requires specific things passing, such as entities pertaining to the event.</p>
<p>Today I wanted to test the emails that Commerce sends when an order completes, and to avoid having to keep buying a product and sending it through checkout, I figured I'd mock the event object with Prophecy, mocking the methods that the OrderReceiptSubscriber calls (this is the class that does the sending of the order emails). Prophecy is a unit testing tool, but its objects can be created outside of PHPUnit quite easily.</p>
<p>Here's my quick code:</p>
<pre><code>  $order = entity_load('commerce_order', ORDER_ID);
 
  $prophet = new \Prophecy\Prophet;
  $event = $prophet-&gt;prophesize('Drupal\state_machine\Event\WorkflowTransitionEvent');

  $event-&gt;getEntity()-&gt;willReturn($order);
 
  $subscriber = \Drupal::service('commerce_order.order_receipt_subscriber');
 
  $subscriber-&gt;sendOrderReceipt($event-&gt;reveal());
</code></pre>
<p>Could some sort of generic tool be created for triggering any event in Drupal? Perhaps. We could use reflection to detect the methods on the event class, but at some point we need some real data for the event listeners to do something with. Here, I needed to load a specific order entity and to know which method on the event class returns it. For another event, I'd need some completely different entities and different methods.</p>
<p>We could maybe detect the type that the event method return (by sniffing in the docblock... once we go full PHP 7, we could use reflection on the return type), and the present an admin UI that shows a form element for each method, allowing you to enter an entity ID or a scalar value.</p>
<p>Still, you'd need to look at the code you want to run, the event listener, to know which of those you'd actually want to fill in.</p>
<p>Would it same more time than cobbling together code like the above? Only if you multiply it by a sufficiently large number of developers, as is the case with many developer tools.</p>
<p>It's the sort of idea I might have tinkered with back in the days when I had time. As it is, I'm just going to throw this idea out in the open.</p></div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/57" hreflang="en">events</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/58" hreflang="en">developer tools</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/drupal-code-builder-unit-testing-bringing-heavy-stuff" rel="bookmark">
<span>Drupal Code Builder unit testing: bringing in the heavy stuff</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Mon, 11/13/2017 - 21:49
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>I started adding unit tests to Drupal Code Builder about 3 years ago, and Ive been gradually expanding on them ever since. Its made refactoring the code a pleasant rather than stressful experience.</p>
<p>However, while all generator types are covered, the level of detail the tests go into isnt that deep. Back when I wrote the tests, they mostly needed to check for hook implementations that were generated, and so quick and dirty regexes on the generated code did the job: match 'mymodule_form_alter' in the generated code, basically. I gradually extended those to cover things like class declarations and methods, but that approach is very much cracking at the seams.</p>
<p>So its time to switch to something more powerful, and more suited to the task.</p>
<p>Ive already removed my frankly hideous attempt at verifying that generated code is correctly-formed PHP, replacing it with a call to PHPs own code linter. My own code was running the generated PHP code files through eval() (yes, I know!) to check nothing crashed, which was quick and worked but only up to a point: tests couldnt create the same function twice, as eval()ing code that contains a function declaration brings it into the global namespace, and it didnt work at all for classes where while tests were being run, as the parent classes in Drupal core or contrib aren't present.</p>
<p>It's already proved worthwhile, as once I'd converted the tests, I found an error in the generated code: a stray quote mark in base field definitions for a content entity, which my approach wasn't picking up, and never would have.</p>
<p>The second phase is going to be to use PHPCS and Drupal Coder to check that generated code follows Drupal Coding Standards. I'm currently getting that to work in my testing base class, although it might be a while before I push it, as I suspect it's going to complain about quite a few nipicks in the generated code that I'll then have to spend some time fixing.</p>
<p>The third phase (this is a 3-phrase programme, all the best ones are) is going to be to look into using <a href="https://github.com/nikic/PHP-Parser">PHP-Parser</a> to check for the presence of functions and methods in the code, rather than my regex-based approach. This is going to allow for much more thorough checking of the generated code, with things such as method order in the code, service injection, and more.</p>
<p>After that, it'll be back to some more refactoring and code clean-up, and then some more code generators! I have a few ideas of what else Drupal Code Builder could generate, but more ideas are welcome in the issue queue on github.</p></div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/56" hreflang="en">drupal code builder</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/brief-update-drupal-code-builder" rel="bookmark">
<span>Brief update on Drupal Code Builder</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Fri, 09/15/2017 - 20:31
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>I've completely revamped the Drush commands for Drupal Code Builder:</p>
<ul>
<li>First, they're now in <a href="https://github.com/drupal-code-builder/drupal-code-builder-drush">their own project on Github</a>
</li>
<li>Second, I've rewritten them completely for Drush 9, completely interactive.</li>
<li>Third, they are now geared towards <em>adding</em> to existing modules, rather than generating a module as a single shot. That approach made sense in the days of Drupal 6 when it was just hook implementations, but I increasingly find I want to add a plugin, a service, a form, to a module I've already started.</li>
</ul>
<p>The downside is that installing these is rather tricky at the moment due to some current limitations in Drush 9 beta; see details in the project README, which has full instructions for workarounds.</p>
<p>Now that's out of the way, I'm pushing on with some new generators for the Drupal Code Builder library itself. On my list is:</p>
<ul>
<li>plugin types (as in the plugin manager service, base class and interface, and declaration for Plugins module)</li>
<li>entity type</li>
<li>entity type handlers</li>
<li>your suggestions in the issue queue...</li>
</ul>
<p>And of course more unit tests and refactoring of the codebase.</p></div>
      
  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/dorgflow-tool-automate-your-drupalorg-patch-workflow" rel="bookmark">
<span>Dorgflow: a tool to automate your drupal.org patch workflow</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Wed, 02/22/2017 - 23:14
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>Ive written previously about git workflow for working on drupal.org patches, and about how we dont necessarily need to move to a github-style system on drupal.org, we just maybe need better tools for our existing workflow. Its true that much of it is repetitive, but then repetitive tasks are ripe for automation. In the two years since I released Dorgpatch, a shell script that handles the making of patches for drupal.org issues, Ive been thinking of how much more of the drupal.org patch workflow could be automated.</p>
<p>Now, I have released a new script, <a href="https://github.com/joachim-n/dorgflow">Dorgflow</a>, and the answer is just about everything. The only thing that Dorgflow doesnt automate is uploading the patch to drupal.org (and thats because drupal.orgs REST API is read-only). Oh, and writing the code to actually fix bugs or create new features. You still have to do that yourself, along with your cup of coffee.</p>
<p>So assuming youve made your own hot beverage of choice, how does Dorgflow work?</p>
<p>Simply! To start with, you need to have an up to date git clone of the project you want to work on, be it Drupal core or a contrib project.</p>
<p>To start work on an issue, just do:</p>
<pre><code>$ dorgflow https://www.drupal.org/node/123456
</code></pre>
<p>You can copy and paste the URL from your browser. It doesnt matter if it has an anchor link on the end, so if you followed a link from your issue tracker and it has #new at the end, or clicked down to a comment and it has #comment-1234 thats all fine.</p>
<p>The first thing this comment does it make a new git branch for you, using the issue number and the name. It then also downloads and applies all the patch files from the issue node, and makes a commit for each one. Your local git now shows you the history of the work on the issue. (Note though that if a patch no longer applies against the main branch, then its skipped, and if a patch has been set to not be displayed on the issues file list, then its skipped too.)</p>
<p>Lets see how this works with an actual issue. Today I wanted to review the patch on an issue for Token module. The issue URL is https://www.drupal.org/node/2782605. So I did:</p>
<pre><code>$ dorgflow https://www.drupal.org/node/2782605
</code></pre>
<p>That got me a git history like this:</p>
<pre><code>  * 6d07524 (2782605-Move-list-of-available-tokens-from-Help-to-Reports) Patch from Drupal.org. Comment: 35; URL: https://www.drupal.org/node/2782605#comment-11934790; file: token-move-list-of-available-tokens-2782605-34.patch; fid 5784728. Automatic commit by dorgflow.
 * 6f8f6e0 Patch from Drupal.org. Comment: 15; URL: https://www.drupal.org/node/2782605#comment-11666939; file: 2782605-13.patch; fid 5710235. Automatic commit by dorgflow.
 /
* a3b68cc (8.x-1.x) Issue #2833328 by Berdir: Handle bubbleable metadata for block title token replacements
* [older commits]
</code></pre>
<p>What we can see here is:</p>
<ul>
<li>Git is now on a feature branch, called 2782605-Move-list-of-available-tokens-from-Help-to-Reports. The first part is the issue number, and the rest is from the title of the issue node on drupal.org.</li>
<li>Two patches were found on the issue, and a commit was made for each one. Each patchs commit message gives the comment index where the patch was posted, the URL to the comment, the patch filename, and the patch file entity ID (these last two are less interesting, but are used by Dorgflow when you update a feature branch with newer patches from an issue).</li>
</ul>
<p>The commit for patch 35 will obviously only show the difference between it and patch 15, an interdiff effectively. To see what the patch actually contains, take a diff from the master branch, 8.x-1.x.</p>
<p>(As an aside, the trick to applying a patch thats against 8.x-1.x to a feature branch that already has commit for a patch is that there is a way to check out files from any git commit while still keeping gits HEAD on the current branch. So the patch applies, because the files look like 8.x-1.x, but when you make a commit, youre on the feature branch. Details are on <a href="http://stackoverflow.com/questions/13896246/reset-git-to-commit-without-changing-head-to-detached-state">this Stack Overflow question</a>.)</p>
<p>At this point, the feature branch is ready for work. You can make as many commits as you want. (You can rename the branch if you like, provided the 2782605- part stays at the beginning.) To make your own patch with your work, just run the Dorgflow script without any argument:</p>
<pre><code>$ dorgflow
</code></pre>
<p>The script detects the current branch, and from that, the issue number, and then fetches the issue node from drupal.org to get the number of the next comment to use in the patch filename. All you now have to do is upload the patch, and post a comment explaining your changes.</p>
<p>Alternatively, if youre a maintainer for the project, and the latest patch is ready to be committed, you can do the following to put git into a state where the patch is applied to the main development branch:</p>
<pre><code>$ dorgflow commit
</code></pre>
<p>At that point, you just need to obtain the git commit command from the issue node. (Remember the drupal standard git message format, and to check the attribution for the work on the issue is correct!)</p>
<p>What if youve previously reviewed a patch, and now theres a new one? Dorgflow can download new patches with this command:</p>
<pre><code>$ dorgflow update
</code></pre>
<p>This compares your feature branch to the issue nodes patches, and any patches you dont yet have get new commits.</p>
<p>If youve made commits for your own work as well, then effectively theres a fork in play, as your development in your commits and the other persons patch are divergent lines of development. Appropriately, Dorgflow creates a separate branch. Your commits are moved onto this branch, while the feature branch is rewound to the last patch that was already there, and then has the new patches applied to it, so that it now reflects work on the issue. Its then up to you to do a git merge of these two branches in order to combine the two lines of development back into one.</p>
<p>Dorgflow is still being developed. There are a few ideas for further features in the issue queue on github (not to mention a couple of bugs for some of the various possible cases the update command can encounter). Im also pondering whether its worth the effort to convert the script to use Symfony Console; feel free to chime in with any opinions on the issue for that.</p>
<p>There are tests too, as its pretty important that a script that does things to your git repository does what its supposed to (though the only command that does anything destructive is dorgflow cleanup, which of course asks for confirmation). Having now written this, Im obviously embarking upon cleaning it up and to some extent rewriting it, though I do have the excuse that the early weeks of working on this were the days after the late nights awake with my newborn daughter, and so the early versions of the code were written in a haze of sleep deprivation. If youd like to submit a pull request, please do check in with me first on an issue to ensure its not going to clash with something Im partway through changing.</p>
<p>Finally, if you find this as useful as I do (this was definitely an itch Ive been wanting to scratch for a long time, as well as being a prime case of condiment-passing), please tell other Drupal developers about it. Lets all spend less time downloading, applying, and rolling patches, and more time writing Drupal code!</p></div>
      
  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/changing-type-node" rel="bookmark">
<span>Changing the type of a node</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Mon, 01/16/2017 - 22:22
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>Theres an old saying that no information architecture survives contact with the user. Or something like that. Youll carefully design and build your content types and taxonomies, and then find that the users are actually not quite using what youve built in quite the way it was intended when you were building it.</p>
<p>And so there comes a point where you need to grit your teeth, change the structure of the sites content, and convert existing content.</p>
<p>Back on Drupal 7, I wrote a plugin for Migrate which handled migrations <em>within</em> a single Drupal site, so for example from nodes to a custom entity type, or from one node type to another. (The <a href="https://www.drupal.org/node/1883112">patch works</a>, though I never found the time to polish it sufficiently to be committed.)</p>
<p>On Drupal 8, without the time to learn the new version of Migrate, I recently had to cobble something together quickly.</p>
<p>Fortunately, this was just changing the type of some nodes, and where all the fields were identical on both source and destination node types.  Anything more complex would definitely require Migrate.</p>
<p>First, I created the new node type, and cloned all its fields from the old type to the new type. Here I took the time to update some of the <a href="https://www.drupal.org/project/field_tools">Field Tools</a> modules functionality to Drupal 8, as it pays off to have a single form to clone fields rather than have to add them to the new node type one by one.</p>
<p>Field Tools also copies display settings where form and view modes match (in other words, if the source bundle has a teaser display mode configured, and the destination also has a teaser display mode thats enabled for custom settings, then all of the settings for the fields being cloned are copied over, with field groups too).</p>
<p>With all the new configuration in place, it was now time to get down to the content. This was plain and simple a hack, but one that worked fine for the case in question. Heres how it went</p>
<p>We basically want to change the bundle of a bunch of nodes. (Remember, the bundle is the generic name for a node type. Node types are bundles, as taxonomy vocabularies are bundles.) The data for a single node is spread over lots of tables, and most of these have the bundle in them.</p>
<p>On Drupal 8 these tables are:</p>
<ul>
<li>the entity base table</li>
<li>the entity data table</li>
<li>the entity revision data table</li>
<li>each field data table</li>
<li>each field data revision table</li>
</ul>
<p>(Its not entirely clear to me what the separation between base table and data table is for. It looks like it might be that base table is fields that dont change for revisions, and data table is for fields that do. But then the language is on the base table, and that can be changed, and the created timestamp is on the data table, and while you can change that, I wouldnt have thought thats something that has past values kept. Answers on a postcard.)</p>
<p>So were basically going to hack the bundle column in a bunch of tables. We start by getting the names of these tables from the entity type storage:</p>
<pre><code>$storage = \Drupal::service('entity_type.manager')-&gt;getStorage('node');

// Get the names of the base tables.
$base_table_names = [];
$base_table_names[] = $storage-&gt;getBaseTable();
$base_table_names[] = $storage-&gt;getDataTable();
// (Note that revision base tables don't have the bundle.)
</code></pre>
<p>For field tables, we need to ask the table mapping handler:</p>
<pre><code>$table_mapping = \Drupal::service('entity_type.manager')-&gt;getStorage('node')
  -&gt;getTableMapping();

// Get the names of the field tables for fields on the service node type.
$field_table_names = [];
foreach ($source_bundle_fields as $field) {
  $field_table = $table_mapping-&gt;getFieldTableName($field-&gt;getName());
  $field_table_names[] = $field_table;

  $field_storage_definition = $field-&gt;getFieldStorageDefinition();
  $field_revision_table = $table_mapping
    -&gt;getDedicatedRevisionTableName($field_storage_definition);

  // Field revision tables DO have the bundle!
  $field_table_names[] = $field_revision_table;
}
</code></pre>
<p>(Note the inconsistency in which tables have a bundle field and which dont! For that matter, surely its redundant in all field tables? Does it improve the indexing perhaps?)</p>
<p>Then, get the IDs of the nodes to update. Fortunately, in this case there were only a few, and it wasnt necessary to write a batched hook_update_N().</p>
<pre><code>// Get the node IDs to update.
$query = \Drupal::service('entity.query')-&gt;get('node');
// Your conditions here!
// In our case, page nodes with a certain field populated.
$query-&gt;condition('type', 'page');
$query-&gt;exists(field_in_question);
$nids = $query-&gt;execute();
</code></pre>
<p>And now, loop over the lists of tables names and hack away!</p>
<pre><code>// Base tables have 'nid' and 'type' columns.
foreach ($base_table_names as $table_name) {
  $query = \Drupal\Core\Database\Database::getConnection('default')
    -&gt;update($table_name)
    -&gt;fields(['type' =&gt; 'service'])
    -&gt;condition('nid', $service_nids, 'IN')
    -&gt;execute();
}
// Field tables have 'entity_id' and 'bundle' columns.
foreach ($field_table_names as $table_name) {
  $query = \Drupal\Core\Database\Database::getConnection('default')
    -&gt;update($table_name)
    -&gt;fields(['bundle' =&gt; 'service'])
    -&gt;condition('entity_id', $service_nids, 'IN')
    -&gt;execute();
}
</code></pre>
<p>Node-specific tables use nid and type for their names, because those are the base field names declared in the entity type class, whereas Field API tables use the generic entity_id and bundle. The mapping between these two is declared in the entity type annotations entity_keys property.</p>
<p>This worked perfectly. The update system takes care of clearing caches, so entity caches will be fine. Other systems may need a nudge; for instance, Search API wont notice the changed nodes and its indexes will <a href="https://www.drupal.org/node/2749101">literally need turning off and on again</a>.</p>
<p>Though I do hope that the next time I have to do something like this, the amount of data justifies getting stuck into using Migrate!</p></div>
      
  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/what-goes-drupal-code-builder" rel="bookmark">
<span>What goes on in Drupal Code Builder?</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Sun, 05/15/2016 - 13:13
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p><a href="https://github.com/drupal-code-builder/drupal-code-builder">Drupal Code Builder library</a> is the new library which powers <a href="https://www.drupal.org/project/module_builder">Module Builder</a>. I <a href="http://www.noreiko.com/blog/module-builder-announces-split-due-functionality-differences">recently split Module Builder up</a>, so Drupal Code Builder (DCB) is the engine for generating Drupal code, while what remains in the Module Builder module is just the UI.</p>
<p>DCB is an extensible framework, so if you wanted to have DCB create scaffold code for a particular Drupal component or system, you can.</p>
<p>DCB's API is documented in the README. It's based on the idea of tasks: for example, list the hooks and plugin types that DCB has parsed from the site code, analyze the site code to update that list, or generate code for a module. There are Task classes, and you call public methods on these to do something.</p>
<h2>The generators</h2>
<p>Broadly, there are three things you want to do with DCB: collect and analyze data about a Drupal codebase to learn about hooks and plugin types, report on that data, and actually generate some code.</p>
<p>The Generate task class is where the work of creating code begins. The other task classes are all pretty simple, or at least self-contained, but the Generate task is accompanied by a large number of classes in the DrupalCodeBuilder\Generate namespace. You can see from the file names that these represent all the different components that make up generated code.</p>
<p>Furthermore, as well as all inheriting from BaseGenerator, there are hierarchies which can probably be deduced from the names alone, where more specialized generators inherit from generic ones. For example, we have:</p>
<ul>
<li>File
<ul>
<li>PHPFile
<ul>
<li>ModuleCodeFile</li>
<li>PHPClassFile
<ul>
<li>Plugin</li>
<li>Service</li>
</ul>
</li>
<li>API (this one's for your mymodule.api.php file)</li>
</ul>
</li>
<li>YMLFile</li>
<li>Readme</li>
</ul>
</li>
</ul>
<p>and also:</p>
<ul>
<li>PHPFunction
<ul>
<li>HookImplementation
<ul>
<li>HookMenu</li>
<li>HookPermission</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>However, these hierarchies are only about code re-use. In terms of PHP code, HookImplementation is only related to ModuleCodeFile by the common BaseGenerator base class. As the process of code generation takes place, there will be a tree of components that represents components containing each other, but it's important to remember that class inheritance doesn't come into it.</p>
<p>Also, while the generators in the hierarchies above clearly represent some tangible part of the code we're going to generate, some are more abstract, such as Module and Hooks. These aren't abstract in the OO sense, as they will get instantiated, but I think of them as abstract in the sense that they're not concrete and are responsible for code across different files. (Suggestions for a better word to describe them please!)</p>
<p>The process of generating code starts with a call to the Generate task's generateComponent() method. The host UI application (such as Module Builder module, or the Drush command) passes it an array of data that looks something like this:</p>
<pre><code>[
  'base' =&gt; 'module',
  'root_name' =&gt; 'mymodule,
  'readable_name' =&gt; 'My module',
  'hooks' =&gt; [
    'form_alter' =&gt; TRUE,
    'install' =&gt; TRUE,
  ],
  'plugins =&gt; [
    0 =&gt; [
      'plugin_type' =&gt; 'block',
      'plugin_name' =&gt; 'my_plugin',
      'injected_services' =&gt; [
        'current_user',
      ],
    ],
  ],
  'settings_form' =&gt; TRUE,
  'readme' =&gt; TRUE,
]
</code></pre>
<p>(How you get the specification for this array as a list of properties and their expected format is a detailed topic of its own, which will be covered later. For now, we're jumping in at the point where code is generated.)</p>
<h2>Assembling components</h2>
<p>The first job for the Generate task class is to turn this array of data into a list of generator classes for the necessary components.</p>
<p>This list is built up in a cascade, where each component gets to request further components, and those get to request components too, and so on, until we reach components that don't request anything. We start with the root component that was initially requested, Module, let that request components, and then repeat the process.</p>
<p>This is best illustrated with the AdminSettingsForm generator. This implements the requiredComponents() method to request:</p>
<ul>
<li>a permission</li>
<li>a router item (on Drupal 7 that's a menu item, but in DCB we refer to these a router item whatever the core Drupal version)</li>
<li>a form</li>
</ul>
<p>In turn, the Permission generator requests a permissions YAML file. You'll see that there are two Permission generators, each with a version suffix. The Permission7 generator requests a hook_permission() hook, which in turn requests a .module file. The Permission8 generator is somewhat simpler, and just requests a YMLFile component.</p>
<p>Meanwhile, the router item requests a routing.yml file on D8, and a hook_menu() on D7.</p>
<p>These two parts of the cascade end when we reach the various file generators: ModuleCodeFile and YMLFile don't request anything. The process that gathers all these generators works iteratively: every iteration it calls requiredComponents() on all the components the previous iteration gave it, and it only stops once an iteration produces no new components. It's safe to request the same component multiple times; in the D7 version of our example, both our hook_menu() and hook_permission() will request a ModuleCodeFile component that represents the .module file. The cascade system knows to either combine these two requests into one component, or ignore the second if it's identical to what's already been requested.</p>
<p>We now have a list of about a dozen or so components, each of which is an instantiated Generator object. Some represent files, some represent functions, and some like Hooks represent a more vague concept of the module 'having some hooks'. There's also the Module generator which started the whole process, whose requiredComponents() did most of the work of interpreting the given array of data.</p>
<h2>Assembling a tree of components</h2>
<p>The second part of the process is to assemble this flat list of components into a tree. This is where the notion of which component contains others does come into play. This is a different concept from requested components: a component can request something that it won't end up containing, as we saw with the AdminSettingsForm, which requests a permission.</p>
<p>The Generate task calls the containingComponent() method on each component, and this is used to assemble an array of parentage data. There's nothing fancy or recursive going on here; the tree is just an array whose keys are the identifiers of components, and whose values are arrays of the child component identifiers.</p>
<p>This tree now represents a structure of components where child items will produce code to be included in their parents. One part of this structure could be represented like this:</p>
<ul>
<li>module
<ul>
<li>routing.yml
<ul>
<li>router item</li>
</ul>
</li>
<li>permission.yml
<ul>
<li>permission</li>
</ul>
</li>
<li>.install
<ul>
<li>hook_install()</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Some components, such as the Hooks component, are no longer around now: their job was to be a sort of broker for other components in the requesting phase, and they're no longer involved. The root component, Module, is the root of the tree. All the files we'll be outputting are its immediate children. (This is not a file hierarchy, folders are not represented here.)</p>
<h2>Assembling file contents</h2>
<p>We now have everything we need to start actually generating some code. This is done in a way that's very similar to Drupal's Render API: we recurse into the tree, asking each component to return some content both from itself and its children.</p>
<p>So for example, the router items contribute some lines to the routing.yml file, which then turns them into YAML. The .install component, which is an instance of ModuleCodeFile, produces a @file docblock, and then gets the docblock, function declaration, and function body from the hook_install component, and glues them all together.</p>
<p>Finally, each file component (the immediate children of the module component in the tree) gets to say what its file name and path should be.</p>
<p>So the Generate task has an array of data about files, where each item has a file name, file path, and file contents. This is returned to the caller to be output to the user, or written to the filesystem. Module Builder presents the files in a form, and allows the files to be written. The Drush command outputs them to terminal and optionally writes them too.</p>
<h2>Extending it with new components</h2>
<p>The best way to add new things for DCB to generate is to inherit from existing basic classes. If these dont provide the flexibility, theres always a case to be made to give them more configurable options: for example, the AdminSettingsForm class inherits from Form, but neither of those do very little for the actual generated form class, as the work for that is mostly done by the PHPClass class.</p>
<p>The roadmap for DCB at the moment consists of the following:</p>
<ul>
<li>Generalize the injected services functionality thats already in Plugins, so generated Form classes and Services can have them too.</li>
<li>Add Forms as a basic component that you can request to generate. (Its currently there only as a base for the AdminSettingsForm generator.)</li>
</ul>
<p>And as ever, keep adding tests, keep refactoring and improving the code. But I'm always interested in hearing new ideas (or you know, better yet, patches) in the issue queue.</p></div>
      
  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/lazy-maintainers-handbook-part-1-frequent-releases" rel="bookmark">
<span>The Lazy Maintainer&#039;s Handbook, Part 1: Frequent Releases</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Thu, 03/31/2016 - 00:59
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p><em>Every now and then I think about writing a series of posts called 'The Lazy Maintainer's Handbook', covering various aspects of how to maintain a project (or several) on drupal.org without it being a huge burden on your time (which a lot of people, and companies, think is the case). However, I never get much past the pondering stage. Since it's safe to say that I'm never going to manage to come up with the right order to write these in, I'm just going to start in the middle. Here goes.</em></p>
<p>Like with all software, bugs are a problem in the world of Drupal. In Drupal contrib, like with any software that has releases, we can classify bugs into three types:</p>
<ul>
<li>bugs which are reported, but have no fix,</li>
<li>bugs which have a fix, but the patch hasn't been committed,</li>
<li>bugs which have been fixed, but are not part of a release yet.</li>
</ul>
<p>The first and second type can involve a fair amount of work, and I will cover in another post in the future how much a LM can or should do about them.</p>
<p>The third type though is where the LM can really shine: all that needs to be done here is to make a release. What could be simpler? And let's be clear, making a release is a very quick job. I can do the whole thing in about a minute (though I've not timed it, yet).</p>
<p>For one thing, if you're still writing the release notes by hand, then <em>stop</em>: <a href="https://www.drupal.org/project/grn">Git Release Notes for Drush</a> does that for you.</p>
<p>Here's my process:</p>
<ul>
<li>
<code>$ git tag</code> This lists all the existing tags, so I can see what the next release number should be.</li>
<li>
<code>$ git tag 7.x-1.2</code> This creates the tag for the new release.</li>
<li>At this point, it's a good idea to check this in a graphical git client, to check for stupid mistakes like making the tag on a local development branch, or the wrong major branch. (I've done that at least once.)</li>
<li>
<code>$ git push origin 7.x-1.2</code> This creates the tag on the remote repository.</li>
<li>
<code>$ drush release-notes</code> This creates the release notes, using all the commit messages between the previous commit and the commit you just made. (Another reason to use the <a href="https://www.drupal.org/node/52287">standard format for commit messages</a>: it will turn the #12345 issue numbers into tags for d.org to then render as links.)</li>
<li>Select the output from the command and copy it.</li>
<li>Go to your project's page on d.org and click the 'Add new release' link.</li>
<li>Select the new tag.</li>
<li>Paste the release notes and save the node.</li>
</ul>
<p>I speed this up even more by having a bash alias for 'drush release-notes | pbcopy', which on OS X puts the text output by the Drush command onto the clipboard, so I can skip the selecting and copying step.</p>
<p>It's quick, right? Fun, even! Why don't maintainers do it more often? The reasons I can think of are:</p>
<ul>
<li>the current branch HEAD (and thus -dev release) is unstable and badly broken</li>
<li>maintainers are worried about making releases too frequent and making site builders update all the time</li>
<li>maintainers have fallen prey to the 'just one more fix' syndrome, and are waiting for another issue (or issues) to be resolved.</li>
</ul>
<p>Let's address these shall we?</p>
<h2>The branch is unstable</h2>
<p>This can happen when you're still on alpha releases, and something's caused you to take a new direction in development. This is a tough case: there's no going back, and you're stuck going forward. The only thing I would advise here is to look at the git history since the last release and see if there's a commit between then and now that could be tagged as the next alpha: for instance if the first few commits after the alpha were simple bug fixes. To try to prevent this problem, I recommend making a release immediately before you take a new direction in development, and if it's a very large rewrite, starting a new major branch, even if that means abandoning the 1.x branch at the alpha stage.</p>
<p>If a major rewrite happens and you're on beta releases or stable releases, then you're doing it wrong: a major rewrite should be cause to start a new major branch.</p>
<h2>The last release was recent, and users may dislike frequent releases</h2>
<p>Inspecting and testing new releases takes time. More importantly, perhaps, it has quite a high cognitive cost, as for each module you update, you need to review the release notes to look for any changes that might affect your site's functionality, and any parts of your site's codebase that make use of that module's code. It's also a bit stressful, because if something does break, it could be in a part of the site you don't think to check, so the first you'll hear of it is when your client or project manager calls in a panic two days later.</p>
<p>Understandably then, a lot of developers and site builders put off module updates, or don't bother with them until there's a security release.</p>
<p>This may be a time saving, but I don't believe it's an effort saving. Suppose you're on release 1.0 and releases 1.1 and then 1.2 come along. You can either upgrade to each one when it comes out, or you wait for 1.2 and then upgrade straight to that.</p>
<p>Doing two upgrades seems like more work, because you're only having to check the site once.</p>
<p>But I would counter that it's less overall cognitive load, because each single release has fewer changes. If releases are frequent, and include only up to a dozen or so commits, then it's easier to scan down the list of issues in the release notes, and maybe see that they're all very minor bug fixes, or clearly only affect functionality that your site doesn't use.</p>
<p>Ultimately, I don't think postponing upgrades pays off, because eventually, you'll have to bite the bullet and upgrade past several version numbers. Worse, you may have your hand forced when a security update comes along, and you'll be in the situation of having to read the release notes for all the versions you skipped and assessing them, <em>while your site is on fire</em>.</p>
<p>So I think small, frequent releases are actually a good thing, even from the point of view of existing users.</p>
<p>From the point of view of new users, they're a great thing: new users get better code, with fixed bugs. And that applies to existing users as well of course.</p>
<p>(A future episode in this series will cover an idea I've had for ages, of a metric for when you should do a release: after so many commits or weeks have passed.)</p>
<h2>You're waiting for just one more fix</h2>
<p>Don't. It might never come. In my experience, it probably won't. You'll think to yourself, 'just one more week and someone will review this patch', or 'I'll write a patch for this in the next week'. That week becomes two, and a month, and a year, and even more. I've seen comments on issues called 'Plan for a 1.0 release' where the maintainer says 'I'll make a release in the next two weeks' and that comment is over a year old. I saw one of those comments recently that was two years old. It was mine.</p>
<p>Fight the urge to wait for more fixes. Yes, you want your module to be good, even maybe perfect. But tell yourself: if you release now, you're still making it <em>better</em>. So here's what you need to do:</p>
<ul>
<li>If you're still not on a stable release, release another alpha or beta. The real purpose of unstable releases should be to get people to test your code. You really want them to be testing something recent, not code that's six months old.</li>
<li>If you're on stable releases, just release another one. Those issues you were waiting for can go in the next release (or the one after)</li>
</ul>
<p>Hopefully that should assuage concerns regarding one's responsibility as a maintainer.</p>
<p>But as a <em>lazy</em> maintainer, what's the benefit to you?</p>
<ul>
<li>Your recent fixes are out there and in use. A bug isn't truly eradicated until a release is made that includes the fix.</li>
<li>Fewer duplicate issues filed. With fewer bugs that are fixed in dev but not in a release, there's less chance of people encountering them.</li>
<li>More users, because the age of the most recent release is a metric people use when evaluating a module.</li>
<li>Users are using a more recent version of the code, which means newer bugs are more likely to get caught. (Because seriously, how many people are actually trying out the dev release, unless they're forced to by unreleased fixes?)</li>
</ul>
<p>Get the code out. Dev code serves nobody. Releases are what matters.</p></div>
      
  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/module-builder-announces-split-due-functionality-differences" rel="bookmark">
<span>Module Builder announces split, due to functionality differences</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Sun, 02/28/2016 - 23:28
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>For Drupal 8, <a href="https://www.drupal.org/project/module_builder">Module Builder</a> is undergoing some big changes. It still builds hooks, a README file, an api.php file, permissions, an admin settings form, but now also builds plugins, services, routing items, and its ability to scan your codebase to learn about hooks invented by any of your modules is now extended to plugin types too. And it's actually been available for Drupal 8 for quite some time, but up till now only as the Drush plugin version.</p>
<p>I've now released the D8 version of the module, so you can use an admin UI in Drupal which lets you select the components you want in a form. Unlike Drupal 7 though, the options you enter for your module to generate are stored in a config entity, so you can generate code and then go back and tweak the settings and generate it again, as often as you like.</p>
<p>The big change isn't any of these though. The big change is that Module Builder is being split up.</p>
<p>For a very long time, the Module Builder codebase has been three things in one. Back when I added Drush support (in 2009, according to the git log), it made sense to gradually refactor the code into three parts: the Drupal module UI, the Drush commands, and the common code that does the actual work of generating code based on some parameters (such as which hooks you want, the module name, etc).</p>
<p>That core code has undergone a lot of changes. It's gone from just working with hooks, to a framework that's extensible with new component types. So for example, it's possible to request simply 'an admin form', and the generating code knows to produce the code for the form, the admin permission, and the router item. So that's one component that in fact produces form functions, hook_permission(), hook_menu() on Drupal 7, form class, permissions.yml, routing.yml on Drupal 8. Because Module Builder also works on multiple versions of Drupal (the code to produce Drupal 5 code is even still in there, if you have cause to try it, let me know if it still works!).</p>
<p>Having this multiple-version code within a Drupal module that's only for single version is a source of problems and confusion. The 7.x-2.x version of the project contains a module that's only for Drupal 7, but also the core code and the Drush plugin that both work on all versions. It also increases maintenance work, if we want to the older versions to keep receiving improvements to the generating code.</p>
<p>Hence the split. Module Builder is being divided into three parts:</p>
<ul>
<li>The core code of Module Builder has been moved to a separate library, which is called Drupal Code Builder to distinguish it.</li>
<li>The Module Builder project is from now on just Drupal module, which requires the Drupal Code Builder library.</li>
<li>The Drush plugin will be moving too, and will also require the Drupal Code Builder library.</li>
</ul>
<p>So to summarize, the situation is now as follows:</p>
<ul>
<li>To build modules in a Drupal UI, on Drupal 8, you need:
<ul>
<li>
<a href="https://www.drupal.org/project/module_builder">Module Builder 8.x-3.x</a> (see the README for instructions)</li>
<li>
<a href="https://github.com/drupal-code-builder/drupal-code-builder">Drupal Code Builder library</a>
</li>
</ul>
</li>
<li>To build modules with Drush, on any version, you need:
<ul>
<li>Module Builder 7.x-2.x, installed as a Drush command plugin (again, see the README). But note this will shortly be changing when the Drush command moves out of the d.org project too.</li>
</ul>
</li>
<li>To build modules in a Drupal UI, on Drupal 7, you need:
<ul>
<li>Module Builder 7.x-2.x. I will probably release a 7.x-3.x at some point which requires the Drupal Code Builder library, so that the Drupal 7.x UI gets new features that are released in the library.</li>
</ul>
</li>
</ul>
<p>I'll be writing a post soon about how Drupal Code Builder works, so if you're interested in making Drupal Code Builder make something new, look out for that.</p></div>
      
  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/importing-wysiwyg-image-files-body-text-migrate" rel="bookmark">
<span>Importing wysiwyg image files in body text with Migrate</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Tue, 01/05/2016 - 21:38
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>Migrate module makes the assumption that for each item in your source, you're importing one item into Drupal, and that's baked in pretty deep.</p>
<p>So how do you handle source items where there is body text containing multiple inline images, which should be imported to file entities? For each single source item, ultimately imported as a node, you also have a variable number of images: a one-to-many source to destination relationship.</p>
<p>One way is to simply import the image files at the same time as the nodes whose body text they are in. In the prepareRow() method of your migration class, you effectively do a mini-import, analysing the text, fetching the file data, saving the file locally, and then getting a file ID that you can use to replace into the body text. But doing that, you don't benefit from any of Migrate's helper classes for importing files, nor can you roll these back without writing further code: this isn't a Migration, capital M, it's just an import.</p>
<p>The better way is to write a second migration, to run before your node migration. It may seem like extra work to have to write a second migration class, but it pays off, and besides, since they both draw from the same source data, a lot of your code is already written. Copy-paste the class definition and the constructor as far as the field mappings. The code you would have put in prepareRow() to analyse the text goes somewhere else, but we're getting ahead of ourselves.</p>
<p>And it turns out that Migrate does allow for your single source items to yield multiple destination items: tucked away in the module's source classes and not mentioned in the examples (which do cover a great deal, are probably the most extensive examples of any contrib module all the same, it must be said) there are at least two (that I've found) places where the one-to-one correspondence can be skirted around.</p>
<p>The one that I used is only available when you use the MigrateSourceList source type, and furthermore when your list source is a set of files. As it happened, the source data I was working with on my project came in JSON files, one file per node to import, and with a body text field which contained references to image files which also needed to be imported.</p>
<p>MigrateSourceList is a source type that separates out the two concepts of listing your source items and processing each one. So unlike, say, the CSV source where the list and the item processing are both provided by the one class, with MigrateSourceList, you can say something like 'my list source is a directory listing, and each item is a JSON file', or 'my list source is a JSON file, and each item is an HTML file'. The MigrateSourceList class delegates the two jobs to further classes, which allows you to mix and match them. Your migration specifies them in the constructor:</p>
<pre><code>    $this-&gt;source = new MigrateSourceList(new MigrateListFiles($list_dirs, $base_dir),
      new MigrateItemFile($base_dir), $fields);
</code></pre>
<p>There's one more component in the system, and this is the crucial piece that allows us to have more than one destination item per source item: it's the MigrateContentParser class. This allows the files that MigrateListFiles to each return multiple items to MigrateSourceList.</p>
<p>The only implementation of this in Migrate is MigrateSimpleContentParser, which doesn't do much, so you'll want to subclass this for your particular case. It's fairly simple:</p>
<ul>
<li>setContent()  perform any processing on the content of the file. In my case, I needed to run it through drupal_json_decode() and grab the body text field, since the whole file was JSON representing a node.</li>
<li>getChunkCount()  process the file content to return a count of how many items for migration are contained in it.</li>
<li>getChunkIDs()  similar to getChunkCount(), but return IDs. You will probably end up using a common helper method for this and getChunkCount(), as they do the same sort of work. The IDs you return can be anything you like; in my case they were GUIDs. They are appended to the ID for the file to form the overall source ID.</li>
<li>getChunk()  given a chunk ID (one of the ones you provided in getChunkIDs()), return the actual data for that item. Again, you may want to use a common helper. In my case, here I merely returned the ID itself, since the images to migrate were on a remote server and accessed by their GUID.</li>
</ul>
<p>I submitted a patch to make it a bit easier to deal with the case where files might contain either one or many chunks (or even none): by default, a file providing only one chunk doesn't get to return a chunk ID, which wasn't working for my case. The patch (committed but not yet in a release) adds <a href="https://www.drupal.org/node/2550793">an option to override this</a> so you always know the ID of the chunk: in my case, the GUID for the image found inside the body text, which was always needed by the image migration code.</p>
<p>At the other end, I needed a custom subclass of MigrateItem to deal with the data returned by getChunk(). This just needs to implement getItem(), and it can pretty much return anything you like: this is the same source data item that your migration class gets to work with.</p>
<p>So to recap, as there's quite a few classes flying around helping one another here, we have MigrateListFiles which uses a custom MigrateContentParser implementation to extract items from the source data files, with possibly more than one item from a single file, and then MigrateSourceList uses MigrateListFiles along with a custom MigrateItem implementation.</p>
<p>The setup code in my migration's constructor then looks like this:</p>
<pre><code>    $parser = new CustomJSONBodyImagesParser();
    $list = new MigrateListFiles(
      // $list_dirs
      array($source_folder),
      // $base_dir
      $source_folder,
      // $file_mask
      '//',
      // $options
      array(),
      // MigrateContentParser $parser
      $parser
    );
    $item = new CustomImageGUIDItem();
    $this-&gt;source = new MigrateSourceList($list, $item, $fields);
</code></pre>
<p>The end result worked great, and the ability to rollback turned out to be very useful, when there turned out to be bad data here and there that needed to be cleaned up or skipped. But that's what always happens with migrations in my experience!</p></div>
      
  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/script-making-patches" rel="bookmark">
<span>A script for making patches</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Fri, 03/27/2015 - 13:46
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>I have a standard format for patchnames: 1234-99.project.brief-description.patch, where 1234 is the issue number and 99 is the (expected) comment number. However, it involves two copy-pastes: one for the issue number, taken from my browser, and one for the project name, taken from my command line prompt.</p>
<p>Some automation of this is clearly possible, especially as I usually name my git branches 1234-brief-description. More automation is less typing, and so in true XKCD condiment-passing style, I've now written that script, which you can find on github as <a href="https://github.com/joachim-n/dorgpatch">dorgpatch</a>. (The hardest part was thinking of a good name, and as you can see, in the end I gave up.)</p>
<p>Out of the components of the patch name, the issue number and description can be deduced from the current git branch, and the project from the current folder. For the comment number, a bit more work is needed: but drupal.org now has a public API, so a simple REST request to that gives us data about the issue node including the comment count.</p>
<p>So far, so good: we can generate the filename for a new patch. But really, the script should take care of doing the diff too. That's actually the trickiest part: figuring out which branch to diff against. It requires a bit of git branch wizardry to look at the branches that the current branch forks off from, and some regular expression matching to find one that looks like a Drupal development branch (i.e., 8.x-4.x, or 8.0.x). It's probably not perfect; I don't know if I accounted for a possibility such as 8.x-4.x branching off a 7.x-3.x which then has no further commits and so is also reachable from the feature branch.</p>
<p>The other thing this script can do is create a tests-only patch. These are useful, and generally advisable on drupal.org issues, to demonstrate that the test not only checks for the correct behaviour, but also fails for the problem that's being fixed. The script assumes that you have two branches: the one you're on, 1234-brief-description, and also one called 1234-tests, which contains only commits that change tests.</p>
<p>The git workflow to get to that point would be:</p>
<ol>
<li>Create the branch 1234-brief-description
</li>
<li>Make commits to fix the bug
</li>
<li>Create a branch 1234-tests
</li>
<li>Make commits to tests (I assume most people are like me, and write the tests after the fix)
</li>
<li>Move the string of commits that are only tests so they fork off at the same point as the feature branch: git rebase --onto 8.x-4.x 1234-brief-description 1234-tests
</li>
<li>Go back to 1234-brief-description and do: git merge 1234-tests, so the feature branch includes the tests.
</li>
<li>If you need to do further work on the tests, you can repeat with a temporary branch that you rebase onto the tip of 1234-tests. (Or you can cherry-pick the commits. Or do cherry-pick with git rev-list, which is a trick I discovered today.)
</li>
</ol>
<p>Next step will be having the script make an interdiff file, which is a task I find particularly fiddly.</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/46" hreflang="en">git</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/49" hreflang="en">patching</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/54" hreflang="en">drupal.org</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/55" hreflang="en">workflow</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/git-based-patch-workflow-drupalorg-interdiffs-free" rel="bookmark">
<span>A git-based patch workflow for drupal.org (with interdiffs for free!)</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Thu, 11/27/2014 - 08:39
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>There's been a lot of discussion about how we need github-like features on d.org. Will we get them? There's definitely many improvements in the pipeline to the way our issue queues work. Whether we actually need to replicate github is another debate (and my take on it is that I don't think we do).</p>
<p>In the meantime, I think that it's possible to have a good collaborative workflow with what we have right now on drupal.org, with just the issue queue and patches, and git local branches. Here's what I've gradually refined over the years. It's fast, it helps you keep track of things, and it makes the most of git's strengths.</p>
<h2>A word on local branches</h2>
<p>Git's killer feature, in my opinion, is local branches. Local branches allow you to keep work on different issues separate, and they allow you to experiment and backtrack. To get the most out of git, you should be making small, frequent commits.</p>
<p>Whenever I do a presentation on git, I ask for a show of hands of who's ever had to bounce on CMD-Z in their text editor because they broke something that was working five minutes ago. Commit often, and never have that problem again: my rule of thumb is to commit any time that your work has reached a state where if subsequent changes broke it, you'd be dismayed to lose it.</p>
<h2>Starting work on an issue</h2>
<p>My first step when I'm working on an issue is obviously:</p>
<div class="codeblock"><code>&nbsp; git pull</code></div>
<p>This gets the current branch (e.g. 7.x, 7.x-2.x) up to date. Then it's a good idea to reload your site and check it's all okay. If you've not worked on core or the contrib project in question in a while, then you might need to run update.php, in case new commits have added updates.</p>
<p>Now start a new local branch for the issue:</p>
<div class="codeblock"><code>&nbsp; git checkout -b 123456-foobar-is-broken</code></div>
<p>I like to prefix my branch name with the issue number, so I can always find the issue for a branch, and find my work in progress for an issue. A description after that is nice, and as git has bash autocompletion for branch names, it doesn't get in the way. Using the issue number also means that it's easy to see later on which branches I can delete to unclutter my local git checkout: if the issue has been fixed, the branch can be deleted!</p>
<p>So now I can go ahead and start making commits. Because a local branch is private to me, I can feel free to commit code that's a total mess. So something like:</p>
<div class="codeblock"><code>&nbsp; dpm($some_variable_I_needed_to_examine);<br>&nbsp; /*<br>&nbsp; // Commented-out earlier approach that didn't quite work right.<br>&nbsp; $foo += $bar;<br>&nbsp; */<br>&nbsp; // Badly-formatted code that will need to be cleaned up.<br>&nbsp; if($badly-formatted_code) { $arg++; }</code></div>
<p>That last bit illustrates an important point: commit code before cleaning up. I've lost count of the number of times that I've got it working, and cleaned up, and then broken it because I've accidentally removed an important line that was lost among the cruft. So as soon as code is working, I make a commit, usually whose message is something like 'TOUCH NOTHING IT WORKS!'. Then, start cleaning up: remove the commented-out bits, the false starts, the stray code that doesn't do anything, in small commits of course. (This is where you find it actually does, and breaks everything: but that doesn't matter, because you can just revert to a previous commit, or even use git bisect.)</p>
<h2>Keeping up to date</h2>
<p>Core (or the module you're working on) doesn't stay still. By the time you're ready to make a patch, it's likely that there'll be new commits on the main development branch (with core it's almost certain). And before you're ready, there may be commits that affect your ongoing work in some way: API changes, bug fixes that you no longer need to work around, and so on.</p>
<p>Once you've made sure there's no work currently uncommitted (either use git stash, or just commit it!), do:</p>
<div class="codeblock"><code>git fetch<br>git rebase BRANCH</code></div>
<p>where BRANCH is the main development branch that is being committed to on drupal.org, such as 8.0.x, 7.x-2.x-dev, and so on.</p>
<p>(This is arguably one case where a local branch is easier to work with than a github-style forked repository.)</p>
<p>There's lots to read about rebasing elsewhere on the web, and some will say that rebasing is a terrible thing. It's not, when used correctly. It can cause merge conflicts, it's true. But here's another place where small, regular commits help you: small commits mean small conflicts, that shouldn't be too hard to resolve.</p>
<h2>Making a patch</h2>
<p>At some point, I'll have code I'm happy with (and I'll have made a bunch of commits whose log messages are 'clean-up' and 'formatting'), and I want to make a patch to post to the issue:</p>
<div class="codeblock"><code>&nbsp; git diff 7.x-1.x &gt; 123456.PROJECT.foobar-is-broken.patch</code></div>
<p>Again, I use the issue number in the name of the patch. Tastes differ on this. I like the issue number to come first. This means it's easy to use autocomplete, and all patches are grouped together in my file manager and the sidebar of my text editor.</p>
<h2>Reviewing and improving on a patch</h2>
<p>Now suppose Alice comes along, reviews my patch, and wants to improve it. She should make her own local branch:</p>
<div class="codeblock"><code>&nbsp; git checkout -b 123456-foobar-is-broken</code></div>
<p>and download and apply my patch:</p>
<div class="codeblock"><code>&nbsp; wget PATCHURL<br>&nbsp; patch -p1 &lt; 123456.PROJECT.foobar-is-broken.patch</code></div>
<p>(Though I would hope she has a bash alias for 'patch -p1' like I do. The other thing to say about the above is that while wget is working at downloading the patch, there's usually enough time to double-click the name of the patch in its progress output and copy it to the clipboard so you don't have to type it at all.)</p>
<p>And finally commit it to her branch. I would suggest she uses a commit message that describes it thus:</p>
<div class="codeblock"><code>&nbsp; git commit -m "joachim's patch at comment #1"</code></div>
<p>(Though again, I would hope she uses a GUI for git, as it makes this sort of thing much easier.)</p>
<p>Alice can now make further commits in her local branch, and when she's happy with her work, make a patch the same way I did. She can also make an interdiff very easily, by doing a git diff against the commit that represents my patch.</p>
<h2>Incorporating other people's changes to ongoing work</h2>
<p>All simple so far. But now suppose I want to fix something else (patches can often bounce around like this, as it's great to have someone else to spot your mistakes and to take turns with). My branch looks like it did at my patch. Alice's patch is against the main branch (for the purposes of this example, 7.x-1.x).</p>
<p>What I want is a new commit on the tip of my local branch that says 'Alice's changes from comment #2'. What I need is for git to believe it's on my local branch, but for the project files to look like the 7.x-1.x branch. With git, there's nearly always a way:</p>
<div class="codeblock"><code>&nbsp; git checkout 7.x-1.x .</code></div>
<p>Note the dot at the end. This is the filename parameter to the checkout command, which tells git that rather than switch branches, you want to checkout just the given file(s) while staying on your current branch. And that the filename is a dot means we're doing that for the entire project. The branch remains unchanged, but all the files from 7.x-1.x are checked out.</p>
<p>I can now apply Alice's patch:</p>
<div class="codeblock"><code>&nbsp; wget PATCHURL<br>&nbsp; patch -p1 &lt; 123456.2.PROJECT.foobar-is-broken.patch</code></div>
<p>(Alice has put the comment ID after the issue ID in the patch filename.)</p>
<p>When I make a commit, the new commit goes on the tip of my local branch. The commit diff won't look like Alice's patch: it'll look like the difference between my patch and Alice's patch: effectively, an interdiff. I now make a commit for Alice's patch:</p>
<div class="codeblock"><code>&nbsp; git commit -m "Alice's patch at comment #2"</code></div>
<p>I can make more changes, then do a diff as before, post a patch, and work on the issue advances to another iteration.</p>
<p>Here's an example of my local branch for an issue on Migrate I've been working on recently. You can see where I made a bunch of commits to clean up the documentation to get ready to make a patch. Following that is a commit for the patch the module maintainer posted in response to mine. And following that are a few further tweaks that I made on top of the maintainer's patch, which I then of course posted as another patch.</p>
<p><img src="sites/default/files/article/image/git-local-branch-issue-workflow.png" width="457" height="257" alt="A screenshot of a git GUI showing the tip of a local branch, with a commit for a patch from another user."></p>
<p>(Notice how in a local branch, I don't feel the need to type terribly accurately for my commit messages, or indeed be all that clear.)</p>
<h2>Improving on our tools</h2>
<p>Where next? I'm pretty happy with this workflow as it stands, though I think there's plenty of scope for making it easier with some git or bash aliases. In particular, applying Alice's patch is a little tricky. (Though the stumbling block there is that you need to know the name of the main development branch. Maybe pass the script the comment URL, and let it ask d.org what the branch of that issue is?)</p>
<p>Beyond that, I wonder if any changes can be made to the way git works on d.org. A sandbox per issue would replace the passing around of patch files: you'd still have your local branch, and merge in and push instead of posting a patch. But would we have one single branch for the issue's development, which then runs the risk of commit clashes, or start a new branch each time someone wants to share something, which adds complexity to merging? And finally, sandboxes with public branches mean that rebasing against the main project's development can't be done (or at least, not without everyone know how to handle the consequences). The alternative would be merging in, which isn't perfect either.</p>
<p>The key thing, for me, is to preserve (and improve) the way that so often on d.org, issues are not worked on by just one person. They're a ball that we take turns pushing forward (snowball, Sisyphean rock, take your pick depending on the issue!). That's our real strength as a community, and whatever changes we make to our toolset have to be made with the goal of supporting that.</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/46" hreflang="en">git</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/6" hreflang="en">drupal planet</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/48" hreflang="en">issue queue</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/49" hreflang="en">patching</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/building-fast-and-flexible-application-uis-entity-operations" rel="bookmark">
<span>Building Fast and Flexible Application UIs with Entity Operations</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Tue, 11/18/2014 - 13:38
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>Now I've finished the Big Monster Project of Doom that I've been on the last two years, I can talk more about some of the code that I wrote for it. I can also say what it was: it was a web application for activists to canvass the public for a certain recent national referendum (I'll let you guess which one).</p>
<p>One of the major modules I wrote was <a href="https://www.drupal.org/project/entity_operations">Entity Operations</a> module. What began as a means to avoid repeating the same code each time I needed a new entity type soon became the workhorse for the whole application UI.</p>
<p>The initial idea was this: if you want a custom entity type, and you want a UI for adding, editing, and deleting entities (much like with nodes), then you have to build this all yourself: hook_menu() items, various entity callbacks, form builders (and validation and submit handlers) for the entity form and the delete confirmation form. (The <a href="https://www.drupal.org/project/model">Model module</a> demonstrates this well.)</p>
<p>That's a lot of boilerplate code, where the only difference is the entity type's name, the base path where the entity UI sits, and the entity form builder itself (but even that can be generalized, as will be seen).</p>
<p>Faced with this and a project on which I knew from the start I was going to need a good handful of custom entities (for use with Microsoft Dynamics CRM, accessed with another custom module of mine, <a href="http://drupal.org/project/remote_entity">Remote Entity API</a>), I undertook to build a framework that would take away all the repetition.</p>
<p>An Entity UI is thus built by declaring:</p>
<ul>
<li>A base path (for nodes, this would be 'node'; we'll ignore the fact that in core, this path itself is a listing of content).</li>
<li>A list of subpaths to form the tabs, and the operation handler class for each one</li>
</ul>
<p>With this in hand, why stop at just the entity view and edit tabs? The operation handlers can output static content or forms: they can output anything. One of the most powerful enhancements I made to this early on was to write an operations handler that outputs a view. It's the same idea as the <a href="http://drupal.org/project/eva">EVA</a> module.</p>
<p>So for the referendum canvassing application, I had a custom Campaign entity, that functioned as an Organic Group, and had as UI tabs several different views of members, views of contacts in the Campaign's geographic area, views of Campaign group content (such as tasks and contact lists), and so on.</p>
<p>This approach proved very flexible and quick. The group content entities were themselves also built with this, so that, for example, Contact List entities had operations for a user to book the entity, input data, and release it when done working on it. These were built with custom operation handlers specific to the Contact List entity, subclassing the generic form operation handler.</p>
<p>An unexpected bonus to all this was how easy it was to expose form-based operations to Views Bulk Operations and Services (as 'targeted actions' on the entity). This allowed the booking and release operations to work in bulk on views, and also to be done via a mobile app over Services.</p>
<p>A final piece of icing on the cake was the addition of alternative operation handlers for entity forms that provide just a generic bare bones form that invokes Field API to attach field widgets. With these, the amount of code needed to build a custom entity type is reduced to just three functions:</p>
<ul>
<li>hook_entity_info(), to declare the entity type to Drupal core</li>
<li>hook_entity_operations_info(), to declare the operations that make up the UI</li>
<li><a href="https://www.drupal.org/node/2240921">callback_entity_access()</a>, which controls the access to the operations</li>
</ul>
<p>The module has a few further tricks up its sleeve. If you're using user permissions for your entities, there's a helper function to use in your hook_permission(), which creates permissions out of all the operations (so: 'edit foobar entities', 'book foobar entities', 'discombobulate foobar entities' and so on). The entity URI callback that Drupal core requires you to have can be taken care of by a helper callback which uses the entity's base path definition. There's a form builder that lets you easily embed form-based operations into the entity build, so that you can put the sort of operations that are single buttons ('publish', 'book', etc) on the entity rather than in a tab. And finally, the links to operation tabs can be added to a view as fields, allowing a list of entities with links to view, edit, book, discombobulate, and so on.</p>
<p>So what started as a way to simplify and remove repetitive code became a system for building a whole entity-based UI, which ended up powering the whole of the application.</p>
</div>
      
  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/graphing-relationships-between-entity-types" rel="bookmark">
<span>Graphing relationships between entity types</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Sun, 08/31/2014 - 21:00
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>Another thing that was developed as a result of my big Commerce project (see <a href="http://www.noreiko.com/blog/ripple-effect">my previous blog post for the run-down of the various modules this contributed back to Drupal</a>) was a bit of code for generating a graph that represents the relationships between entity types.</p>
<p>For a site with a lot of entityreference fields it's a good idea to draw diagrams before you get started, to figure out how everything ties together. But it's also nice to have a diagram that's based on what you've built, so you can compare it, and refer back to it (not to mention that it's a lot easier to read than my handwriting).</p>
<p>The code for this never got released; I tried various graph engines that work with <a href="https://www.drupal.org/project/graphapi">Graph API</a>, but none of them produced quite what I was hoping for. It just sat in my local copy of Field Tools for the last couple of years (I didn't even make a git branch for it, that shows how rough it was!). Then yesterday I came across the <a href="http://sigmajs.org/">Sigma.js graph library</a>, and that inspired me to dig out the code and finish it off.</p>
<p>To give the complete picture, I've added support for the relationships that are formed between entity types by their schema fields: things like the uid property on a node. These are easily picked out of hook_schema()'s foreign keys array.</p>
<p>In the end, I found Sigma.js wasn't the right fit: it looks very pretty, but it expects you to dictate the position of the nodes in the canvass, which for a generated graph doesn't really work. There is a plugin for it that allows the graph to be force-directed, but that was starting to be too fiddly. Instead though, I found <a href="http://getspringy.com/">Springy</a>, that while maybe not quite as versatile, automatically lays out the graph nodes out of the box. It didn't take too long to write <a href="https://www.drupal.org/sandbox/joachim/2330333">a library module for using Springy with Graph API</a>.</p>
<p>Here's the result:</p>
<p><img src="sites/default/files/article/image/field-tools-graph-springy_0.png" width="785" height="487" alt="Graph showing relationships between entity types on a development Drupa site"></p>
<p>Because this uses Graph API, it'll work with any graph engine, not just Springy. So I'll be interested to see what people who are more familiar with graphing can make it do. To get something that looks like the above for your site, it's simple: install the 7.x-1.x-dev release of <a href="http://drupal.org/project/field_tools">Field Tools</a>, install <a href="https://www.drupal.org/project/graphapi">Graph API</a>, install <a href="https://www.drupal.org/sandbox/joachim/2330333">the Springy module</a>, and follow the instructions in the README of that last module for installing the Springy Javascript library.</p>
<p>The next stage of development for this tool is figuring out a nice way of showing entity bundles. After all, entityreference fields are on specific bundles, and may point to only certain bundles. However, they sometimes point to all bundles of an entity type. And meanwhile, schema properties are always on all bundles and point to all bundles. How do we represent that without the graph turning into a total mess? I'm pondering adding a form that lets you pick which entity types should be shown as separate bundles, but it's starting to get complicated. If you have any thoughts on this, or other ways to improve this feature, please share them with me in the Field Tools issue queue!</p>
</div>
      
  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/getting-module-builder-ready-drupal-8" rel="bookmark">
<span>Getting Module Builder ready for Drupal 8</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Tue, 08/19/2014 - 08:12
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>I've just made a commit to <a href="https://www.drupal.org/project/module_builder">Module Builder</a> that adds unit tests. This is a big deal, because having these frees me up to start making the big changes that are needed for supporting Drupal 8's new structures: routes, plugins, forms, and so on.</p>
<p>The biggest challenge is going to be the interface. Currently, you give Module Builder just a module name and a list of hook names, and it does the necessary. On the command line it's nice and simple:</p>
<div class="codeblock"><code>drush mb mymodule install schema node_insert form_alter views_data_alter</code></div>
<p>The first parameter is the module name, and everything that follows is a hook name. Now we add to the mix requests such as a form called MyModuleCakeToppingForm, or an entity type plugin, or a route bake_my_cake and its page controller. How to elegantly specify all that over the command line, without making it horribly unwieldy and impossible to remember how to use?</p>
<p>It's also going to be an interesting exercise in reading my own documentation and seeing how much sense it makes after something like 7 months away from the code.</p>
<p>From what I recall, Module Builder uses a hierarchy of component generators to build your module. Taking our example above, the first thing that happens is that the Module generator class kicks in. 'So, you want a module, do you?' it asks, 'You'll need some of these.' And it begins to assemble a list of further generators, for the components it needs: an info file, and the hooks generator. The hooks generator does the actual job of examining your list of requested hooks, and decides based on that that you need three code files: a .module, a .install, and a .views.inc. So by now we have a tree of generators like this:</p>
<pre>
- Module
-- Info file
-- Hooks
--- Code file: .module
--- Code file: .install
--- Code file: .views.inc
</pre><p>
This is not a class hierarchy; this is a tree of objects where each generator has a list of the generators beneath it, and is responsible for collecting data from them. Once we have the tree, we iteratively have each generator assemble the data it wants to contribute, starting with the Module generator at the top.</p>
<p>The original plan when I wrote this system was to make the smallest granularity be a file. The leaves of the generator tree would assemble the text for their file's contents, and the Module generator would collect the files up and return them to the caller for output (either in the UI, or to write them directly).</p>
<p>However, while the original intention of this system was that it could be generalised to base components other than modules (so profiles and themes, which are both supported to some extend but lack the UI, see above!), it's also proven to be extendable downwards to smaller components, and to be worthwhile to do so.</p>
<p>Enter the Form generator. Once we have a generic Function generator (and its child class the HookImplementation), we can create a Form generator. Given a form machine name, 'foo_form', it simply knows to add three copies of the Function generator: 'foo_form', 'foo_form_validate', 'foo_form_submit', along with the correct parameters and some boiler plate code.</p>
<p>And we can specialize this further: the AdminSettingsForm simply extends the Form generator, and adds a menu item component, which itself ensures hook_menu() is requested.</p>
<p>At this point it starts to get a bit complicated, as we have components that request other components that are in totally different parts of the component tree. That's the point at which I think I was when I realized I needed tests so that I can refactor and clean up the messy bits of this, and enhance and extend it, without breaking what's already there.</p>
<p>So that's the current state of Module Builder: not yet ready for Drupal 8, but has lots of potential. At this point, I'd really welcome input on the Drush interface, as that's the big quandary. And any input on new Drupal 8 component generators would be great too; there are a few open issues in the queue. And finally, Module Builder is a complex beast; should anyone looking at the code find it baffling and impenetrable, do please file a documentation issue to highlight the problem and request clarification.</p>
</div>
      
  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/using-human-queue-worker-process-comments" rel="bookmark">
<span>Using Human Queue Worker to process comments</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Sat, 08/09/2014 - 09:44
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>Some time ago, I released <a href="https://www.drupal.org/project/human_queue_worker">Human Queue Worker</a>, a module that takes the concept of the Drupal Queue system, but where the processing of the items is done by human users rather than an automated process. I say 'takes the concept'; it in fact uses the Drupal Queue to create and claim queue items, but instead of declaring your queue with <a href="http://api.drupal.org/api/function/hook_cron_queue_info/7">hook_cron_queue_info()</a>, you declare it to Human Queue Worker as a queue that humans will be working on.</p>
<p>This was written for my current project and for a fairly specific need, and I didn't imagine many sites would be using it. However, it has an obvious and popular application: approving comments. I always figured it would be nice if someone wrote a little module to define a comment processing human queue.</p>
<p>Well, that someone is me, and the time is now. You see, I'm an idiot: when I set up this new blog site of mine, I totally forgot to set up a CAPTCHA, and then when I added Mollon, I didn't set it up properly. So this site has a few hundred spammy comments that I need to delete.</p>
<p>The problem is that comment management takes time. Unless there are some magical area of the core UI I've completely missed, I can either visit each node and delete them one by one, or use the comment admin form. There, I can mass-delete the ones with obvious spammy titles, but all the others will still need individual inspection.</p>
<p>The Human Queue UI simplifies this hugely. There's just one page for the queue. When you go to that page, you're presented with an item to process. In the case of comment approval, that's the comment itself, plus the parent node and parent comment to give you some context. To process the comment, click one of two buttons: 'Publish' or 'Delete'. The comment is dealt with, and the form reloads, with a brand new comment for you to process. Which means that the only clicking you do is the action buttons: Publish; Delete; Publish; Delete. (Though with the amount of spam on my site, it's probably Delete; Delete; Delete, like the Cybermen.)</p>
<p>I've not timed it, but I reckon I can probably go at quite a rate. And that's with just one of me: the core Queue system guarantees that only one worker can claim an item at any one time, and that applies to human workers too. So if another user were to work the queue too, by going to the same page, they would be getting shown different comments to work on, and we'd work through the comments at twice the rate.</p>
<p>Now I just need to find a compliant friend and make them into my worker drone. If you're interested, please don't post a comment!</p>
</div>
      
  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/ripple-effect" rel="bookmark">
<span>The ripple effect</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Fri, 07/11/2014 - 19:21
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>Hello! I'm back. I've not made any blog posts in over a year and a half due to the site where my blog was before, drupaler.co.uk, closing down. And while it took me some time to get round to writing a Migrate script to import my posts from the old site's database, it was actually getting round to setting up this new domain that took the longest.</p>
<p>So what have I been doing all this time? Especially as I still don't have a single Drupal 7 site out there to my name? Well, these days I work on a humongous web application which has kept me busy for the last 18 months; it's a large Drupal site (we hit a million of one of its several custom entity types recently), but to the general public it's just a login page. I may talk more about the development challenges in future posts. </p>
<p>Prior to that, I was building what would have been one of the earliest big Drupal Commerce sites to launch... except that very shortly before launch in October 2012, the whole project got canned.</p>
<p>That was obviously rather demoralizing, as it had been a year in the building. However, it's interesting to look back and see just how much a large-scale project can contribute back to the Drupal community. The following is a list of the contrib modules that were created as part of the development of the project. Many of them are pretty simple; many of them don't get that much use. But they get some, and so it's interesting to see how much code a project can share if development is steered towards reusability, and also how a single project, even one that never sees the light of day, can have effects that ripple out and benefit many others. </p>
<h2><a href="https://www.drupal.org/project/reference_option_limit">Reference field option limit</a></h2>
<p>This was built to improve the UI for selecting terms from large taxonomies, where one vocabulary groups another. For example, you could have a huge vocabulary of cities, and a smaller one of cities. Each city term has a term reference to the country it belongs to (the glee of the early days of Drupal 7: all the fields on all the things!), and the entity that you want to tag (in my case a product) has term reference fields to both the country and the city. The way this module works is that the city terms shown in one widget are filtered each time you change the selected country term in the other field's widget. So you select 'France' and the city field widget updates with AJAX to show only cities in France.</p>
<p>It sounds simple to explain (I hope!), but involves a fair amount of work under the hood in the form alteration to pull it off. It's one of my most popular modules, and has received a fair number of patches from other users.</p>
<h2><a href="https://www.drupal.org/project/devel_contrib">Devel Contrib</a> and <a href="https://www.drupal.org/project/field_tools">Field Tools</a></h2>
<p>These two are developer modules. Devel Contrib arose from my constantly needing to dsm() the data from info hooks such as hook_views_data() and hook_entity_property_info(). When the thing you're developing keeps going wrong, one of first things to do is poke around to check you've properly declared everything to the APIs you're using. I started out just having this as a couple of menu items declared in a custom module, but pretty soon I added more, and I wanted it on other development sites, so the obvious thing to do was clean it up and release it. </p>
<p>Field Tools was something I wrote because the Commerce site in question had dozens of different product types and corresponding node types, with lots of common fields, and I really didn't want to spend hours clicking through the field admin UI to set them up. This may seem like a case of <a href="http://xkcd.com/974/">condiment-passing</a>, but I'm sure it's saved me hours of tedium: create the fields once, and then quickly clone them to any other entity types and bundles.</p>
<h2><a href="https://www.drupal.org/project/field_instance_cardinality">Field Instance Cardinality</a></h2>
<p>A very small tweak module, this lets you override a particular instance of a multi-valued field and set it to be single-valued only. It's a hook_form_alter() hack made reusable by adding some field admin settings, and a good example of how site customization can often be done as modules rather than alter hacks.</p>
<h2><a href="https://www.drupal.org/project/field_formatter_value_link">Field Value Link Formatter</a></h2>
<p>Very simple module: your taxonomy term fields (or other entity references) should link to a view with an entity ID argument. I guess the more traditional way of doing this is with a lot of path aliases for your taxonomy terms. I think we may also have used this to create Profile-style lists of related entities.</p>
<h2><a href="https://www.drupal.org/project/commerce_shipping_weight_tariff">Commerce Shipping Weight Tariff</a></h2>
<p>This was created to deal with the complex business rules we had for shipping costs. Written very near to our planned launch date, it's an example of what I call the 'skimp on the admin UI' contrib module: hardcode the settings, but do so in a way that's cleanly separated from the rest of the module, so that later on an admin UI can be added, perhaps contributed as a patch. Though I think that's yet to materialize for this one.</p>
<h2><a href="https://www.drupal.org/project/views_grouped_table">Views Grouped Table</a></h2>
<p>This was created to help keep track of how the product entities and product display nodes all related to one another.</p>
<h2><a href="https://www.drupal.org/project/views_dependent_filters">Views Dependent Filters</a></h2>
<p>Allows the presence of exposed filters on a view to be controlled by values in another exposed filter. This was intended to handle filtering Views of products, though we later switched to using Views with Solr.</p>
<h2><a href="http://drupal.org/project/taxonomy_add_previous">Taxonomy add previous</a></h2>
<p>A little bit of UX sugar for when you're adding lots of taxonomy terms that are very similar. In our case, this was terms representing sizes. On creating a new term, this takes you straight back to the form for adding another term, and prefills the field values from the one you just added.</p>
<h2><a href="https://www.drupal.org/project/flag_expire">Flag Expire</a></h2>
<p>Allows flags to have either an expiry date, or an expiry period. This was going to be used to feature products, or mark them as new, or discounted. (For new product, you could just automatically mark all products that were created in the last x days, say. But as I recall, the client didn't want ALL new products marked, just selected ones. The way clients do.)</p>
<p>As well as new contrib modules, the project resulted in work on existing contrib modules, in particular Flag, Data, Views Hacks, and Commerce Delivery.</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/52" hreflang="en">contributing code</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/41" hreflang="en">drupal commerce</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/3" hreflang="en">development</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/53" hreflang="en">maintaining projects</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/corralling-permissions-grid" rel="bookmark">
<span>Corralling permissions into a grid</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Sun, 10/28/2012 - 09:55
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>I've just released <a href="http://drupal.org/project/permission_grid">Permissions Grid</a>. It does what the name suggests: it presents related permissions in a grid, rather than the usual long list.</p>
<p>How are permissions structured into a grid? Well, only the ones that form natural groups are included: every set of permissions of the form 'create foo, edit foo, delete foo, create bar, edit bar, delete bar' is turned into a matrix of checkboxes with the <i>verbs</i> 'create, edit, delete' along the top, and the <i>objects</i> 'foo, bar' along the top. When modules such as node, taxonomy, and commerce define related permissions for nodes, vocabularies, and products respectively, that gives you something like this:</p>
<p><img src="sites/default/files/article/image/joachim-permission-grid-module.png"></p>
<p>This gives an easy to grasp overview of what a role can do with different objects on the site: which node types can this role create? which can they edit, or delete? which product types can they edit? which vocabularies can they create terms in? </p>
<p>If this sounds and looks vaguely familiar, that's probably because this module has an ancestor: my Drupal 6 module <a href="http://drupal.org/project/node_permissions_grid">node permissions grid module</a>, which I wrote back when a site's content types started to become too numerous to easily make sense of. That operated only on node types, and like a great many contrib modules porting to Drupal 7, it's had to 'drop the node' and generalize. But in fact nothing restricts Permissions Grid to entities: all it cares about is permissions.</p>
<p>Structured permissions are declared to the module in <a href="http://drupalcode.org/project/permission_grid.git/blob/refs/heads/7.x-1.x:/permission_grid.api.php">an info hook</a>, and each module may declare multiple sets of permissions. This allows for the fact that some modules add further vocabulary-related permissions which do not have the same pattern, and that commerce has entity permissions in both singular and plural form.</p>
<p>Are there any groups of permissions I've missed, whether in core or contrib? Post a feature request, or better still, take a look at the <a href="http://drupalcode.org/project/permission_grid.git/blob/refs/heads/7.x-1.x:/permission_grid.permissions.inc">hook implementations already there</a> and file a patch.</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/6" hreflang="en">drupal planet</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/51" hreflang="en">permissions</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/1" hreflang="en">drupal</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/41" hreflang="en">drupal commerce</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/rules-versus-hooks-or-abstraction-shock" rel="bookmark">
<span>On rules versus hooks, or, abstraction shock</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Fri, 09/21/2012 - 19:47
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>I need to add a bit of business logic to my Commerce site: a boolean field on product nodes marks that the corresponding products can't be delivered outside the UK.</p>
<p>And I know the way to do this in Commerce is to create a rule: react to the cart completing checkout, iterate over line items, check the corresponding products, and block the completion if the field in question is set.</p>
<p>Rules is great: with Rules, site builders can change site functionality and cause it to react to events. When non-techy people ask if my job involves designing websites, to put them right I say, 'I make websites go "bing!"'; and now, site builders can make them go 'bing!' too.</p>
<p>But I have a confession: I'm reluctant about using Rules. It's partly that I find the UI confusing, and it feels time-consuming to test them, but deeper than that I think it's just that I feel too far removed from the actual thing I'm trying to make.</p>
<p>And that makes me wonder: am I becoming a Drupal dinosaur?</p>
<p>Because I can imagine when Views first came along, developers who were used to writing their own query and formatting the result themselves, looking at the Views UI and thinking 'I don't feel in control of my lists of stuff any more'.</p>
<p>Or before CCK, developers wrote exactly the form elements they needed in the node form and saved it themselves in the database. I still sometimes speak to non-Drupal developers who want to be able to dump data into the node table directly (or pull it out) and when I tell them they can't, because the data that actually makes a node is spread out over the node table, the node_revision table, and then a multitude of field tables. And their feeling of disconnection at not being able to get their hands on 'the node' as a solid lump of database stuff must surely be akin to what I feel with Rules. And I'm going to call this feeling 'abstraction shock'.</p>
<p>I want to write a hook. I want to write the code for it, for it to feel like a solid thing. I know that my rule can (indeed, should) be exported to code, but I want code that I can read and see exactly what it says, rather than code that Rules will consume and understand. And most of all, I want to be able to put in debug statements to understand what I'm getting as I write it, and after I've written it when it's going wrong or when the site functionality has to change. </p>
<p>If that makes me a dinosaur, save me a seat next to the brontosaurus.</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/50" hreflang="en">rules</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/6" hreflang="en">drupal planet</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/41" hreflang="en">drupal commerce</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/git-tricks-repatching-issue-branch" rel="bookmark">
<span>Git tricks: repatching for an issue branch</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Tue, 07/10/2012 - 19:20
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>My workflow for making patches is to use a feature branch for a single issue. Whether you're a contributor or a maintainer it lets you advance the fixing of the problem in small increments, and safely experiment knowing you can roll back.</p>
<p>But where it goes wrong is when your patch is superseded by a newer one in the issue queue, and you want to work on it some more. How do you update your branch for the ongoing work? As ever, with git there's a way.</p>
<p>Let's start with the basics first: you're making a feature branch to work on an issue. I tend to follow the naming pattern '123456-fix-all-the-bugs', but for this example I'll call it 'issue'.</p>
<div class="codeblock"><code>// Make a new branch and switch to it.<br>$ git co -b issue<br>// Make lots of commits.<br>// Ready to make a patch:<br>$ git diff &gt; 123456.project.issue.patch</code></div>
<p>(Note that if you can make your patch to show all your commits one by one, which can sometimes aid in making it clear what you're changing, but that's for another day.)</p>
<p>You've now got a patch which you're uploading to the issue queue, and your tree looks something like this:</p>
<div class="codeblock"><code> * [issue] Last commit, ready to roll a patch!<br> * Fixed the foobar.<br> * Added a bizbax.<br>/<br>* [master]</code></div>
<p>Now someone else comes along to the issue queue, reviews your patch, and posts a new patch of their own. You in turn look at patch 2, and while it's an improvement, you think it needs still more work.</p>
<p>The problem is how to apply the patch to your repository. It won't apply to the tip of the issue branch, and if you checkout master, you can't get back to your issue branch. You can of course just discard your original issue branch, and create a branch issue2 for patch 2.</p>
<p>Or you can do this:</p>
<div class="codeblock"><code>// Start on the issue branch.<br>// Stash any work in progress!<br>$ git stash<br>// Checkout just the *files* of master, while keeping the HEAD pointer on the<br>// issue branch.<br>$ git checkout master -- .<br>// This puts the files from master into the working tree, but keeps the index<br>// on the issue branch. In simpler terms, the reverse of patch 1 will appear<br>// staged (as git believes that your files *ought* to look like patch 1, but<br>// actually look like master). <br>// We want the index clean, so unstage everything:<br>$ git reset HEAD .<br>// Now apply the new patch.<br>$ patch -p1 &lt; patch-2.patch<br>// Now commit this as patch 2.<br>// Remember to stash pop when you're done!</code></div>
<p>Because the working tree files (that is, the actual files on your system) look like the master branch, the patch applies cleanly. But because git still believes its on the tip of the issue branch, the commit you make goes on the tip of that branch, and the diff it records is effectively the interdiff between your patch-1 and the other contributor's patch-2. Your tree looks like this:</p>
<div class="codeblock"><code> * [issue] Applied patch 2 from Ada Lovelace.<br> * Last commit, ready to roll a patch!<br> * Fixed the foobar.<br> * Added a bizbax.<br>/<br>* [master]</code></div>
<p>Result: you can now do more work on this branch, and make more commits, and when you're ready, diff against master to make patch-3, ready to upload to the issue queue.</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/6" hreflang="en">drupal planet</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/46" hreflang="en">git</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/48" hreflang="en">issue queue</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/49" hreflang="en">patching</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/1" hreflang="en">drupal</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/git-tricks-being-wrong-branch" rel="bookmark">
<span>Git tricks: being on the wrong branch</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Fri, 07/06/2012 - 08:30
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>I often find that I'm in the middle of one thing when I have to do another. Whether it's hotfixes for a client, or just finding a minor bug that blocks my current work, or needing to add components to a feature before I can add custom functionality.</p>
<p>The best way is to stash your current work, checkout the master branch, commit, then go back. If you're working on a feature branch (and you should be), then rebase that afterwards so you have access to the new work there. So that's:</p>
<div class="codeblock"><code>$ git stash<br>$ git checkout master<br>// do commits<br>$ git checkout feature<br>$ git rebase master<br>$ git stash pop</code></div>
<p>But that's not always feasible. Sometimes I'm sloppy, and I've already made code changes before stashing. And lately, I've got one instance of <a href="http://drupal.org/project/party">Party module</a> that's got a feature branch that's made database changes, but I don't want to hold that up ongoing commits (and I'm too lazy to set up a new local site!).</p>
<p>If your fix is just one commit, you can make it on the feature branch, then cherrypick it to the master branch like this:</p>
<div class="codeblock"><code>// make your commit and note its SHA<br>$ git stash<br>$ git checkout master<br>$ git cherry-pick COMMIT<br>$ git checkout feature<br>$ git rebase master</code></div>
<p>The rebase should be smart enough to figure out the same commit exists on both branches, and will silently drop it from the feature branch.</p>
<p>Alternatively, if you want to do a chunk of main branch work, make a temporary branch on the tip of feature, which you can then move to the master branch when you're done:</p>
<div class="codeblock"><code>$ git checkout -b moveme<br>// make as many commits as you like<br>// Now we take everything that's between the tips of feature and moveme, and move it to the tip of master<br>$ git rebase --onto master feature moveme<br>// Now merge moveme into master: this'll just fast-foward master.<br>$ git checkout master<br>$ git merge moveme<br>// moveme can be deleted now<br>$ git branch -d moveme<br>// Now rebase the feature branch<br>$ git checkout feature<br>$ git rebase master</code></div>
<p>As I've become more familiar with git, I've found that temporary, throw-away branches can be useful in a variety of situations. Another one is making a backup branch prior to potentially messy rebases: just create a branch 'backup' where you are to be sure that no matter what happens with the rebase, your current chain of commits will be preserved. If there are conflicts, you can diff against it to check no code was lost. And when you're happy with the result of the rebase, just delete it. Branches being cheap, and local, opens up a whole new set of uses for them.</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/6" hreflang="en">drupal planet</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/46" hreflang="en">git</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/get-out-git" rel="bookmark">
<span>Get out, git!</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Thu, 05/03/2012 - 07:41
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>There are lots of good reasons to have your server's codebase be an actual git checkout. But there's one potential flaw: your entire repository's history ends up in your webroot inside a .git folder.</p>
<p>You can block access to it in your .htaccess, but that's hacking core (until <a href="http://drupal.org/node/581706">this patch</a> lands at least).</p>
<p>There is however an alternative method that lets you keep the entirety of git's working folder outside the webroot completely.</p>
<p>Here's how to convert an existing repository to this format:</p>
<ol>
<li> Move the .git folder to another location, renaming it in the process so it's no longer hidden. The convention is to leave it with a .git ending though, so for example, 'mysite.git'. I put these inside a folder called 'git' in the user's home folder, for instance.<br>
<div class="codeblock"><code>$ mv .git ~/git/mysite.git</code></div>
</li>
<li>In its original place in your webroot, create a new file called '.git'. Into this file place a single line thus:<br>
<div class="codeblock"><code>gitdir: /absolute/path/to/your/mysite.git</code></div>
<p>This needs to be an absolute path; relative ones confuse git when you go into subfolders. Using '~' to start at the user's home folder doesn't seem to work either.</p>
</li>
<li> Finally, we need to tell the config file where the work folder is. This step isn't completely necessary, but it allows you to invoke the git command while standing in subfolders of your webroot, which is too handy a thing to lose.
<p>Standing either in the webroot or in the git folder, do:</p>
<div class="codeblock"><code>$ git config core.worktree "/absolute/path/to/your/webroot"</code></div>
<p>You can also edit the git config file by hand to set this, which allows you to also add a comment explaining the manoeuvre for future reference.
</p></li>
</ol>
<p>That's all there is to it. You now have a working git repository whose working folder is completely inaccessible from the outside world.</p>
<p>For creating a new repo, you can use the following finger-twister:</p>
<div class="codeblock"><code>$ git --git-dir=/path/to/repo.git --work-tree=. init &amp;&amp; echo "gitdir: /path/to/repo.git" &gt; .git</code></div>
<p>There are more tips in <a href="http://stackoverflow.com/questions/505467/can-i-store-the-git-folder-outside-the-files-i-want-tracked">this question on StackOverflow</a>. And for a hands-on tutorial, come to my session on git at <a href="http://camp.drupalscotland.org/">DrupalCamp Scotland</a>, taking place later this month in Edinburgh.</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/46" hreflang="en">git</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/6" hreflang="en">drupal planet</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/47" hreflang="en">security</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/moving-git-local-branch-one-local-another" rel="bookmark">
<span>Moving a git local branch from one local to another</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Fri, 02/24/2012 - 10:32
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>You're maybe at one of the many Drupal Co-worker Friday events that are taking place around the world today. You've packed up your laptop and your lunchbox, and you're looking forward to a day out of the house with some human contact.</p>
<p>But yesterday you were halfway through a big piece of work on your project. And you were using a git local branch, of course. Why? Because it keeps your work isolated off the main development branch, allowing other work to continue independently. And because while your commits are only local you're free to reorder them, edit the log messages, fixup mistakes as if they never happened, and so on. In fact, if you so choose, merging your local branch in with the --squash option makes it look like you made all of the work in a single, perfect commit. Wow!</p>
<p>But that branch is on your desktop machine, and today you're on the laptop. How to get it over from one to the other? You don't want to push it to the remote, because then that means you can't rework it, and it doesn't really belong there anyway. You could make one big patch of your branch against the development branch, but then on your laptop you won't have the dozen or so commits you made yesterday (and you work with small, simple commits, because it makes it easier to roll back should you need to, and to see what's been changed). Furthermore, you've a bunch of changes that aren't yet committed because they're work in progress. You need those too, but not mixed in with what's already committed and reasonably stable.</p>
<p>The solution is the git format-patch command. At first try this is a rather weird one, which fills your folder up with cryptic mailbox files (which as far as I can tell are nigh on useless in the modern world of webmail). But it has an option which turns it into something very useful indeed: --stout. So much so that I've added it to my git global config thus:</p>
<div class="codeblock"><code>&nbsp; fp&nbsp; = format-patch --stdout</code></div>
<p>So standing in your repository and doing </p>
<div class="codeblock"><code>&nbsp; git fp the-dev-branch &gt; my-local-branch.patch</code></div>
<p>will give you one single file that comprises multiple patches, one for each commit. Copy that to your laptop by your favourite means, and over there do:</p>
<div class="codeblock"><code>&nbsp; git co -b my-local-branch<br>&nbsp; git am&nbsp; my-local-branch.patch</code></div>
<p>And all your commits from your desktop machine are reproduced on your laptop.</p>
<p>But what about your work in progress? I was coming to that. Before you begin, make one commit of all of them, perhaps with a log message to remind you it's the work in progress.</p>
<p>Then after you've done 'git am', all we have to do is kill off that final tip commit, while keeping the changes it contains in the filesystem. The command for that is git reset with the --mixed option:</p>
<div class="codeblock"><code>&nbsp; git reset --mixed HEAD^</code></div>
<p>All your work in progress changes are now 'unstaged changes', and your laptop's copy of the repository is in exactly the same stage as your desktop machine.</p>
<p>What about going back the other way? Well I'll figure that one out tonight, I expect ;)</p>
<p>PS. The return trip is easily done thus:</p>
<p>When you create the branch on the new machine, but before you apply the patch, add a tag: git tag mytag. Then at the end of the day, do the original process in reverse but take your diff from the tab: git fp mytag &gt; homeward.patch</p>
<p>And on your home machine, remember to kill the 'work in progress' commit before you apply the patch, with 'git reset --hard HEAD^'. That's a hard reset this time, since the changes in that commit are in the new commits you're bringing back.</p>
<p>Hope your Drupal Coworker Friday was as productive as mine!</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/1" hreflang="en">drupal</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/6" hreflang="en">drupal planet</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/46" hreflang="en">git</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/concept-limiting-taxonomy-terms-common-fields" rel="bookmark">
<span>A concept for limiting taxonomy terms by common fields</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Wed, 11/23/2011 - 13:20
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>There are several modules that provide taxonomy term widgets that are more efficient at drilling down into large and complex vocabularies of terms, but I've not yet found something that just limits terms in some way.</p>
<p>The use case is somewhat like this: I have products that are classified by sport and by team. And teams can be rugby teams or football teams, and so on. Having one vocabulary per type of team feels somewhat weak, but putting them all in one vocabulary means the user has to wade through a lot of irrelevant terms.</p>
<p>So I've been thinking of ways to limit the terms in the field widget. I don't think this is something I'm going to develop (for reasons that will become clear), but it's just a wacky idea[*] I'm putting out there.</p>
<p>I've discarded my initial thought to use a hierarchy of terms, because that would result in terms that are essentially empty: the group of football team terms is not correctly a team term. It would also mean needing to prevent its selection in the widget, and its appearance in filter forms.</p>
<p>What I've landed on as a concept instead seems wacky but I think makes a lot of sense: now we can have fields on anything, we can <em>match them</em>. What I mean by this is that we compare the value in the 'sport' field on the product, and the value in the <em>identical sport field</em> applied to the terms. (Yes, taxonomy terms on taxonomy terms. It was bound to happen eventually, right?)</p>
<p>In terms of IA, this is actually quite simple and logical: add a term reference field to the team vocabulary, and add the sport field, which is already on products, to the team terms (which the client will be doing; I have no idea what teams belong to what sport).</p>
<p>In terms of the work the UI has to do, it's not that complex either once it's laid out. It goes like this: when the value in the sport field changes, make an ajax call on the team field. In the callback, load all the terms. For each term, look at its team value. Does that match the current value of the sport field in the product form? If so, let the term into the new options array. If not, discard it.</p>
<p>It's simple, but I've hit a problem: we have two really good JavaScript systems in Drupal 7 that work very well individually, but as far as I can tell live in completely different universes. The states system is great for telling one form element to show, hide, or change its value depending on the value of another element. The ajax system is great for telling one form element to react to a change in itself by updating something via ajax. What I don't see how to do is get the term reference widget element to watch for changes in other elements (like the states system does), and then update itself with ajax (using the ajax system ideally).</p>
<p>So that's where I've hit the buffers: my JavaScript skills are pretty minimal, and so that's where I leave this latest wacky idea for now. I've got proof-of-concept code of a term reference widget updating itself via ajax based on form values, but the missing piece is getting it to react to changes in another field, whose form elements can't be altered in PHP (because the term reference widget is being changed in hook_field_widget_form_alter(), which only sees that form element). I'd be grateful for any hints; I actually think this model is not as wacky as it first seems and could have a lot of applications.</p>
<p>[*] Back at DrupalCon London I chanced upon a conversation webchick and stella were having about Coder review automation on Drupal.org, and prefixed a suggestion with, 'I've got a wacky idea...', to which webchick said, 'When are your ideas not wacky?' I don't know whether it was just an off the cuff quip, or whether I really do come up with a lot of crazy stuff. I guess I can live with that reputation ;)</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/1" hreflang="en">drupal</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/6" hreflang="en">drupal planet</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/43" hreflang="en">taxonomy</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/44" hreflang="en">javascript</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/45" hreflang="en">ajax</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/dynamically-changing-views-table-joins" rel="bookmark">
<span>Dynamically changing Views table joins</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Fri, 10/28/2011 - 08:52
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>I've recently had cause to make Views make joins to tables in peculiar ways. Here's some notes on the peculiar things I did with the views_join class to accomplish that.</p>
<p>First of all I'll briefly recap how we define a table to Views. Each item in the $data array returned to hook_view_data() represents all the information about a table. Each key in the array is a field on that table (well, or pseudofield), except for the 'table' key which has the basic data about our table, like this:</p>
<div class="codeblock"><code>$data['my_table'] = array(<br>&nbsp; // This defines how the table joins back to different bases.<br>&nbsp; 'table' =&gt; array(<br>&nbsp;&nbsp;&nbsp; // How to join back to the base table 'crm_party'.<br>&nbsp;&nbsp;&nbsp; 'crm_party' =&gt; array(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'left_field' =&gt; 'pid',<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'field' =&gt; 'pid',<br>&nbsp;&nbsp;&nbsp; ),<br>&nbsp; ),<br>);<br>// Now we can add field definitions on this table.</code></div>
<p>That's the simplest case. It says, 'to join back to {crm_party}, join on the column 'pid' on both tables'. (Note I will say 'column' when I am speaking of the database, and 'field' for Views, though that can mean both a field that you add to the view, and a field on the table that provides filters, sorts, or arguments.)</p>
<p>So adding a field on this table will cause Views to add this join clause to the query:</p>
<p> ... JOIN my_table ON crm_party.pid = my_table.pid</p>
<p>We can easily join where the columns have different names, by giving different values for 'field' and 'left_field' in the table definition.</p>
<p>If the join requires conditions, that's where the 'extra' clause comes in, like this:</p>
<div class="codeblock"><code>// How to join back to the base table 'crm_party'.<br>'crm_party' =&gt; array(<br>&nbsp; 'left_field' =&gt; 'pid',<br>&nbsp; 'field' =&gt; 'pid',<br>&nbsp; 'extra' =&gt; 'foo = 42',<br>),</code></div>
<p>This now gives us:</p>
<p>... JOIN my_table ON crm_party.pid = my_table.pid AND foo = 42</p>
<p>The 'extra' can also take an array, in which case each item is an array containing field, operator, and value. (If it seems a bit like the <a href="http://drupal.org/developing/api/database">Database API</a>, but not quite, that's because all this was introduced in Views 2 on Drupal 6).</p>
<div class="codeblock"><code>// How to join back to the base table 'crm_party'.<br>'crm_party' =&gt; array(<br>&nbsp; 'left_field' =&gt; 'pid',<br>&nbsp; 'field' =&gt; 'pid',<br>&nbsp; 'extra' =&gt; array(<br>&nbsp;&nbsp;&nbsp; // The 'extra' array is numeric, hence has no keys. This always looks odd to me!<br>&nbsp;&nbsp;&nbsp; array(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'field' =&gt; 'foo',<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'value' =&gt; 42,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'numeric' =&gt; TRUE,<br>&nbsp;&nbsp;&nbsp; ),<br>&nbsp; ),<br>),</code></div>
<p>So far, this is all covered in the Advanced Help documentation contained within Views. But for our relationship handler from <a href="http://drupal.org/sandbox/joachim/1260650">CRM Parties</a> to attached entities, we needed a condition on the join depending on values selected in the UI. So the 'extra', defined in hook_views_alter(), won't do, as it's not changeable. Or is it?</p>
<p>When a relationship handler is adding itself to the query, the query hasn't been fully built yet. Rather, Views has a views_plugin_query_default object which will eventually be used to make a DatabaseAPI SelectQuery. This means we can actually reach into the table queue and change the definition for any table to the left of us, like this:</p>
<div class="codeblock"><code>// Our relationship handler's query method:<br>function query() {<br>&nbsp; // Call our parent query method to set up all our tables and joins.<br>&nbsp; parent::query();<br><br>&nbsp; if ($this-&gt;options['main']) {<br>&nbsp;&nbsp;&nbsp; // This is a little weird.<br>&nbsp;&nbsp;&nbsp; // We don't add an 'extra' (ie a further join condition) on our<br>&nbsp;&nbsp;&nbsp; // relationship join, but rather on the join that got us here from<br>&nbsp;&nbsp;&nbsp; // the {crm_party} table.<br>&nbsp;&nbsp;&nbsp; // This means reaching into the query object's table queue and fiddling<br>&nbsp;&nbsp;&nbsp; // with the join object.<br>&nbsp;&nbsp;&nbsp; // Setting a join handler for the join definition is not useful, as that<br>&nbsp;&nbsp;&nbsp; // would have no knowledge of the user option set in this relationship<br>&nbsp;&nbsp;&nbsp; // handler.<br>&nbsp;&nbsp;&nbsp; // @todo: It might however be cleaner to set one anyway and give it<br>&nbsp;&nbsp;&nbsp; // a method to add the extra rather than hack the object directly...<br>&nbsp;&nbsp;&nbsp; $table = $this-&gt;table;<br>&nbsp;&nbsp;&nbsp; $base_join = $this-&gt;query-&gt;table_queue[$table]['join'];<br>&nbsp;&nbsp;&nbsp; $base_join-&gt;extra = array(array('field' =&gt; 'main', 'value' =&gt; TRUE));<br>&nbsp; }</code></div>
<p>When I wrote those comments in the code last week, I'd found that using a custom join handler isn't useful, because that has no knowledge of the relationship handler's data. However, this week I found myself working on a different case where I did need to find a way to do just that.</p>
<p>This week's problem was <a href="http://drupal.org/node/1318358">how to filter out Drupal Commerce products that are in the current cart</a>, or more generally in any order (and the current cart's order ID can be supplied with a default argument plugin).</p>
<p>It seems a reasonable enough thing to ask of Views, but it's actually pretty complex, as what's in a cart or order is not products but line items, each of which refers to a product with a reference field.</p>
<p>After several failed attempts, I managed to write a query that produces the correct result, but it requires joining to a subquery which itself has the order ID within it (see the issue for gory details).</p>
<p>The first hurdle with this is easy to overcome: there's nothing wrong about telling Views about a table that doesn't exist. This is often done with aliased tables, but in fact it can be totally fictional provided we also provide our own join handler which understands what to do to the query. That can be anything, as long as the SELECT fields we also add make sense. Hence it's fine to do this in hook_views_data():</p>
<div class="codeblock"><code>// Fake table for the 'product is in order' argument, made from a subquery.<br>$data['commerce_product_commerce_line_item'] = array(<br>&nbsp; 'table' =&gt; array(<br>&nbsp;&nbsp;&nbsp; 'group' =&gt; 'Commerce Product',<br>&nbsp;&nbsp;&nbsp; 'join' =&gt; array(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Join to the commerce_product base.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'commerce_product' =&gt; array(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'left_field' =&gt; 'entity_id',<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'field' =&gt; 'line_item_id',<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'handler' =&gt; 'views_join_commerce_product_line_item',<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ),<br>&nbsp;&nbsp;&nbsp; ),<br>&nbsp; ),<br>);</code></div>
<p>Our custom join class now has to add the subquery to the view, but it also needs the argument value to do this.</p>
<p>The way I worked around this was to override the ensure_my_table() method in the argument handler. Normally, this calls $this-&gt;query-&gt;ensure_table() which then creates the join, but ensure_table() can take a join parameter to work with. The overridden version of ensure_my_table() creates the join object, and sets the argument value on it:</p>
<div class="codeblock"><code>function ensure_my_table() {<br>&nbsp; // Pre-empt views_plugin_query_default::ensure_table() by setting our join up now.<br>&nbsp; // Argh, hack this in for now. This may mean relationships using this break?<br>&nbsp; $relationship = 'commerce_product';<br><br>&nbsp; // Get a join object for our table.<br>&nbsp; // This is of class views_join_commerce_product_line_item, which takes<br>&nbsp; // care of joining to a subquery rather than a table.<br>&nbsp; $join = $this-&gt;query-&gt;get_join_data($this-&gt;table, $this-&gt;query-&gt;relationships[$relationship]['base']);<br><br>&nbsp; // We add the argument value to the join handler as it needs to use it<br>&nbsp; // within its subquery.<br>&nbsp; $join-&gt;argument = $this-&gt;argument;</code></div>
<p>This means that in the build_join() method for our custom join handler, views_join_commerce_product_line_item, we can rely on the argument value that the views has received:</p>
<div class="codeblock"><code>function build_join($select_query, $table, $view_query) {<br>&nbsp; // (snip...) build a SelectQuery object for the subquery<br>&nbsp; // Set the condition based on the argument value.<br>&nbsp; $subquery-&gt;condition('cli.order_id', $this-&gt;argument);<br>&nbsp; // (snip...)<br>&nbsp; // Add the join on the subquery.<br>&nbsp; $select_query-&gt;addJoin($this-&gt;type, $subquery, $table['alias'], $condition);</code></div>
<p>The views_join class's build_join() method is where the Views system of building a query is translated into a DatabaseAPI SelectQuery object. Here we build up our own query (and we don't need Views-safe aliases, as it's a completely internal, non-correlated subquery), and pass it in as a join which uses it as a subquery.</p>
<p>It remains only for the argument handler's query() method to add the conditions for its field, using the alias and field names we gave for the subquery.</p>
<p>In conclusion, the data structure Views understands may appear to be a fixed, declared thing, but with a little bit of tweaking the way tables are joined in a Views query can be affected by both site configuration and user input.</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/1" hreflang="en">drupal</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/40" hreflang="en">views</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/41" hreflang="en">drupal commerce</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/42" hreflang="en">drupal crm</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/6" hreflang="en">drupal planet</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/its-amazing-what-you-find-crusty-bits-menu-system/505" rel="bookmark">
<span>It&#039;s Amazing What You Find: Crusty Bits of the Menu System</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Sun, 10/17/2010 - 16:13
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>I've been poking in the innards of the menu system the last few days. This is due to yet another client wanting to do something that goes completely against the grain of Drupal.</p>
<p>In this case, it's the way Drupal only shows you menu links you have access to. This to me seems perfectly reasonable good usability: why show you something you can't use? On the other hand, there is a long-standing feature in Comment module that shows anonymous users a 'Login or register to post comments' link on nodes, so 'incitements to action' or <a href="http://whatthefuckismysocialmediastrategy.com/">whatever the social media buzzword is</a> do exist in Drupal.</p>
<p>So the challenge was to show a link that the anonymous user can't use, send them to login, and back to the link they wanted in the first place. The last part is just some hook_form_alter() work with form redirection (though it did allow me to discover that everything drupal_get_form() is passed <em>is</em> available to the alter hooks, just <a href="http://drupal.org/node/942718">in a funny place</a>). The access to the menu item is done by intercepting in hook_menu_item_alter() to save a twin of the menu item, and a checkbox in the menu edit form to trigger this. Even registering the path is easy: a custom menu access callback which takes as access arguments those of the original item <em>plus its access callback</em> and negates whatever the original item would return for access. The part I'm (so far) stuck on is getting hook_menu_alter() to know about what the admin user has done in hook_menu_item_alter(): the next job will probably involve creating a truly ugly query that uses %LIKE% to grab menu items based on their options array.</p>
<p>But that's not what I came here to tell you about today.</p>
<p>In my prodding around of the menu system, I found that menu router items have a 'block_callback' property, with its own database field and everything. Now get this: only <em>one</em> item in the entire {menu_router} table on D6 has this filled, and to boot, it has <em>absolutely no effect</em>. (It's the admin theme page, by the way.) This property is something to do with the way that the root admin page is made out of things that are sort of blocks, but not quite. If the property exists on the router item, then the callback is called to add (!!) to the content. (The admin theme page of course plays no part in the root admin page.)</p>
<p>So we had here a completely useless database field, probably left over from Drupal 5 or even earlier. By the way, in a standard Drupal 7 install, the database field is <em>completely</em> unused. I made a dummy patch to get the issue queue testbot confirm that <a href="http://drupal.org/node/943558">we never get to this particular piece of code</a>, and the superfluous field has now been removed. It's amazing what you find!</p>
<p>By the way, if anyone fancies some bikeshedding, I still don't have a name better than 'menu_login' for this module. To your paintbrushes!</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/1" hreflang="en">drupal</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/6" hreflang="en">drupal planet</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/38" hreflang="en">drupal 7</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/39" hreflang="en">menu system</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/oxford-comma/503" rel="bookmark">
<span>The Oxford Comma</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Wed, 06/30/2010 - 15:59
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>Here's a little function I wrote today because I needed to be able to turn a list of between one and three items into a string like 'apples, oranges, and pears', 'apples and pears', or just '<a href="http://en.wikipedia.org/wiki/Rhyming_slang">stairs</a>'.</p>
<p>I figured I might as well handle everything in one place, and throw in the option to have an 'or' instead of an 'and'. There may be occasions you don't want the <a href="http://en.wikipedia.org/wiki/Oxford_comma">Oxford comma</a>, but I can't think of any.</p>
<div class="codeblock"><code>/**<br> * Grammatically fun helper to make a list of things in a sentence, ie<br> * turn an array into a string 'a, b, and c'.<br> *<br> * @param $list<br> *&nbsp; An array of words or items to join.<br> * @param $type<br> *&nbsp; The text to use between the last two items. Defaults to 'and'.<br> * @param $oxford<br> *&nbsp; Change this from default and you are a philistine.<br> */<br>function oxford_comma_list($list, $type = 'and', $oxford = TRUE) {<br>&nbsp; $final_join = " $type ";<br>&nbsp; if ($oxford &amp;&amp; count($list) &gt; 2) {<br>&nbsp;&nbsp;&nbsp; $final_join = ',' . $final_join;<br>&nbsp; }<br>&nbsp; $final = array_splice($list, -2, 2);&nbsp; <br>&nbsp; $final_string = implode($final_join, $final);<br>&nbsp; array_push($list, $final_string);<br>&nbsp; return implode(', ', $list);<br>}</code></div>
<p>Now the real question: how would you make this translatable?</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/1" hreflang="en">drupal</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/35" hreflang="en">php</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/36" hreflang="en">theming</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/6" hreflang="en">drupal planet</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/37" hreflang="en">text</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/using-constants-permission-names-why/502" rel="bookmark">
<span>Using Constants For Permission Names: WHY?</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Wed, 06/30/2010 - 14:19
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>I keep seeing this sort of thing in so many modules:</p>
<div class="codeblock"><code>define("MY_MODULE_PERM_ACCESS_WIDGETS", 'access widgets');<br>// Names changed to protect the guilty ;)</code></div>
<p>Am I missing something, or is this utterly pointless?</p>
<p>The only advantage I see is that you can change the permission string later on. But you actually can't change a permission string once you've made a release without an almighty amount of work in a <a href="http://api.drupal.org/api/function/hook_update_N/6">hook_update_N()</a>[*] to migrate users' existing permissions, so what is the point of using a constant apart from just creating shouty caps noise?</p>
<p>[*] Is there a helper function in core yet for migrating permission names during updates? There really should be.</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/1" hreflang="en">drupal</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/11" hreflang="en">code style</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/6" hreflang="en">drupal planet</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/19" hreflang="en">wtf</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/once-only-once-conversion-drupal-7s-fieldapi/494" rel="bookmark">
<span>Once &amp; Only Once: The Conversion To Drupal 7&#039;s FieldAPI</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Tue, 04/06/2010 - 14:06
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>I'm not a fan of repeating myself, or of doing the same work twice. So when I first got a look at FieldAPI back at DrupalCon Paris, my thought after 'Wow this is going to change everything,' was 'Every module that converts its custom data storage to this is going to be doing the same work, over and over'.</p>
<p>It seemed to me that we have a lot of modules that add things to stuff. The examples that spring to mind include <a href="http://drupal.org/project/taxonomy_image">Taxonomy image</a> (add an image to a taxonomy term), <a href="http://drupal.org/project/comment_upload">Comment upload</a> (add an uploaded file to a comment), <a href="http://drupal.org/project/user_terms">User terms</a> (you get the picture), and the daddy of them all, <a href="http://drupal.org/project/image">Image</a> (which now we must call Image Oldskool, due to there being a shiny new Image module in Core).</p>
<p>What all these have in common is that on Drupal 7 their things-to-stuffness would be perfectly served by FieldAPI. Users get more flexibility, an expanding universe of formatters and widgets; module maintainers can write less code and in some cases even hang up their hats on a particular project as it can live entirely in configuration space. Everyone wins. But how to get there?</p>
<p>This matter has been bubbling at the back of my mind ever since Paris. On the one hand I could sort of see how this could be all done with a single framework: you tell it what sort of entity you are dealing with (node, comment, term), which bundle (article, page, which vocab), what your fields are, and how to load the old data. The framework creates the fields for you, then runs a batch to load each object, moves values around in clever ways that you don't need to worry about, and then saves the object. Banzai! Your data is now saved in a field.</p>
<p>On the other hand, this was clearly crack. Of the highest order. </p>
<p>And yet <a href="http://drupal.org/project/field_convert">it works</a>. It quite possibly still is crack, and some extra pairs of eyes to de-crackify it would be very welcome. But I can confirm that I've run data conversions on both User terms and oldskool Image nodes, and got term fields on my users and beautiful image fields on my nodes.</p>
<p>There remains some work to be done: I'd like to make conversion to file and image fields a bit more straightforward and create a nice way to specify how to populate the alt and title fields for images. And all this is largely academic and has only run on D7 databases with dummy D6 tables imported, since core's 6 to 7 upgrade process is not currently working. So I could use a hand. And if you have a things-to-stuff module, get in touch and give it a whirl.</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/1" hreflang="en">drupal</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/33" hreflang="en">module</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/25" hreflang="en">7.x</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/6" hreflang="en">drupal planet</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/34" hreflang="en">fieldapi</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/help-needed-using-jquery-show-passwords-you-type/489" rel="bookmark">
<span>Help needed: using jQuery to show passwords as you type</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Sun, 03/21/2010 - 20:57
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>Today I found <a href="http://www.alistapart.com/articles/the-problem-with-passwords/">an article about password usability</a>, which suggested that showing users what they type for their passwords is an improvement to usability.</p>
<p>You can try <a href="http://www.alistapart.com/d/the-problem-with-passwords/example-one-password-masking-toggle.html">a working demo</a>, which adds a 'show password' checkbox.</p>
<p>This had me wondering whether this is a feature we should consider having in Drupal.</p>
<p>I duly began writing a small module to do this, but I'm stuck on rewriting the Javascript from the article as well-formed Drupal-friendly jQuery. Now I can make jQuery do fancy things like expand things you click on and whizz things around, and my code so far replaces the password element with the new one, but making that new element itself clickable has me stumped: it's all a bit too meta.</p>
<p>I know when I'm beaten, so I'm blogging this to say: is there a jQuery whizz out there who would care to lend a hand? If so, please comment or email me, and let's make a new contrib module for this!</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/1" hreflang="en">drupal</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/7" hreflang="en">modules</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/6" hreflang="en">drupal planet</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/30" hreflang="en">help needed</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/31" hreflang="en">jquery</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/32" hreflang="en">usability</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/getting-stuff-done/485" rel="bookmark">
<span>Getting Stuff Done</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Tue, 02/16/2010 - 17:07
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><blockquote><p>Basically, an initial patch went in, we opened followup issues for cleanup, the followup issues never got followed up, so what's in HEAD is a bit of a mess.  catch, in a recent issue comment</p></blockquote>
<p>This happens far too often. I'm not linking to the specific issue in the Drupal 7 queue because I don't want to point fingers; this suffices to exemplify my point.</p>
<p>I wasn't anywhere near the <a href="http://en.wikiquote.org/wiki/John_Godfrey_Saxe">sausage factory</a> back when Drupal 6 was coming out, so I've no idea if this is a problem that's getting worse, but I feel this is a problem that happens a lot, and that it needs to happen a lot less.</p>
<p>I think that our move to distributed version control may help, as we can leave new developments on a branch until everything is cleaned up (and documented!), but as everyone knows, technological solutions are no substitute for good communication and organization. </p>
<p>Ultimately, we need people to take on the roles of roadmappers and project managers.</p>
<p>This is apparently a dirty word; there is a widespread notion that you can't organize volunteers. I can with confidence state that this is utter rubbish, because I've done it, and volunteer organizations around the world do it.</p>
<p>It's maybe harder because it's online rather than face to face (we do it fairly well at code sprints, after all), and maybe harder because we're mostly a bunch of fairly headstrong smart people who are used to managing our own activities (which is one of the things that <a href="http://c2.com/cgi/wiki?LazinessImpatienceHubris">makes us good programmers</a>). But we clearly recognize <a href="http://drupal.org/node/363367">the need to be organized on a smaller scale</a>, and the <a href="http://drupal.org/coding-standards">need to work with rules</a>. Managing Core is going to be a mammoth task,  of which we are right to be apprehensive, but is it so different to what we already do?</p>
<p>Regardless, it is necessary, and I think we are also of necessity often pragmatists. This is one occasion we need to recognize the need for some medicine that in some cases might not be entirely to our palate.</p>
<p>Spoonful of sugar anyone?</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/1" hreflang="en">drupal</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/17" hreflang="en">roadmap</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/6" hreflang="en">drupal planet</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/29" hreflang="en">project management</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/services-or-how-i-learned-were-all-just-secretly-hookmenu/484" rel="bookmark">
<span>Services, or How I Learned We&#039;re All Just Secretly hook_menu()</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Wed, 02/10/2010 - 23:02
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>I am now batting nodes, complete with imagefield, between separate instances of Drupal with merriment and glee. For yes, I do have a working beta of <a href="http://drupal.org/project/content_distribution">Content distribution</a>.</p>
<p>I'm about to quickly write a service to get CCK's content_fields() array from the remote, distributing site, so that the retrieving site can show a UI of possible values for a Views nodereference argument. Try it. It all makes sense once you do.</p>
<p>But I remember a couple of months ago, when <a href="http://drupal.org/project/services">Services</a> was a total mystery to me. I installed it, knowing that this was what I needed to achieve this task, but I was baffled by it. What <em>was</em> a Service? And how come I needed a server as well? Surely a service is a kind of server? Argh! And so on.</p>
<p>The penny dropped a few weeks ago, when I suddenly realized that a service is really just another kind of hook_menu() item.</p>
<p>Consider: in hook_menu(), you define which function Drupal should call when it gets an HTTP request at a certain path, say, 'node/1'. And in hook_service(), you define which function Drupal should call when it gets a service method request, in this case via <a href="http://en.wikipedia.org/wiki/XML-RPC">XMLRPC</a> (which is still black magic to me, but with Services module, I don't need to know, because it Just Works). For that matter, in Drush's hook_drush_command(), you define... etc etc. They are all the same!</p>
<p>This has me wondering whether for Drupal 8 we should abstract this out to a general hook_callback(), where we define what function Drupal should call when it receives any kind of external input.</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/1" hreflang="en">drupal</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/2" hreflang="en">6.x</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/24" hreflang="en">services</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/25" hreflang="en">7.x</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/6" hreflang="en">drupal planet</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/26" hreflang="en">content distribution</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/27" hreflang="en">abstraction</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/28" hreflang="en">8.x</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/why-writing-drupal-documentation-harder-writing-wikipedia/476" rel="bookmark">
<span>Why Is Writing Drupal Documentation Harder Than Writing Wikipedia?</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Thu, 01/28/2010 - 20:51
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>I used to write on Wikipedia, years ago when it was a wild frontier, we had barely 30 thousand articles, and not even my geek friends had heard of it from a source other than my blathering on about it.</p>
<p>It was quick and simple, deserving the origin of its name [1]. And it was quick not just to edit the content of pages, but their place in hierarchies and their order within lists. A whole section of the site that wasn't to our liking could be rejigged in a handful of browser tabs. Pages didn't belong to anyone, but the edit history and the attached talk pages gave you a clue of who was involved, and once you'd made edits to a page you could spot it in the Recent Changes list or your personal watchlist of bookmarks.</p>
<p>Now over to Drupal handbooks, where I find the process slow and laborious and confusing. I ask myself (and you!)  why?</p>
<p>We have Recent Changes of a sort: the tracker; we even have <a href="http://drupal.org/handbook/updates">a tracker just for documentation changes</a>, but I forget it exists because it's tucked down at the bottom of the site blocks. We have page revisions and diffs of pages, just like Wikipedia.</p>
<p>The differences I can see are:</p>
<p>1. HTML is slower. I know purists dislike wiki markup, but it's undeniably quicker to type ''italic'' and [[clean URLs]] than to muck around with opening and closing tags and finding the right URL. Granted, there is no one standard (though I would say that used at UseMod comes close) and Wikipedia has now bloated it so much with complex syntax to create all manner of things. But the handful of basic wiki syntax elements are good.</p>
<p>2. Structure is divorced from content. It's very handy the way Book module builds menus and trees for you. But it makes moving a page to another part of a book feel like a big destructive (and irreversible?) act. Furthermore, only a small number of admins can change the order of child pages, something which frequently makes all the difference between a clear read and a mess. On wiki, structure ''is'' content (italics, remember?): you want to make a list of child pages? You write a bullet list of page names. You want to move a page to a different part of the hierarchy? You just find what links to it and edit. Granted, this can often lead to an almighty tangled mess; not for nothing it is the full term a 'wiki-wiki-web'  not a tree.</p>
<p>3. Every article has an associated talk page. One day you find a section has all been changed and you're confused as to why? Find the answer in the talk page. You're pondering a big reorganization yourself, and you want to make sure other writers who are interested in this page get wind of it and have a chance to discuss it? The talk page. It's a bit more anarchic to what we're used to on drupal.org, but it keeps the discussion and the document side by side. I'm only an occasional participant in the documentation team, I'm not on the mailing list[2] and so I often find ''everything'' has been turned upside down and I can't fathom why, and I can't tell if it's work in progress that I should help with or just an almighty mess. Talk pages aren't perfect, and it's hard to follow discussions spread across many places, or even to know if you might be missing something. But there is an immediacy about the 'talk' tab at the top of a page.</p>
<p>4. Lastly, on Wikipedia it felt like there was a collective ownership of pages and sections. On drupal.org, I feel I'm treading on toes if I make too many changes. I don't know why that is; maybe we don't have the critical mass of documentation editors to turn into a community.</p>
<p>In conclusion: I don't have answers. I know that editing and more to the point, organizing our documentation is a big job, and I think the tools are not quite up to the job. As a first step, we should make book hierarchy editable by the documentation team. After that, start upon the inevitable debate about wiki syntax, and think about ways to better tie isues to the documentation pages they are about.</p>
<p>Footnotes:</p>
<p>[1] 'wiki' meaning 'quick' in Hawaiian, coined by Ward Cunningham for the original wiki.<br>
[2] I hate mailing lists. Don't get me started on them. The 1980s called: they want their communication technology back is all I'm going to say.</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/1" hreflang="en">drupal</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/6" hreflang="en">drupal planet</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/23" hreflang="en">documentation</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/files-arent-visible-all-domains-site/468" rel="bookmark">
<span>Files Aren&#039;t Visible From All Domains Of A Site</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Fri, 01/15/2010 - 14:37
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>I had a fun afternoon a few months back when all the imagecache images broke on a site I'd just taken live. I've just figured it out, so I'm telling you about it.</p>
<p>This was the situation: </p>
<ul>
<li>subsite.client.com was where I was developing the site, one of a family of multisites.</li>
<li>subsite.com was a parked domain that went to just this site. It was this I'd just pointed to the IP of the box and that wasn't showing any images.</li>
</ul>
<p>On the development domain, all worked fine. On the subsite domain, nothing.</p>
<p>The problem is that if you go to <em>admin/settings/file-system</em> you get a different thing depending on the domain! Each time, you get 'sites/CURRENT_DOMAIN/files', and the reason is <a href="http://api.drupal.org/api/function/file_directory_path/6">this function</a>:</p>
<div class="codeblock"><code>function file_directory_path() {<br>&nbsp; return variable_get('file_directory_path', conf_path() .'/files');<br>}</code></div>
<p>So if the files directory has not been explicitly set and you're just relying on defaults, you're getting the wrong one.</p>
<p>I don't follow the internal workings of the file system or imagecache (or even symlinks which I consider dark magic on the commandline) to know if this breaking of imagecache is a bug or not.</p>
<p>But at least this is a ten-second fix on future sites. You'll find me here reading this post when I next have to set one up.</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/1" hreflang="en">drupal</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/18" hreflang="en">5.x</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/2" hreflang="en">6.x</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/4" hreflang="en">multisite</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/6" hreflang="en">drupal planet</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/19" hreflang="en">wtf</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/20" hreflang="en">fix</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/21" hreflang="en">is this a bug?</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/22" hreflang="en">note to self</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/multisite-localhost-without-virtual-hosts/465" rel="bookmark">
<span>Multisite On localhost Without Virtual Hosts</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Thu, 12/03/2009 - 14:15
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>I've been putting off setting up multisite on my localhost for ages, mostly because in the past I've found getting Apache virtual hosts to work can be a bit tricky: not impossible, but the sort of thing where I could easily lose an hour on a minor thing I've forgotten to do. And after all, with a shiny new iMac and a hard drive whose proportions I can't even remember, why not just 'drush dl' all over again?</p>
<p>But I'm actually working on a multisite project at the moment, and suddenly getting this to work becomes more interesting than having another SVN copy of my code kicking around.</p>
<p>Given multisite can respond to subfolders, I was wondering if this could work when Drupal itself is in a subfolder, like this:</p>
<div class="codeblock"><code>- webroot<br>-- drupal-1<br>-- drupal-2<br>-- drupal-multisite</code></div>
<p>Turns out it can. Suppose you want a new subsite called 'drupal-subsite'. Here's what to do in your webroot:</p>
<div class="codeblock"><code>ln -s drupal-multisite drupal-subsite<br>cd drupal-multisite<br>mkdir sites/localhost.drupal-subsite<br>cp sites/default/default.settings.php sites/localhost.drupal-subsite/settings.php </code></div>
<p>Your lolcathost(*) sees just another subfolder that's a site; the symbolic link sends you to the existing Drupal folder; and finally, the multisite system sees that you're browsing 'localhost/drupal-subsite' and selects the localhost.drupal-subsite folder as the one holding your site.</p>
<p>You can also have your subsite explicitly sit below the main site like this:</p>
<div class="codeblock"><code>- webroot<br>-- drupal-1<br>-- drupal-2<br>-- drupal-multisite<br>--- drupal-subsite</code></div>
<p>In which case your sites folder is localhost.drupal-multisite.drupal-subsite and the symlink should be inside the multisite folder:</p>
<div class="codeblock"><code>cd drupal-multisite<br>ln -s . drupal-subsite<br>mkdir sites/localhost.drupal-multisite.drupal-subsite<br>cp sites/default/default.settings.php sites/localhost.drupal-multisite.drupal-subsite/settings.php </code></div>
<p>So when I next get a moment I'll consolidate the various test sites I have, and when I have more than one patch on the go that I want to keep segregated, I can just add a multisite, get a fresh CVS copy of the code, and get going.</p>
<p>I've added details to <a href="http://drupal.org/getting-started/6/install/multi-site">the documentation</a> too.</p>
<p>(*) yes, I keep typing it like that.</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/1" hreflang="en">drupal</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/2" hreflang="en">6.x</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/3" hreflang="en">development</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/4" hreflang="en">multisite</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/5" hreflang="en">localhost</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/6" hreflang="en">drupal planet</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/counting-hooks/462" rel="bookmark">
<span>Counting Hooks</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Tue, 11/17/2009 - 11:02
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>This (fairly long) one-liner counts the number of implementations of each hook in your Drupal installation:</p>
<div class="codeblock"><code>ack "Implements? hook_" | perl -e 'while (&lt;&gt;) { m[(hook_\w+)] and $hooks{$1}++; } foreach (keys %hooks) { print "$_ - $hooks{$_}\n"; }'</code></div>
<p>To count only install file hooks, which was what I was doing, give <a href="http://betterthangrep.com/">ack</a> the option "-G '.install'" thus:</p>
<div class="codeblock"><code>ack "Implements? hook_" -G '.install' | perl -e 'while (&lt;&gt;) { m[(hook_\w+)] and $hooks{$1}++; } foreach (keys %hooks) { print "$_ - $hooks{$_}\n"; }'</code></div>
<p>You can probably adapt this for grep. <a href="http://betterthangrep.com/">Ack</a> is far better though (proper regular expressions and sensible assumptions for starters).</p>
<p>Unfortunately, now I've taken ten minutes to do this, I've completely forgotten what I needed to count hooks for. So I'm posting this so by the time I remember I can come back to it!</p>
<p>Edit: Oh yes. I was generating a list of hooks implemented in .install files (just a list, the count is bonus) to check I'd covered everything in my <a href="http://drupal.org/node/633332">patch for hook locations in the documentation</a>.</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/1" hreflang="en">drupal</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/10" hreflang="en">perl</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/6" hreflang="en">drupal planet</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/six-reasons-get-handbook-page-your-module/460" rel="bookmark">
<span>Six Reasons To Get A Handbook Page For Your Module</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Fri, 11/06/2009 - 08:56
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>Checkout view being <a href="http://drupal.org/node/618720">currently disabled in ViewVC</a> is a very good opportunity to remind everyone that linking to your README.txt file in CVS does <em>not</em> count as documentation on your project page!</p>
<p>Here are some things I, or anyone else, can do with a proper documentation page in what used to be called the handbooks section of drupal.org:</p>
<ul>
<li> Correct it.</li>
<li> Expand on it.</li>
<li> Clarify things for newbies.</li>
<li> Add a section listing <a href="http://drupal.org/handbook/modules/image">modules that works with yours</a> that users might be interested to know about, thus helping a tiny tiny bit to make sense of the Big Lego Box.</li>
<li> Share some of the things I've done to <a href="http://drupal.org/node/387786">theme your module</a>.</li>
<li> Add to a section on troubleshooting, and hopefully keep some of the more recurring issues out of your queue (or at least give you somewhere to point to in slightly self-righteous manner ;)
</li>
</ul>
<p>In short, with a little bit of seeding (some basic explanations of the concepts of your module and some instructions), you open it up to a whole community of potential writers and editors. Which is a concept we should all be familiar with!</p>
<p>If you say that keeping a documentation book page in sync with your CVS readme file is too much of a hassle (and who said it should be in sync anyway?) then it's because you've not thought about the benefits.</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/1" hreflang="en">drupal</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/7" hreflang="en">modules</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/6" hreflang="en">drupal planet</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/nodes-nids/458" rel="bookmark">
<span>Nodes As NIDs</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Wed, 11/04/2009 - 15:41
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>Is it just me who finds this poor style and potentially confusing:</p>
<div class="codeblock">
<pre><code style="color: #000000"><span style="color: #0000BB">&lt;?php</span><span style="color: #007700">function </span><span style="color: #0000BB">my_function</span><span style="color: #007700">(</span><span style="color: #0000BB">$nodes</span><span style="color: #007700">) {  foreach (</span><span style="color: #0000BB">$nodes </span><span style="color: #007700">as </span><span style="color: #0000BB">$nid</span><span style="color: #007700">) {    </span><span style="color: #FF8000">// do stuff  </span><span style="color: #007700">}}</span><span style="color: #0000BB">?&gt;</span></code></pre></div>
<p>To me, a variable names $nodes will be an array of nodes -- that is, node objects. If it's an array of nids, I would call it $nids to avoid confusion about what we have there.</p>
<p>I'm curious if other people agree (in other words, is it worth my time writing a patch for core or will it just lead to bikeshedding?)</p>
<p>In general, though, I think it's a good idea for variables to be named in such a way that describes what they hold; also for the same data to have the same variable name as it travels through functions. In other words, avoid this:</p>
<div class="codeblock">
<pre><code style="color: #000000"><span style="color: #0000BB">&lt;?php</span><span style="color: #007700">function </span><span style="color: #0000BB">foo</span><span style="color: #007700">() {  </span><span style="color: #0000BB">bar</span><span style="color: #007700">(</span><span style="color: #0000BB">$ponies</span><span style="color: #007700">);}function </span><span style="color: #0000BB">bar</span><span style="color: #007700">(</span><span style="color: #0000BB">$caterpillars</span><span style="color: #007700">) {}</span><span style="color: #0000BB">?&gt;</span></code></pre></div>
<p>Unless there's a good reason, say if bar() is generic and can accept any animal. In which case, call its parameter <code>$animals</code>, obviously.</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/1" hreflang="en">drupal</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/11" hreflang="en">code style</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/6" hreflang="en">drupal planet</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/creating-set-fields-one-swell-foop/459" rel="bookmark">
<span>Creating A Set Of Fields In One Swell Foop</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Wed, 11/04/2009 - 15:19
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>Situation: you need a heap of imagefields that more or less have the same setup. Let's not go into why.</p>
<p>You could spend half an hour bored witless clicking through the interface. </p>
<p>Or you could create just the one field, export the content type with content copy, and then doctor the code a little before importing it back in. Like this....</p>
<div class="codeblock">
<pre><code style="color: #000000"><span style="color: #0000BB">&lt;?php</span><span style="color: #FF8000">// The usual content type stuff here.// Set of image fields</span><span style="color: #0000BB">$image_fields </span><span style="color: #007700">= array(  </span><span style="color: #DD0000">'field_image_1' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'Image 1'</span><span style="color: #007700">,  </span><span style="color: #DD0000">'field_image_2' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'Image 2'</span><span style="color: #007700">,  </span><span style="color: #FF8000">// etc</span><span style="color: #007700">);foreach (</span><span style="color: #0000BB">$image_fields </span><span style="color: #007700">as </span><span style="color: #0000BB">$name </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">$label</span><span style="color: #007700">) {  </span><span style="color: #0000BB">$content</span><span style="color: #007700">[</span><span style="color: #DD0000">'fields'</span><span style="color: #007700">][] = array (    </span><span style="color: #DD0000">'label' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">$label</span><span style="color: #007700">,    </span><span style="color: #DD0000">'field_name' </span><span style="color: #007700">=&gt; </span><span style="color: #0000BB">$name</span><span style="color: #007700">,    </span><span style="color: #DD0000">'type' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'filefield'</span><span style="color: #007700">,    </span><span style="color: #DD0000">'widget_type' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'imagefield_widget'</span><span style="color: #007700">,    </span><span style="color: #DD0000">'change' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'Change basic information'</span><span style="color: #007700">,    </span><span style="color: #DD0000">'weight' </span><span style="color: #007700">=&gt; </span><span style="color: #DD0000">'-3'</span><span style="color: #007700">,    </span><span style="color: #FF8000">// the rest of your field export code here    // don't forget to fix the brackets, as export code    // comes out as a numerically keyed array.    // and don't forget the closing }!</span><span style="color: #0000BB">?&gt;</span></code></pre></div>
<p>Hey presto, heap of fields created in one go. Don't forget to set their weights nicely afterwards.</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/1" hreflang="en">drupal</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/2" hreflang="en">6.x</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/12" hreflang="en">cck</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/6" hreflang="en">drupal planet</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/small-core-big-drupal-tighter-contrib-outer-core/453" rel="bookmark">
<span>Small Core, Big Drupal, Tighter Contrib: Outer Core?</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Sun, 10/18/2009 - 11:09
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>I've been mulling this idea since Paris, trying to figure out the best way to present it.</p>
<p>But basically:</p>
<p>We want a smaller, slimmer, efficient core.<br>
But we also want Drupal to, like, be useful.<br>
We want contrib, at least the high-use end of contrib, to be smoother, more organized, released on time with core.<br>
It's been suggested we have a contrib maintainer, who would have the unenviable task of managing a huge kaboodle.</p>
<p>So on the one hand we want to move things out of core, into contrib: things like poll, blog, even forum and profile. However, moving out to contrib is currently recognized as being a death sentence for the code itself, and dooming users to the curse of a million Lego bricks (to quote <a href="http://drupal.org/user/24967">webchick</a>).</p>
<p>On the other hand, we want better underpinning for the contrib modules that really make Drupal what it is: views, CCK (what's left of it out of core), panels, flag, voting, token, and so on.</p>
<p>These two things actually seem the same to me: define an Outer Core. This would be a fairly loose collection of modules, not simply the 40 most popular, but those that provide important functions, play well together. Outer Core would get a maintainer or two, to ensure good use of APIs, generalization and abstraction of common code where possible, no duplication of code or features, and plan releases.</p>
<p>Drupal the framework would be just the core.<br>
Drupal the product would be core + outer core. We'd release both simultaneously, available as a single download.</p>
<p>End result, I hope: we tame a sizable part of the Big Lego Brick Box.</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/1" hreflang="en">drupal</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/15" hreflang="en">thinking aloud</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/16" hreflang="en">core</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/17" hreflang="en">roadmap</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/6" hreflang="en">drupal planet</a></li>
      </ul>
</div>

  </div>
  </article>
</div>
    <div class="views-row">

<article class="node node--type-article grid-full node--view-mode-full">
  <header class="layout--content-narrow">
    
            <h2 class="node__title">
        <a href="/blog/never-write-line-code-again/436" rel="bookmark">
<span>Never Write A Line Of Code Again!</span>
</a>
      </h2>
        
          <div class="node__meta">
              <div class="node__author-image">
          <div>
  </div>

        </div>
              <span>
          By <span><span>joachim</span></span>, Tue, 08/18/2009 - 09:21
        </span>
        
      </div>
      </header>
  <div class="node__content layout--content-narrow">
        
            <div class="text-content clearfix field field--name-body field--type-text-with-summary field--label-hidden field__item"><p>Okay, so I lied. But <a href="http://drupal.org/project/module_builder">module builder</a> can save you a lot of time when writing custom modules.</p>
<p>And it now works with drush, too. I added support for drush a few weeks ago, which let you do things like "$ drush mb mymodule cron init menu nodeapi --write" and hey presto, a new module folder is created, with an info file and a module file, with hook implementations ready to do your (evil) bidding. (Note: this blog does not sanction use of Drupal, module builder, or drush for evil.)</p>
<p>If you're super lazy you can even say "$ drush mb mymodule cron init menu nodeapi --go", using the wash 'n' go option which writes all the files <em>and</em> enables the new module for you. But don't do this if you're writing an install or enable hook, as they won't have any code in them!</p>
<p>The downside was that you needed to install module builder into each Drupal installation you wanted to generate modules for. Bit of a pain if you're developing a few sites and have a few more test sites kicking around. </p>
<p>But no more! You can now stick the module builder folder wherever drush can find it, and build modules in any Drupal 6 installation. You can download hook data to that installation with "$drush mbdl", or store it in a central location by specifying the --data option.</p>
<p>You might say at this point, core hooks are all very good, but what about hooks for CCK, Views, Ubercart, and so on? Well, like all good modules, module builder comes with a hook. Implement hook_module_builder_info, tell it where you hook documentation can be found on the interwebs, and add your module's distinctiveness to module builder's sugary goodness.</p>
<p>And how might you do this?</p>
<div class="codeblock"><code>drush mb foo module_builder_info</code></div>
<p>With module builder, of course!</p>
</div>
      

<div class="field field--name-field-tags field--type-entity-reference field--label-above field--tags">
      <h3 class="field__label field--tags__label">Tags</h3>
    <ul class="links field__items field--tags__items">
          <li class="field--tags__item"><a href="/taxonomy/term/1" hreflang="en">drupal</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/2" hreflang="en">6.x</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/8" hreflang="en">module builder</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/3" hreflang="en">development</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/9" hreflang="en">drush</a></li>
          <li class="field--tags__item"><a href="/taxonomy/term/6" hreflang="en">drupal planet</a></li>
      </ul>
</div>

  </div>
  </article>
</div>

    </div>
  
          </div>
</div>

    </div>
  </div>

  </div>

              </main>
                        
          </div>
        </div>
        <div class="social-bar">
          
        </div>
      </div>
    </div>

    <footer class="site-footer">
      <div class="site-footer__inner container">
        

  <div class="region region--footer-top grid-full layout--pass--content-medium">
    <div class="region--footer_top__inner">
      

<div id="block-joachim-blog-theme-powered" class="block block-system block-system-powered-by-block">
  
    
    
  <span>
    Powered by    <a href="https://www.drupal.org">Drupal</a>
    <span class="drupal-logo" role="img" aria-label="Drupal Logo">
      <svg width="14" height="19" viewBox="0 0 42.15 55.08" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M29.75 11.73C25.87 7.86 22.18 4.16 21.08 0 20 4.16 16.28 7.86 12.4 11.73 6.59 17.54 0 24.12 0 34a21.08 21.08 0 1042.15 0c0-9.88-6.59-16.46-12.4-22.27zM10.84 35.92a14.13 14.13 0 00-1.65 2.62.54.54 0 01-.36.3h-.18c-.47 0-1-.92-1-.92-.14-.22-.27-.45-.4-.69l-.09-.19C5.94 34.25 7 30.28 7 30.28a17.42 17.42 0 012.52-5.41 31.53 31.53 0 012.28-3l1 1 4.72 4.82a.54.54 0 010 .72l-4.93 5.47zm10.48 13.81a7.29 7.29 0 01-5.4-12.14c1.54-1.83 3.42-3.63 5.46-6 2.42 2.58 4 4.35 5.55 6.29a3.08 3.08 0 01.32.48 7.15 7.15 0 011.3 4.12 7.23 7.23 0 01-7.23 7.25zM35 38.14a.84.84 0 01-.67.58h-.14a1.22 1.22 0 01-.68-.55 37.77 37.77 0 00-4.28-5.31l-1.93-2-6.41-6.65a54 54 0 01-3.84-3.94 1.3 1.3 0 00-.1-.15 3.84 3.84 0 01-.51-1v-.19a3.4 3.4 0 011-3c1.24-1.24 2.49-2.49 3.67-3.79 1.3 1.44 2.69 2.82 4.06 4.19a57.6 57.6 0 017.55 8.58A16 16 0 0135.65 34a14.55 14.55 0 01-.65 4.14z"/>
</svg>
    </span>
  </span>
</div>

    </div>
  </div>

        
      </div>
    </footer>

    <div class="overlay" data-drupal-selector="overlay"></div>

  </div>
</div>

  </div>

    
    <script type="application/json" data-drupal-selector="drupal-settings-json">{"path":{"baseUrl":"\/","pathPrefix":"","currentPath":"test-everything","currentPathIsAdmin":false,"isFront":false,"currentLanguage":"en"},"pluralDelimiter":"\u0003","suppressDeprecationErrors":true,"user":{"uid":0,"permissionsHash":"01dd47ecd9bcd15f4ce2dda67f9266a98e8b92ff7b9c64558fb5367373af7d61"}}</script>
<script src="/sites/default/files/js/js_8VAq5rHg72u4MA8hrGwHx9Lz8WNC8wFO7od1Rvg4xTA.js?scope=footer&amp;delta=0&amp;language=en&amp;theme=joachim_blog_theme&amp;include=eJxLzk9JTcvMKUkt0k-GM3Wy8hOTMzJz45Ny8tPjSzJSc1P103PykxJzdItLKnMy89IBYRsVxQ"></script>

  </body>
</html>
